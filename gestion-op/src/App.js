import React, { useState, useEffect } from 'react';
import Select from 'react-select';
import { db, auth } from './firebase';
import { 
  collection, 
  doc, 
  getDocs, 
  getDoc,
  setDoc, 
  addDoc, 
  updateDoc, 
  deleteDoc,
  query,
  where,
  orderBy,
  onSnapshot
} from 'firebase/firestore';
import { 
  signInWithEmailAndPassword, 
  signOut, 
  onAuthStateChanged 
} from 'firebase/auth';

// ==================== LOGOS POUR IMPRESSION ====================
const LOGO_PIF2 = 'data:image/png;base64,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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/2Q==';
const ARMOIRIE = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxMSEhUTEhIWFRUWGRcYGRcYFhgfFhoYGhsdFhgfGBoYHSghGxslIBsWITEhJSkrLi4wIB8zODMtNygtLisBCgoKDg0OGxAQGy0mICIrNTU3My0tLS0vOC0tLi0tNTI1MDUtLSstLzcvLS8wLS01LTAvLS8tLS0tLS0tLS8tLf/AABEIANkA6AMBIgACEQEDEQH/xAAcAAACAgMBAQAAAAAAAAAAAAAABgQFAgMHAQj/xABHEAACAQIEAwUEBgYIBgIDAAABAhEAAwQSITEFQVEGEyJhcTJCgZEUI1JyobEHM2JzgrNTkpOywdHS8BVDY6LC4VTxFiRE/8QAGgEAAgMBAQAAAAAAAAAAAAAAAAMCBAUBBv/EADERAAIBAgQCCQMFAQEAAAAAAAABAgMRBBIhMUFRBRMiMmFxkaHwgdHhFTOxwfEUQv/aAAwDAQACEQMRAD8A7jRRRQAUUUUAFFFFABRRRQAUUUUAFFQ8FjQ73bZ0e20EdVbxIR5Rp6g1MoA04XErcXMhkajzBGhBB1BHQ1upesX+7xV2PZZwD8l1Hxf5TTDUIVFO9uDsdasQ0xk32s/Ztq/9ZmH/AI1Mpdw7D/iDN1RkHwyH/wAXpirsZKSBowe6FKgmCxgeZgmPkCazpe4nie8v2gu1t1M9WnKY9ASP61MNcjNSbtwYNWCioDcRBxAw6iSELufsiQFHqZJ9BU+pnAooooAKKKKACiiigAooooAKKKKACiiigAoorwsOu9AHtFeKwMwdt/zr2gAorwmvaAIWI4ktt8jhlBEhyBkPXUGRGm4FTQag8ZshrTdV8Q+Gp+YkfGqzs9xL618M+66oeo5/mDHKSOVKdS1TI+KJW0ue8XPc4m3fGzLkboYOk+fiHy9avrdwMAymQRIPUGq3tHYDWSTshDH7vsv/ANpb8KidmMaSptOfEpK/xL7XwIhx5E9Kjny1cj47Ba8blJxrFOLhyAyHuEjmY25dFBp5VgQCNQdaW+LYM28R3i65xmA/bXRwPvLqPME1I4NxJMpCsGthC6Hoo9pY8pEescqr0J5K0qb46/2TkrxTK2zfP0u2Z0Jc+oa4bY/vCmbiV7JauON1RiPUDT8aR79027+GBMEWVJ/hdGb8jTNxvGgzb91Ia4fTxKg/aOhPlHWuYeuo0ZTfN+52ce0kQOAur4hrY/5Op/uJ+GdvU0xY7FC0hc8th1PIVR8AwYS+XiGe2S/PXMuXX+t+NaOO4wXbipPgBI8iFE3m9APq/UtRRqxp4ZSXxnJRbnYmdlLB+tuuZe4wLH4SAPIBlHwNX9QuFrksqW0kF28ixLn86q+KceIH1cKInMYzEdQDoq/tN8jztOoqUFnf+kLZnoXBxqd73OYd5lzleYWYk/GpNUXZ3h2UtfeS7iJM5iNyTOsHSJ6cpgXtMjLMr2ONWCiiipHAorwMOv8Av/YNYWrwYnLrGkjaeYnqKANlFFFABRRRQAUVW8cxTIgCuqsxgSpLH7oBEeZJgVQ2L+IZUNy4GDExMqQB7TqQM2UDmTrIGxBK5VFE6o3G4ODsR135VrxlhXQq65h056a6dDSj9Iu27QB8OUrAy5okyQQMurj3ACecCtA7TX7ak5CwQ5suve5ZJCm20NOXTmdjFK/6I8UT6t8C3+kGzcbKzkFSYdSGGXUGT7S77TE+lXa4sFWb7MfGVDAeuoFLHFMSl3K9m4FaRCliAQ0dZUZgwGoGpiZFVuH481tRZCkXCzFt21mdwCVyjIpJHXnXFVUb8gytnQAeRIJ5/wCNUOLxFzBuNM+GYgR71o9Aea8xPpO1VuG4ZmYE94ToMwdgy9QJCz1IyzBmaY7WBAUoWLIVgqxn5Hcf7iKmqrloiLViRZvJdSVMqRHnr+VJa8Pe3fLuxzISTEhssQrr1HXfmOVY4t7mBvCS2RpIaAdBvI2bfxL/ABLBJFMC4y3iVVSQl0jNacGVJje23vDqu8b9ar1X1vZ7s0Tj2deBuwePFz6q4QwcEKyxDCNQY2aJPQ67Urvca06MWgkm25g/rrJIVv4lExzGnM1Gv4S531u5ZhLhYh1nwi4hOb4eFvgKncYupc79cwTOq3hmIBS6kK4bXTa36hjyNVZ1XOmm32ov622/kZltK3Bl1j8etxMO4IH1hLCdstq4GE+pGvPTrStwfw9+sEA27oXcAq9wW1j/AH0qutYDF4kWmtqyWxJIukopkAA5YLlgJGwBBHSmVeC3CtsPfC93lju0iQusMXJkSAdtwKjUxK6xTe9vudjDstFT2tf/APbtqNzYugepkD8asuKObqOEP628I8/qg8f9sfCvcZ2aF26l5sRdzoIGluImdRlqPiuzl4WbNqxfVRZgoGQySBAJYHeCdYO9V41Y5FC/L2v9xmXW5N4FiSuGBU/XX2ZF6oiEqxP3dTrzZRUDBkXrzBP1fhw6fdLfWEHmSq3dfSo9972Fs33uK3fXWIVkGa1bVjuGA8IBLOSwGsDkKhcIxndXbSqQihHYvocg0tqROhMC4Ndtd6sqopyTfdX+v7C8lk+Y3du8ewstZtCSwm4fs2+YPm2w8prT2e4R3l57t7xZO7yqdg+UNt+yCAPid6oeK4q47LaS2VtsQ3ilrlwnYtzk7gbmNY1AaLPFBZtsBlZwS11yfqbZ2hn94qABA6axNWYVusn1k9Ir8e5CUcscq3Zf4vFJbXM7AD8SegG5PkKW14hfxtzJam1h1/WOP1jj7CkaLPUGY56iqS3duY64FVmKnUswiVmJI2S2Ngg1Y7neGLGoLNoKmbLMBA+SerFk1Zj0zCdasRrufa2j4i3C2nEuMLjLR8CMPCNvLb8NJ9R1ox+K7pXc7BCR6j/OR8jSbjHg3GXLbLK6e0qt3hA1IbQwVU6MZ+de8T479U1tyM9ss9xQ2otFYLA8x4iQdtK51+6DIZ2fpN36oMAZyXXDECRplDcvePhlvFypyw1tbaKggBQFAG3lFJnAsY/c50th9AycmyqVfcnQQQZY5mJJMSBVff7QYi5cNqyBcZWWWEopkTc7t20Zj+rUDYAnnXYzUdTri2dJzDaa9rnPDMRxBCWuqpDHxqrlWCCAqocpyqs6jRtzPOrHC8cxiv47S5JIP7AU5SFUEBhMeItMEaDWurEQvZh1bHWio2AxgurmAb4qV+U7/AmirAs143CoczMCSVg6xC8wD7oPOKWsRxgC6FFpcrCcwD6BNRlkZYgEzoOfOmjG4c3Bl93c9GPIHynU/LnWpsPZtrNwqNCCzwJmC0z1gfIUicG34E00kKmK4tiCCRbYZgShcorKvO4xVPCn3pnTSqHiWKDDJdlC4JJ7pvHGgeEIj1KQd9d6a+Jdo7WmRA0knMR9WcvPvFlVjq2gpM7ScbS8gDu+VrgUi3C+LeWYkBiFgsRmA0jfWvOEU7NjItsqcFfJt3BfurnIYW7iMSrx7r7Q3hA1g6dQDUpr4S7euFghtuQMwWbnizXFtZjBaTqw2MDxHQV2VQo9oWiYQO4YsZjwp3YK9M0jfnqKyxmNd72V7S6khARKAnWA0g+LNm5AyaUkr6ExxweLuXGjxr9Wq+xdzKCSdFUAKdCTPtBZnSmDh9i8pVA+bSCDnCBhLCCD7LjUHUqQN6TeCMF8OY24WCq2FkFhMElB57zTpwglbbkksChGYgBlOu+gkHr/APdMha6zC5LkbLmHW6rWbneDnBhmRuTIRqRM6iQZIMa0iviLvD7xs31z2SZKjzJy3LR5E7x5EbiaU0uNAOZp9T8axvIH9sZvva+fOqtTF0pq0k/YoRx8Y8Bv4pYxHfW72DujELebMomHVhvn5FRzJ1EwZJ1cMNwcFxfvhbl8CAcvhQbwg9feOvptXH7KBPYlfukj8j5Ctvfv/SXP7R/9VVKlSMuL9Nf5GrpKmv8Ayzt1FcUXF3Rteu/2tz/VXoxt3+nvf2tz/VSMseft+SX6pT5P2O1UVxU429/T3v7a5/qrIcQv/wDyL/8AbXf9VGWPP2/IfqlPk/Y7QRSxx7sorzcw4CXOaycjgaxHuGeY0670gLxO+P8A+i9/bXP9VZf8XxH/AMi9/bXP9VThaLupewfqdN8GPGEfKjXsQ4t2xFtUE99oIKGNQWMnKupESYqnxONuYu4ttUi2D4LQgKANS1wjTTcnZR1O6lis1xs9y5cZtpNx/TrW3A4q7ZJNq7cQkRpcbaZjU7VZhUpXWZvTw+epz9Rp8EzqBHcWcltsqGM9737h2iyp2XkGOnruU7EYDGLfLrdOR0YBGdnSeS+FfG8GcgWPOq9e0+MVkb6Tcbx2xDNIILqCCDyIJFdB4thHKuG8DGYNtQSizrlZiiqdjK8+saaEWqqzQ22sydGvGoriS3EhYd7bNcthTIttd8ZZwQDKEMIZpC68xMVXcQxj3bZdmY3BbKtJBZ7LK4P7T92Sep8Sk66CVe4FbZCe9WUZiGu2mDsfaZbYV27w7kmfU1rwmDRGZj4bZRg7PoUzArCKnhDMu6iY1O61ydorUsR1ZPw3aQm0EY21tjMXe5PdqSdmIIWFyqAs6nloKvOz/aQOyd2tsZgyzlgswIAOpVip6hY6mkyzaVwlplUgQUPcA2sjaKUfviIP2ok86v8ACYp8Jc7sWlZhlyqbjqqyDI7p9yf2ZmBEb1yW9n89jtuKGzh3EMWSRiECtmKBgMw2kLlBGpWCDmINW+Bx1i8MpBJuCT9U4BJAnXUDQCdeVVnCu0Vm/o2YOCkypRQyGRGfWJ0k8qm8Q4TlgquYZpjpmdiAIMgguYIOkU2NNJXVmQbLfhuDNpYnrI666H1IifOvKi8EU5mMtBCkA3GbwkSphtuYmeVFWoWy6CnuWl66FBZjAFc87UcYxRuxYzIs8xdXwwTPiYKRAOmXlTxxS8yqWEAAdJYnYKo8zAn8KqLuBFpDexM3IR84AJYs8LAjkFlRy1JqM8zeh1WFFcKXQnFkDOttY8KKS4715kgZu7CiTsWMbVT8Rv23IGUL3IZiQwJOfxEIF+0cwB6AHYVO4hiLuKZ7lx2RAWFpMq5TcGighZDQRJBJgA+U1PDxbTKLhzXBdXPA1bvVe3cIEx4FZRvvNVJJXtcdF8SPibZaFvMqqoe7IaIAgIvkAQB5gEVkzvdtq6MyMrLbJUFpme6JC6gmGGxIBWtj4Fmt3WEM6wqIN3RVKkADQQ2dQdI3nUzlwDClDetuygMWCsSCc3hu5n1khSLSR5mk2y9pcxt76DPfw7GbrIVYqkvsy5VvO8GAVnw8udXvA8bmt3bL+0qt/wAzNIiDEgHpzMVSYLGIkWrhypdVYz3bikNuUIcFPQ6SDpOtW9jCuty641UASABlGdXkqeoGSTz1psW07L584iWcmTYele14mw9K9rEe55xhRXjGBJ2FXfZ7spcxZ8QhBEgnQT9qPaP7O1WMPhpVnpsMpUXUehQ272ckW1Nwj7I0HqxhR86lrw+8ZJCoBp7zsWOyhUElucAmBqYG/VbXZO2ihUhY0mNvh/vbzrzgnCVcd5lhGJKn3inuQehHjJ5sx6CNeHR9GK1Vy/HC01vqcys8FuZj3r5V5BAA/wASS466CfWmHD9he8EkXlETBcgkcvZjfoNtPi49oMbhsDZNzIgY6IIGZm3G+sCKS04ziSrXblxsxWF8cQWIloGwCqw15xtViNCnHaK9BypQWyRbL2BsAHMSvWb75o/rQPX8Kj8a7D2RZL4Z2DqD4M5uKYO8tqfhWngHCyxF1vEgJzEkEZuQIOretXnA+J58VBgAggefLly23n1rrpQejS9AcIvgcvcFWKOAHWJAMiDqCDzH/sUU7dsezAzhgpUDNkdR7ImQJ97n4T5dBSZfstbco/tL02IOxHkddORBFYuLwbpdqPd/gz6+HydpbGm97v37X8xa6XxK0L99hcClLYLMpZM8KM2UzmuGT1KR0rml0xlnbvLX8xa6tj7CISzwr3i/gUCRa8IXQDTwB212JNNwsrUH5/Yt9H91+Yv4jhtsveLPlZTbtqoRssqMzhD7K+IoIEnw7MTVFxvEL3vcDxJbkKY1a5m+sfqZgoOcDzq8N8XO8uWwLjWwxtmTC3CGYSSfbaWuEbiFmOdBhrDKwJKpnCqxbVhcOa3aI8gt1WI05da63Y1YoueBL9HuFbQzJICgeyTmW1cU+TM4Y8jqdwDV0+ODujNYiyh0e4pN1CJJVMhJdfCevxil/gitadlUKe6UNlGpGVc2UZtQzWwzGTuw6a33DMO2ZbqqCjROYARM90sgxmyFNSCCSutdi21fexySVyZiuAI1nvbMOkXHUkagCXWCwkE6qeW1WHDuNd2yWbgEtIGZnPsRICrbIU7ECdoqqTFNhMW1sEG0+VXBWVW6VDEQbigBpkR503XOGI5DxBIJkbhjkgjp7IqzTT3h6CpPgyYloeErpAjaNOkHpXtZ25gZt+cbUVdQgHIAk7DX5Ug9qseL91UdYs22UkFmDsTqAUHsrAYw0kwNADq/mlbDdl179nMsnjjMdSxVFJbrqH+dJrqTVok4NJ6iX2ntMo7sSEU3Mo1zMgbMR5Kx3O52GgNeYnhq2lNnxXHe6DmOmZi4vWmLRADEsuUawdqdeM8NOdcmrJF1jzY5wFHplFwRtBNKmMR7t1LNtpKXUIkCCFz3FKf2agMdyo5GqnVtOzHZ9Ch4e1xASFdGeIOVcjgoCDcyjMJHiDamS0A6gzsDbU38gLPiBZuKH7sjLcdfBJGmUasCQDpqdKldobOW9fVFtuoRbcZhFpGLEGCZLKWI5BYHIVj2RwT/AEu1b7sLayvLGSzAowJk6QfI6x5VKKWf/ORxvQ3I63cNlYM+SNSWhmFzw5SDKad4YG4OlN3ZriFu7hiFV1hWVlcTBAIIzgAE+uppe4VayPdcoSEyupAGkhgqZPs5GtE9C1b+BL9HxFy3nBN5H0IILdyMhKsNDz0PQkVyKalb58sRb0ObiigUE1ivc86zwEF0U7M3nrlBeNPtEBfjXceA2Ali2AI0kyIM8/xrm/6NOCC/e+lXBKoPADEQdj6nQnyAHr0XiXHbNlQzODmbKIIOo3+VeiwlF0qSi9zWoU8kLMxxmL7x7mGQnNkGYj3cxg69QuvxFWdtAoAAgAAAdANBSFwDGkcTaSQt1WAk8/bG2hPTqCPi64zGC2VDEAEmfT/evoDVkccy/SNi2fGrbOqplAHITrPqZHyqfd4eMlnNyUMdd5iPU6Azyqz7dcIa4VxFtNbYDE6CdY1nmByq+4LZS7h7bkAkoFzc4HmfSgCs4QyiEMd2RqpnbmSJ1HrprVfhMP3WNbYKCMukCNDp8zrvv5Vd8Y4V9W3dyZBEAGTuRMf7Fe8Tw4GRgmuVRmgTpsJifP4D4gE6ygxFrLc1hoPqrSPwg/GuV9tcGLd+2RuTeRhzhWBU/Db+Kuo4U5MQ9vk6C5/EIVo9dD865t+khY4gencWjHQl7mYx5wPWKrYx2oSE4h2psV73u/vLX8xa65x5R9IzXCFRXtTHQsCM597NkIy7DznTkl73f3lr+YtdVxSh7+NzEhfA2aJy9yyPIB3Pi26is3CdxLxfsiOA7kim7OsLly2iiBbIeFEKCCLBaI8RdBdM+VUFk2muFmbOoW7ID3AbRYjwM0EQwAQyYhRoBv0bsdhAc90qBoLajkq2nvIFHkAR60gYvDrBa1imTNcCvbyqI18QlQpYKCACxJ0iTMVakuym92/nijQT1J/ALyrbYBszK4zuZJXNo1pQdQo7uSTuB0q6N4WVIstnCSDmU6jRmNxeZS0gAPPMKr+AYO1cbEG2A8G1aPhANxjmciQJg+AszFmyg69GTshhrdzvWPiImyxOzaAlvRgQY5a1yMLyVgctHcx7TcFa6RcgAELnUCczZxLSearJBq57NX81hQVKkbgqAN9xlEEfj1q0ZARB2iPhXlq0FEKIq9Gnld0JcrozooophEKKKKANF7Dg5jElgFPoJ/zNLXC+CKmJZwMzGVa5zLrkcHyGrLA2AimysLVsKIHMk/EmT+dQcLu525yjtDh1fiF4XYtKbgyuSwLEW1DW2ysJDaOIO2m+lSuyaL9NtgS4DPlePAECMqqsnSCWEADz3FSO1doviMQrkCyxQPmDaHJbghoyiYXUSRrpzEXsheZsXY7tU7tQyeEGTlUq3iywQgj1J23NVYp9b9fn+DX3B9xXC4dHtAAzczH76Rt6rb+VROMcGGW1lXS2rpI9pQwDBgeoZB8z1pgrVivYb7p/KrTppirnzzUTirfV5ftsqfM6/hIqXUXHoT3ccrts/CY2+MV57DpOvG/MxqWtRX5nSEnA8NV7guFnYOU5TBhWI2X16RWrDYlL6DC4iz9GvXB3qFZKMhUFmzNOWANpMwYmmi1wy3i8JbS6GVcoBVSF5R7sx/7qkXsLZwtt7ue5duaAM5EIkxCgbCIkmdJr0hsHuI7Oth0sYgXe8eyQCSYDIW8OpOpAMeenSpnaTFli2SS1o29NIIuaA+obL8zV0eH97hltXHJkKWYRJAIaOnlNIfZzjOfH4tcTBBsZyqiQO6uAGIOp1U0ANnAMa1wd2/iUyPFz0Gmu+n+NX4yqIgKPLaTVdg8BaMNbJ8LEb8wxJ/En4VJ4mgNtuoGffmpkE+UifhQBIxF0IjOdlBY+gEmtVtw7EEAgZWXzBG/zms7qi5bI3DoR8GH/ALqrwjsq2HkkAd03wOWTr1FAGfaDFph+7xFxgqW8+c/slZgDcsSBAH+Ncf4pxF8TfuYi4MrXCIXTwIuiLI6CSfNmrof6WHH0NFPvX7QHqua5/wCNczrK6SrNWpriUcZNq0TC57v7y1/MWu8JwgHVtPHcYj7QN3vVn5Lp00rhDDVP3lr+YtfRtS6NSdN+f9Ingu6/Mrez2G7uwF/auN6hnZh8wZrlFzHWrVxxh7gt3XZgyXbYy92XaGDRuqa6kzBBrs+XSBppA8ulcex4uL42V/Eq2bTobeY5yTlOmszMELtBqziEsqT+fTiaFPfQYP0YWbfeYnKy3IFvxqgUFjnDyd2OiiSflTzhMGttnKgAOVMDbRQv+ApV/R5ZdDcUoqIiWkVVDCADcaPEASYYEnmTTpTqfdRCW4UUUUwiFFFFABRRRQAUUUUAc57TreGIxLLkNolLdwMNMptKNNf2xqRG1RuyTO2Jw5SBZtg2kHJlCmWDDQnQbTJnYVA43iXGIvNcYhM1xLrkKbcJFsEqsMoICA85ggipfZnvfpuHVmACSAuRgMmUgat100G3XkKMf3r6b/PqOfcOp1qxXsN90/lW2tWK9hvun8qvCT55r1HhkJ5Pb6/bHQg/jQa13RJQZssvbE9PED+QNeZoq9aPn/ZjUv3F5nZeyN24bXiQqm6nSD6azHrr51XdtONkFcLb9u4yrI3BJnT0ALVZdm8PcFtM2J7wZR4ITQRpqNRSo9oJxgvinCKq57bP7Bzkj2tgZCL8GHOvTGyN/aXiK4TCM+0KFUDcEwo+Vcd7FYkpxO0Xn643EJI0IupGn7Mqv41b/pJ42+JxC4W2rHKQAANS52Gumo11iKqOOYa1aay2HfvLuHTVl9jvVY3BDHcSTsD6ioylGKvJnHJJXZ2fs9dBtaaGSSOhO4+BkfD0rKzjA1+5aIkhduRHLc7mTVTwBycTcynwOi3lB+zchgRr5uD6VPu2imNR40uW2UnzEfj7P41I6T+F3c1pSRBEqR0IMGoGCE27yxOW4fjov56/nUccdsYe+9m/dVGdyUzSAQVWZaIGp59RS52o7XpbFy1gbga5caXugApbBEEIdmfSOYHPoYznGCvJ6EZSUVdidxLjOIxZVsTczZZKoABbVtQSoHOJEknn1NRK8RAAANgIr2vM1qjqTcmzHqTc5XZ4x1T95a/mLX0ZXzjd9395a/mLX0dWt0Z+2/P+i9g+4/M8bauPcUsNYtpcK95busuUKxzJceBBDZtD1GoMxyFdguglSAYMGD0PKuI27rW1YsLtxRJtqClyCdbmZQsqIM54Gmmk62cRfTU0KY+/o9suhuh3LaWyQSDDeIEbaEADSTTnXPP0ZKy3bozSjpnCmCyjNCgsDqYmTXQ6bR7iIz7wUUUUwiFFFFABRRSxf40b2INi3OVBmczEg6DbXXUx01O4FKrVo0o5pEoxcnZDPRUDhFzwFCdUJH8J1X8NPgam3HCgkmAAST5DepwmpxUlxONWdjmfEeHqtzE4k3MottdmGYPGY5tWJGbTQgCQAN9a97K2HuYyzdIuKoDBRcKzlymdIkydZ0iq3E2ixuYm2xbKznIHcO8tv4ifGQeUcxFWXZjCNaxdp2FxVZmADlIGZfEB7zeKDICgT0qlCSdXvcfnHf6Dmnl2Om1qxXsN90/lW2tWK9hvun8qviD56NYhJa3qBDqddtTl1+dZGsXWQRXmKc8lVS5MxYSyzT8TrPZy53ViZtZspOVDLkiT4jOnyqHhL3c4G/i78G5izoCARkjKgjmIzPHnVR2WX6TbGHCgd7BukAyqL+s1nSfZHmRVZ+kntEt3ErhrelqxCkiYzmYgjTQqv+zXpZStG5st2VygvYB8O7IzHNBGhk20MgJm3YxInkugjNWCiNqzv3mdmdzLuSzGIBJ6Dpy9AKwrz2LrurO/BbGTXq9ZLwOncBxbLZ4a2kPYVCeey/5fjV32h4/YwihrzS2pS2utxjBGg6anU6CkHhXbUWcNasnCZ3sjKjl1CQPZJ3YGIkRSxicQ924966QblwyxEx5ASTCgaAVrVsdThG8dWXqmJhFXWpN7Q8ZfGXu9uKFAUqqDWFOpk8yYE8tPia6iisOrVlUlmkZ05ubuwooopZA8O6fvLX99a+jK+cm3T95a/mLX0bW30Z+2/P8Ao0cH3H5mvEqCjA7FSD6RXHLuB7vD95Ya07XjaQ22tiQw3Ok+zLZtIjXlXYcaoNtwdirT6RXIeGC34nRLV3MozW8pUo4BhiZIUFtCBE7gCKsYq9lb/TRpjF+j7CLbxDFbiOz2yWFsMLY1RhlBYjL4jEAbn4dCrnHYnAWLd+yVKm6RdZwqgBWI8UaSACSInLtAro9Tw7vT+IjU7wUVXcVxB8NtTDN4iRuEB/xOnz6Vjgcd4+6dpYgsp0mOhjfnr5fMeIgqnVN6nMjtcs6KKKeRCkfD2Wwt66cuZSEDAEBwVGRWGYgMjKBzkGR6PFQuJ8PW6uwzicpPnuG6qeY+O4FVsVQ62FluTpzysXl4jcLB7Fps4GuZrWRl6NDkjyI1HzBl4/imIe06rhgGZGAm8sAkQOW01V8OslLwy6KwOk6g7Mu3IiK2XsWwuBVb30WZnQ2u8bODop5rl39JrMoVK0YyjBq0ddbj5xjdN8RZu8JuqzlsJey5UC5LiNqBDEgsYPLY6Vo4ZiF+kWfpBu94b9nuluAhgM6KARAmYnmYjWmmxfc4llUyVhGJYEa+H2VA1zDWdvia23eJW3AW7bzIy3GGZYgW4zllY6RmBBBPPYiKYnWpy1V7cvycbjJchyrVifYb7p/Kk7Dcbay+VWJWSAlyY06MZZfTUDoKZcLxFL6lV8L5T4G36aciPMVo0sRCptvyESg47nBjXqIWIABJJAAG5J0AFeXvCTm0iZnlG81P4NxhLA72youXyDkdh9VZnSQD+sueQ0HWawqdHPN5tEt2YsKd3rokMHFcZ/wnBmzZg46+A1wzpaQ6ankBr6mTrVb/APjUYayLMPIZ3ut7JusIzHlAA03jSqJ3ZmZ3Yu7nMzt7TN1P+XKrXgPGjYm3cBfDvAZB7S66lPLqsjy6Vp0cdTcsmy4FyniY3y7LgVOUjQmYJAaIzREkDluNPOinG9wC1ixmw11XBOoDFcijxQROZWJNUt3s/cADLMM5VAwOYrGjHKNtuXPypGI6Pbeal6EKuFd7wKiip44JiPFKrCtkMMx1kjQZROoHPnU49me7ztiLoUW3WM8KjqddFOrNBBGu6kUmn0fVk+1oKhhZvfQx7J8BbFXUZlIsCWLGQHAMAL1E7noPOqvGWVRhbRxcFtQhuBQA7AksdNxrEkmYJ2irfiHaH6s4fChks6yx/WPPID3E5dT5c6GpYmpTp0+pp682SqzhCPVw+oUUUVnFQxbdP3lr+YtfRtfO+HtZ7tlBu96yo+Nxf8JNd8x/EUtaGWc+yi+0f8h5mBW30d2aTb2uaWDXYfmQO2GLa3hmy7uRb5TDaGJIExJrnHE+Kd27KEazeVVysjM4KEgQ1lGYnQPCgErodBTxxTCfSQDioKL4hbScoI5sw8TH0geRrzD3LdtD3VsIq5wwCwZQToo3kSRJHLrSq+KVWSVNXXojThDKrsTOzHhxFjE3LWJa6Y7xzavKgBVrZAUjX3WLEdNAZrpd3jlpVLRcMAmBbeT5DTequ1jCzMqwYFsz9+fCQTo2infZlNVNzi7OryyKAQJDo+sBtCNIhl+M12OIrU4vsqyf2BxjJm+9x5RrBe451jZeijOQYH46nnWrhPfPibZf2mMxp4LSnMWI6lgqgDTXfpF4fcOVrxJcKQltBHjuEgKJHKSPz5U6cG4b3KlnOa68G4/nyVeiLsB6ncmo4Wk6lVzfB6vxO1JZY2RY0UUVsFYKKKKAF/ivC7vei5ZVXE5iubKQSIaJEEGAfIz1qrbgTkEfQ9yGMYozKjKNZGw0p0oqtLC03Jy115NonndrCJi8O6tne3ibZAcZiq3UGceInuyX5Aydq1NesDKUKFIUF7YnVCGKsNwNFMeUHeugVVcS7P2LxzFMlz+kTwt8Y0YeTAioSwrveMn5Px9zqmuKFGwgvFrlzUXGy20J5IOqzDBZbXTM0Vv4QtswMzFCSLZOhMTlIgyDlgzpEgdBXmM4Rdw4YO5CMCPpFvMAOQ75FOkT7Q039navLMWrihlhRbhCCMmhGlnm7uTMGOW4FVq0cyy2tL09HyXqiafHgLfa3stdR3vr9ajEs0L4lJ1JKgagmTI89KVprsGFxDL4W1bfKJhZ2UGNtIBJ130BFVPFezGGxPjtEW7jANK7GdQWSfPcRWdVjJd/1+bFPEYJVO1TevI5rRVrxns/fw0tcQsg99AWUesCV+IiqlXB2IPxpWR2uZc6U4O0lYyQlWzKSrfaBIb5jWrXDdpsXbiL5aNu8RGj4wG/GqmimQxFSGkZMI1Zx2Za4rtJi3n67uwdSLdtBr1lgTPoarLrljmdmdurMWPwJ2rGiieIqzVpSYSqzluwoorUt8M2RA1x/sW1Z3+KoCR8aXGEpbIjGLk7JXNtY3bgUFmIAG5O1XGA7JY+/H1S4dT714yw9LaT+LCmjhPY7CWIu3i2Jddc7KxtKRuQqDIsdTJHWmKnz18Fq/sXaWAqS1lohY7EWXN0YsoVVAe4LjckZWuhTvAJCkwNWOu1N5xLaFSSGZVZplmLBmBJ96cp6AcoFSWsrcDXFGYIwgKSQyhQzFerCQRHNCN6j3kVUdlynO1t+9VotwhMsR7IMFtVgTyETVzRxyy0SvZcL/f4jUpwjTWWCJuKUqHaCGVvqmA0bUC2A0/WZxGYGYk7RNeYy+1i4z5rVq2cstduQWK+EFFXXVPDqZ8I0o4Rgr9/W39XbP8Az3QZyP8Aoqw2P22+AbemXh/AbFk51TNcO9xyWuH+JtvQQPKrMaFSo83dXvvfw24A5Jabifh7hbu2R8Q7KqqXt4V8tzKcy5muCCAdRrpJ1gxWvG8MxLmFsYgCMoOTDKAJn2QR0G/4V0eirCwq4yb9PsR6xir2d4LdU2TeQIthTlWQWa4wyl2CeFYBbQE+15U1UUU+nTjTWWJBtt3YUUUVM4FFFFABRRRQAUUUUAeEVQYzght+LDqGScxsN7IIMzaJ9gzrl26ZaYKKXUpRqRyyR1NrYR7Y7y6Rb8BCnMSIuLMAKULe1AMMVgQCJma0YkqsgEFiEtIukoCPFKHVYOYid8tsCadMdw21e/WICRs2zj7rDUfA0sDCuzOLd3PZBAUXlDhiPaIYQcoMAEk6gms/ERlRWZtNaeD/AD+B0GpOxhZxTLcFm2ucDwsSX8OUgPJYQQDpAOsTUr/h1k3bdtraPbuFptuoYLCs+dJ9nUAEDTUc99dnJazXHBVkXbOWQKeaTsDERpEbdbLsvYVl+klld7oGoIIRN1UR+Pn6UvDJ1K+anol7/OZ2ekbMquJ/o5wtyTaL2T5HMs+jax5AikDtD2YxGDM3FzJyuLOT4/ZPkfma7jWu/ZV1KOoZWEEEaEVdrYOnUW1mUKmHhPhZnzxW/hmAvYm53WGtG43vHa2n332Hpv5U3XP0d3HxjWgzJhhDd57xUn2FP29CCeQg866Zw3h1rD2xas21RF2AH4nqfM1Tw/R2t6hXpYTW8xI4N+jC0AGxlw3j/RpKWh8jmb4mPKseD4JMKSEtJaJb61VUCDPhWOShYy9RrrJNdDqh7UpaRRedlUghTJAzITBHmV9odIPU1axOHTpZYaW4GjStB6IzBmqnFJF9GRSzWxGUIfZJDKA5hVHtg67HYxFV78edbhwtlBcvKYYs0Is6iepiDl00NWPCcB37FcXddzAItCbaaaNIUyw9k6sRrWXhKc1UsmtefqWqjWW5q79BbTDrmv3VCg27JOhGoDsNLafeI067VZYDs6WytispCwUsJ+pQjUE7d4w6kQOQ51e4XCpbULbRUUbBQAPkK3VrUMHCnq9X84FeVRsKKKKtiwooooAKKKKACiiigAooooAKKKKACiiigAooooAh8YVjYuhJzZGiN5jl51xm7xfHW3aL7BPdXKuTKNgumgEdfXz7lS/xfsul1jctkW3JkgqGtuerLpqeqkTzmq2IpOeqV/MZTkk9RAwbY3HLkKBEJGd/FLR1LEwPIdfOnDCYNLCqqgqwAGZDDE66QDLmNYg+lZ/THseHEWDbUbXEl7JHUkCU/iHxNRrd13Zbiql4DNBt3FyHMQQTOq+yo0zeVZSjJTtPspeNvce5JrQtbWPu7pdt3AYIDiDB/aT/AE1JTit33rH9S4D/AHgtLRvHugouwZZnMgGWbUd06lju5HrVviCVyLOkgEknQQTJgjUwBvG/lT3WrwaSle6vquH8shli+BMu8eKiWsOB1LWo/v1h/wAZusJt2EIOzNeEf9itPzqmxN4soVirfWlSdYTRmUtsZgKNxq41PPZhnILKCMloK0RyIJymCBssyQTDj1Mnia2W7aX0e2xzJEsLmKvn276JPK2gn0ly0/IUucc4at4NlLORo2YsWB3E5tYI+H5VZ4Z7YR3u3BDO9ttVCiC1vw5QI8MeegrHhit4lI8DAktkKoGGUAJnglT4jt1110RVnUyuTm207cvYnFJPRHP8SGt3+8BObm+ZpJGxKTlDaCSPUjerzspx7E3cVluEPDW8rAAEAuARpoQUL/KesetwgXrhVT3hzTlteIjX3n9lOWrGdtKduznZxcP42Az/AGV1VTsSWIBd/wBogc4AkzYoU3Np224hUkkrDBRRRWoVQooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAqsxnAMPcOY2gr/btyj/ANZIJ+NWdFcaT3AX37PXF/V4t46XUW4B6Hwt8STWL8PxUajD3Pi6/mGpioqvLCUW75fTQmqkuYqPgcVGX6LYA8sQw+UWgRXtvhWJyFFs4ZFMyC7uDO5IyCT6mmqiuf8AFR2t7v7h1khcw/AL4EHEJbH2bNhV/F2b8qkWuy9iZu575/6zll/qex+FXdFNhQpw7sUcc29zCzZVAFRQoGwAAHyFZ0UU0iFFFFABRRRQAUUUUAFFFFABRRRQB//Z';

// ==================== COMPOSANT AUTOCOMPLETE ====================
const Autocomplete = ({ 
  options, 
  value, 
  onChange, 
  placeholder = 'Rechercher...', 
  isDisabled = false,
  isClearable = true,
  noOptionsMessage = 'Aucun rsultat',
  accentColor = '#0f4c3a'
}) => {
  // Styles personnaliss pour react-select
  const customStyles = {
    control: (base, state) => ({
      ...base,
      minHeight: 44,
      borderRadius: 8,
      border: state.isFocused ? `2px solid ${accentColor}` : '2px solid #e9ecef',
      boxShadow: 'none',
      '&:hover': { borderColor: accentColor },
      background: isDisabled ? '#f8f9fa' : 'white',
      cursor: isDisabled ? 'not-allowed' : 'pointer'
    }),
    valueContainer: (base) => ({
      ...base,
      padding: '2px 12px'
    }),
    input: (base) => ({
      ...base,
      margin: 0,
      padding: 0
    }),
    placeholder: (base) => ({
      ...base,
      color: '#adb5bd'
    }),
    singleValue: (base) => ({
      ...base,
      color: '#333'
    }),
    menu: (base) => ({
      ...base,
      borderRadius: 8,
      boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
      zIndex: 9999,
      overflow: 'hidden'
    }),
    menuList: (base) => ({
      ...base,
      padding: 0,
      maxHeight: 250
    }),
    option: (base, state) => ({
      ...base,
      padding: '10px 14px',
      cursor: 'pointer',
      backgroundColor: state.isSelected ? accentColor : state.isFocused ? `${accentColor}15` : 'white',
      color: state.isSelected ? 'white' : '#333',
      '&:active': { backgroundColor: `${accentColor}30` }
    }),
    noOptionsMessage: (base) => ({
      ...base,
      color: '#6c757d',
      padding: '16px'
    }),
    clearIndicator: (base) => ({
      ...base,
      cursor: 'pointer',
      color: '#adb5bd',
      '&:hover': { color: '#dc3545' }
    }),
    dropdownIndicator: (base) => ({
      ...base,
      cursor: 'pointer',
      color: '#adb5bd',
      '&:hover': { color: accentColor }
    })
  };

  return (
    <Select
      options={options}
      value={value}
      onChange={onChange}
      placeholder={placeholder}
      isDisabled={isDisabled}
      isClearable={isClearable}
      isSearchable={true}
      noOptionsMessage={() => noOptionsMessage}
      styles={customStyles}
      filterOption={(option, inputValue) => {
        // Recherche intelligente sur label et toutes les proprits de data
        if (!inputValue) return true;
        const search = inputValue.toLowerCase();
        const label = (option.label || '').toLowerCase();
        const searchFields = option.data?.searchFields || [];
        
        if (label.includes(search)) return true;
        return searchFields.some(field => field?.toLowerCase().includes(search));
      }}
    />
  );
};

// ==================== COMPOSANT MOT DE PASSE ADMIN ====================
const PasswordModal = ({ 
  isOpen, 
  onClose, 
  onConfirm, 
  title = "Action protge",
  description = "",
  warningMessage = "",
  confirmText = "Confirmer",
  confirmColor = "#0f4c3a",
  adminPassword,
  impactDetails = null
}) => {
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [error, setError] = useState('');

  const handleConfirm = () => {
    if (password !== adminPassword) {
      setError('Mot de passe incorrect');
      return;
    }
    setPassword('');
    setError('');
    onConfirm();
  };

  const handleClose = () => {
    setPassword('');
    setError('');
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div style={{
      position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)',
      display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000
    }}>
      <div style={{
        background: 'white', borderRadius: 14, width: '90%', maxWidth: 500,
        overflow: 'hidden', boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
      }}>
        <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#f8f9fa' }}>
          <h2 style={{ margin: 0, fontSize: 18, display: 'flex', alignItems: 'center', gap: 10 }}>
             {title}
          </h2>
        </div>
        <div style={{ padding: 24 }}>
          {description && (
            <p style={{ marginTop: 0, marginBottom: 16, color: '#333' }}>{description}</p>
          )}
          
          {impactDetails && (
            <div style={{ 
              background: '#fff3e0', padding: 16, borderRadius: 8, marginBottom: 20,
              border: '1px solid #ffe0b2'
            }}>
              <div style={{ fontWeight: 600, marginBottom: 8, color: '#e65100', display: 'flex', alignItems: 'center', gap: 8 }}>
                 Impact sur les engagements
              </div>
              <div style={{ fontSize: 13, color: '#333' }}>{impactDetails}</div>
            </div>
          )}

          {warningMessage && (
            <div style={{ 
              background: '#ffebee', padding: 16, borderRadius: 8, marginBottom: 20,
              border: '1px solid #ffcdd2'
            }}>
              <div style={{ color: '#c62828', display: 'flex', alignItems: 'center', gap: 8 }}>
                 {warningMessage}
              </div>
            </div>
          )}

          <div>
            <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 8, color: '#333' }}>
              Mot de passe administrateur *
            </label>
            <div style={{ position: 'relative' }}>
              <input
                type={showPassword ? 'text' : 'password'}
                value={password}
                onChange={(e) => { setPassword(e.target.value); setError(''); }}
                onKeyDown={(e) => e.key === 'Enter' && handleConfirm()}
                style={{
                  width: '100%', padding: '12px 45px 12px 14px', border: error ? '2px solid #c62828' : '2px solid #e9ecef',
                  borderRadius: 8, fontSize: 14, boxSizing: 'border-box'
                }}
                placeholder="Entrez le mot de passe"
                autoFocus
              />
              <button
                type="button"
                onClick={() => setShowPassword(!showPassword)}
                style={{
                  position: 'absolute', right: 12, top: '50%', transform: 'translateY(-50%)',
                  background: 'none', border: 'none', cursor: 'pointer', fontSize: 16, padding: 0
                }}
              >
                {showPassword ? '' : ''}
              </button>
            </div>
            {error && (
              <div style={{ color: '#c62828', fontSize: 12, marginTop: 6 }}> {error}</div>
            )}
          </div>
        </div>
        <div style={{ 
          padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa',
          display: 'flex', justifyContent: 'flex-end', gap: 12 
        }}>
          <button onClick={handleClose} style={{
            padding: '12px 24px', background: '#e9ecef', color: '#333',
            border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 14
          }}>
            Annuler
          </button>
          <button onClick={handleConfirm} style={{
            padding: '12px 24px', background: confirmColor, color: 'white',
            border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 14, fontWeight: 600
          }}>
            {confirmText}
          </button>
        </div>
      </div>
    </div>
  );
};

// ==================== STYLES ====================
const styles = {
  container: { display: 'flex', minHeight: '100vh', background: 'linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%)', fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif" },
  sidebar: { width: 260, background: 'linear-gradient(180deg, #0a3528 0%, #0f4c3a 100%)', color: 'white', display: 'flex', flexDirection: 'column', height: '100vh', position: 'fixed' },
  main: { marginLeft: 260, flex: 1, padding: 26 },
  card: { background: 'white', borderRadius: 14, padding: 24, marginBottom: 20, boxShadow: '0 2px 8px rgba(0,0,0,0.06)' },
  input: { width: '100%', padding: '12px 14px', border: '2px solid #e9ecef', borderRadius: 8, fontSize: 14, marginBottom: 16, boxSizing: 'border-box' },
  button: { padding: '12px 24px', background: '#0f4c3a', color: 'white', border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 14, fontWeight: 500 },
  buttonSecondary: { padding: '12px 24px', background: '#e9ecef', color: '#333', border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 14 },
  table: { width: '100%', borderCollapse: 'collapse' },
  th: { padding: '12px 16px', textAlign: 'left', fontSize: 11, fontWeight: 600, background: '#f8f9fa', borderBottom: '2px solid #e9ecef' },
  td: { padding: '14px 16px', borderBottom: '1px solid #f1f3f4' },
  badge: { padding: '4px 12px', borderRadius: 20, fontSize: 12, fontWeight: 500 },
  modal: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 2000 },
  modalContent: { background: 'white', borderRadius: 14, width: '90%', maxWidth: 600, maxHeight: '90vh', overflow: 'auto' },
  tabs: { display: 'flex', gap: 0, borderBottom: '2px solid #e9ecef', marginBottom: 24 },
  tab: { padding: '12px 24px', cursor: 'pointer', borderBottom: '2px solid transparent', marginBottom: -2, fontSize: 14, fontWeight: 500, color: '#6c757d' },
  tabActive: { padding: '12px 24px', cursor: 'pointer', borderBottom: '2px solid #0f4c3a', marginBottom: -2, fontSize: 14, fontWeight: 600, color: '#0f4c3a' },
  sourceTabs: { display: 'flex', gap: 8, marginBottom: 20 },
  sourceTab: { padding: '10px 20px', borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: 500, border: '2px solid #e9ecef', background: 'white' },
  sourceTabActive: { padding: '10px 20px', borderRadius: 8, cursor: 'pointer', fontSize: 13, fontWeight: 600, border: '2px solid', color: 'white' },
};

// ==================== UTILITAIRES ====================
const formatMontant = (n) => new Intl.NumberFormat('fr-FR').format(n || 0);

const formatDate = (date) => {
  if (!date) return '';
  const d = date.toDate ? date.toDate() : new Date(date);
  return d.toLocaleDateString('fr-FR');
};

// Export CSV (compatible Excel)
const exportToCSV = (data, filename) => {
  // Ajouter BOM pour UTF-8 (Excel)
  const BOM = '\uFEFF';
  const csvContent = BOM + data;
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  URL.revokeObjectURL(link.href);
};

// ==================== PAGE DE CONNEXION ====================
const LoginPage = ({ onLogin, error }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    await onLogin(email, password);
    setLoading(false);
  };

  return (
    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #0a3528 0%, #0f4c3a 100%)' }}>
      <div style={{ background: 'white', borderRadius: 20, padding: 40, width: 400, boxShadow: '0 20px 60px rgba(0,0,0,0.3)' }}>
        <div style={{ textAlign: 'center', marginBottom: 30 }}>
          <div style={{ width: 80, height: 80, background: '#f0b429', borderRadius: 20, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 40, margin: '0 auto 16px' }}></div>
          <h1 style={{ fontSize: 24, fontWeight: 700, color: '#0f4c3a', margin: 0 }}>Gestion des OP</h1>
          <p style={{ color: '#6c757d', fontSize: 14, marginTop: 8 }}>Connectez-vous pour continuer</p>
        </div>
        
        <form onSubmit={handleSubmit}>
          <div style={{ marginBottom: 20 }}>
            <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6, color: '#333' }}>Email</label>
            <input 
              type="email" 
              value={email} 
              onChange={(e) => setEmail(e.target.value)}
              placeholder="votre@email.com"
              style={styles.input}
              required
            />
          </div>
          
          <div style={{ marginBottom: 20 }}>
            <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6, color: '#333' }}>Mot de passe</label>
            <input 
              type="password" 
              value={password} 
              onChange={(e) => setPassword(e.target.value)}
              placeholder=""
              style={styles.input}
              required
            />
          </div>

          {error && (
            <div style={{ padding: 12, background: '#ffebee', borderRadius: 8, color: '#c62828', fontSize: 13, marginBottom: 20 }}>
              {error}
            </div>
          )}
          
          <button 
            type="submit" 
            disabled={loading}
            style={{ ...styles.button, width: '100%', padding: 14, fontSize: 16, opacity: loading ? 0.7 : 1 }}
          >
            {loading ? 'Connexion...' : 'Se connecter'}
          </button>
        </form>
      </div>
    </div>
  );
};

// ==================== APPLICATION PRINCIPALE ====================
export default function App() {
  // Auth state
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [authError, setAuthError] = useState('');
  
  // Navigation - avec persistance localStorage
  const [currentPage, setCurrentPageState] = useState(() => {
    const saved = localStorage.getItem('gestion-op-currentPage');
    return saved || 'dashboard';
  });
  const [historiqueParams, setHistoriqueParamsState] = useState(() => {
    const saved = localStorage.getItem('gestion-op-historiqueParams');
    return saved ? JSON.parse(saved) : { sourceId: null, exerciceId: null };
  });
  const [activeBudgetSource, setActiveBudgetSourceState] = useState(() => {
    const saved = localStorage.getItem('gestion-op-activeBudgetSource');
    return saved || null;
  });
  const [consultOpId, setConsultOpId] = useState(null); // ID de l'OP  consulter depuis Liste OP
  const [consultOpData, setConsultOpData] = useState(null); // Donnes de l'OP  consulter

  // Wrappers pour sauvegarder dans localStorage
  const setCurrentPage = (page) => {
    setCurrentPageState(page);
    localStorage.setItem('gestion-op-currentPage', page);
  };
  const setHistoriqueParams = (params) => {
    setHistoriqueParamsState(params);
    localStorage.setItem('gestion-op-historiqueParams', JSON.stringify(params));
  };
  const setActiveBudgetSource = (sourceId) => {
    setActiveBudgetSourceState(sourceId);
    if (sourceId) {
      localStorage.setItem('gestion-op-activeBudgetSource', sourceId);
    } else {
      localStorage.removeItem('gestion-op-activeBudgetSource');
    }
  };
  
  // Data state
  const [projet, setProjet] = useState(null);
  const [sources, setSources] = useState([]);
  const [exercices, setExercices] = useState([]);
  const [lignesBudgetaires, setLignesBudgetaires] = useState([]);
  const [beneficiaires, setBeneficiaires] = useState([]);
  const [budgets, setBudgets] = useState([]);
  const [ops, setOps] = useState([]);
  const [bordereaux, setBordereaux] = useState([]);
  
  // Loading
  const [loading, setLoading] = useState(true);

  // ==================== AUTH ====================
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      setAuthLoading(false);
    });
    return () => unsubscribe();
  }, []);

  const handleLogin = async (email, password) => {
    try {
      setAuthError('');
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      console.error('Erreur de connexion:', error);
      if (error.code === 'auth/invalid-credential') {
        setAuthError('Email ou mot de passe incorrect');
      } else if (error.code === 'auth/too-many-requests') {
        setAuthError('Trop de tentatives. Veuillez ressayer plus tard.');
      } else {
        setAuthError('Erreur de connexion. Veuillez ressayer.');
      }
    }
  };

  const handleLogout = async () => {
    try {
      await signOut(auth);
      // Nettoyer le localStorage de navigation
      localStorage.removeItem('gestion-op-currentPage');
      localStorage.removeItem('gestion-op-historiqueParams');
      localStorage.removeItem('gestion-op-activeBudgetSource');
      setCurrentPageState('dashboard');
    } catch (error) {
      console.error('Erreur de dconnexion:', error);
    }
  };

  // ==================== LOAD DATA ====================
  useEffect(() => {
    if (!user) return;

    let unsubOps = null;
    let unsubBordereaux = null;

    const loadData = async () => {
      setLoading(true);
      try {
        // Charger les paramtres du projet
        const projetDoc = await getDoc(doc(db, 'parametres', 'projet'));
        if (projetDoc.exists()) {
          setProjet(projetDoc.data());
        }

        // Charger les sources de financement
        const sourcesSnap = await getDocs(collection(db, 'sources'));
        const sourcesData = sourcesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        setSources(sourcesData);

        // Charger les exercices
        const exercicesSnap = await getDocs(query(collection(db, 'exercices'), orderBy('annee', 'desc')));
        const exercicesData = exercicesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        setExercices(exercicesData);

        // Charger les lignes budgtaires
        const lignesSnap = await getDocs(collection(db, 'lignesBudgetaires'));
        setLignesBudgetaires(lignesSnap.docs.map(d => ({ id: d.id, ...d.data() })));

        // Charger les bnficiaires
        const benSnap = await getDocs(query(collection(db, 'beneficiaires'), orderBy('nom')));
        setBeneficiaires(benSnap.docs.map(d => ({ id: d.id, ...d.data() })));

        // Charger les budgets
        const budgetsSnap = await getDocs(collection(db, 'budgets'));
        setBudgets(budgetsSnap.docs.map(d => ({ id: d.id, ...d.data() })));

        // Charger les OPs (temps rel avec onSnapshot)
        // Le listener est stock pour cleanup
        const opsQuery = query(collection(db, 'ops'), orderBy('numero', 'desc'));
        unsubOps = onSnapshot(opsQuery, (snapshot) => {
          setOps(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
        });

        // Charger les bordereaux (temps rel)
        const btQuery = query(collection(db, 'bordereaux'), orderBy('createdAt', 'desc'));
        unsubBordereaux = onSnapshot(btQuery, (snapshot) => {
          setBordereaux(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
        });

      } catch (error) {
        console.error('Erreur chargement donnes:', error);
      }
      setLoading(false);
    };

    loadData();
    
    return () => {
      if (unsubOps) unsubOps();
      if (unsubBordereaux) unsubBordereaux();
    };
  }, [user]);

  // Obtenir l'exercice actif
  const exerciceActif = exercices.find(e => e.actif);

  // ==================== RENDER ====================
  if (authLoading) {
    return (
      <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#0f4c3a' }}>
        <div style={{ textAlign: 'center', color: 'white' }}>
          <div style={{ fontSize: 50, marginBottom: 20 }}></div>
          <div>Chargement...</div>
        </div>
      </div>
    );
  }

  if (!user) {
    return <LoginPage onLogin={handleLogin} error={authError} />;
  }

  // ==================== SIDEBAR ====================
  const Sidebar = () => (
    <div style={styles.sidebar}>
      <div style={{ padding: 18, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <div style={{ width: 40, height: 40, background: '#f0b429', borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 }}></div>
          <div>
            <div style={{ fontSize: 16, fontWeight: 700 }}>{projet?.sigle || 'GESTION OP'}</div>
            <div style={{ fontSize: 10, opacity: 0.7 }}>Ordres de Paiement</div>
          </div>
        </div>
      </div>
      
      <nav style={{ flex: 1, padding: '14px 0', overflowY: 'auto' }}>
        <NavItem id="dashboard" icon="" label="Tableau de bord" />
        
        <div style={{ padding: '16px 18px 6px', fontSize: 10, opacity: 0.5, letterSpacing: 1 }}>OPRATIONS</div>
        <NavItem id="nouvelOp" icon="" label="Nouvel OP" />
        <NavItem id="ops" icon="" label="Liste des OP" />
        <NavItem id="bordereaux" icon="" label="Bordereaux" />
        <NavItem id="suivi" icon="" label="Suivi Circuit" />
        
        <div style={{ padding: '16px 18px 6px', fontSize: 10, opacity: 0.5, letterSpacing: 1 }}>GESTION</div>
        <NavItem id="budget" icon="" label="Budget" />
        <NavItem id="beneficiaires" icon="" label="Bnficiaires" />
        
        <div style={{ padding: '16px 18px 6px', fontSize: 10, opacity: 0.5, letterSpacing: 1 }}>CONFIGURATION</div>
        <NavItem id="parametres" icon="" label="Paramtres" />
      </nav>
      
      {/* Exercice actif */}
      {exerciceActif && (
        <div style={{ padding: '12px 18px', borderTop: '1px solid rgba(255,255,255,0.1)', background: 'rgba(255,255,255,0.05)' }}>
          <div style={{ fontSize: 10, opacity: 0.5, marginBottom: 4 }}>EXERCICE ACTIF</div>
          <div style={{ fontSize: 18, fontWeight: 700, color: '#f0b429' }}>{exerciceActif.annee}</div>
        </div>
      )}
      
      {/* User */}
      <div style={{ padding: 14, borderTop: '1px solid rgba(255,255,255,0.1)' }}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
          <div style={{ fontSize: 12, opacity: 0.8, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', maxWidth: 140 }}>{user.email}</div>
          <button onClick={handleLogout} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', color: 'white', padding: '6px 12px', borderRadius: 6, cursor: 'pointer', fontSize: 11 }}>
            Dconnexion
          </button>
        </div>
      </div>
    </div>
  );

  const NavItem = ({ id, icon, label }) => (
    <div 
      onClick={() => setCurrentPage(id)} 
      style={{ 
        display: 'flex', 
        alignItems: 'center', 
        gap: 12, 
        padding: '12px 18px', 
        cursor: 'pointer', 
        borderLeft: currentPage === id ? '3px solid #f0b429' : '3px solid transparent', 
        background: currentPage === id ? 'rgba(255,255,255,0.15)' : 'transparent',
        transition: 'all 0.2s'
      }}
    >
      <span style={{ fontSize: 18 }}>{icon}</span>
      <span style={{ fontSize: 14 }}>{label}</span>
    </div>
  );

  // ==================== COMPOSANT ONGLETS SOURCES ====================
  const SourceTabs = ({ activeSource, onChangeSource }) => (
    <div style={styles.sourceTabs}>
      {sources.map(source => (
        <div
          key={source.id}
          onClick={() => onChangeSource(source.id)}
          style={activeSource === source.id 
            ? { ...styles.sourceTabActive, background: source.couleur || '#0f4c3a', borderColor: source.couleur || '#0f4c3a' }
            : styles.sourceTab
          }
        >
          {source.sigle || source.nom}
        </div>
      ))}
      {sources.length === 0 && (
        <div style={{ color: '#6c757d', fontSize: 14 }}>
          Aucune source configure. <span style={{ color: '#0f4c3a', cursor: 'pointer', textDecoration: 'underline' }} onClick={() => setCurrentPage('parametres')}>Ajouter une source</span>
        </div>
      )}
    </div>
  );

  // ==================== COMPOSANT MODAL MOT DE PASSE ====================
  const PasswordModal = ({ show, isOpen, onClose, onConfirm, title, description, warning, warningMessage, confirmText, confirmColor }) => {
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [showPwd, setShowPwd] = useState(false);

    // Support both 'show' and 'isOpen' props
    const isVisible = show || isOpen;
    const warningText = warning || warningMessage;
    const buttonText = confirmText || ' Confirmer';
    const buttonColor = confirmColor || '#f57f17';

    if (!isVisible) return null;

    const handleConfirm = () => {
      if (!projet?.adminPassword) {
        // Pas de mot de passe configur, on laisse passer
        onConfirm();
        setPassword('');
        return;
      }
      
      if (password === projet.adminPassword) {
        onConfirm();
        setPassword('');
        setError('');
      } else {
        setError('Mot de passe incorrect');
      }
    };

    const handleClose = () => {
      setPassword('');
      setError('');
      onClose();
    };

    return (
      <div style={styles.modal}>
        <div style={styles.modalContent}>
          <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#fff8e1' }}>
            <h2 style={{ margin: 0, fontSize: 18, color: '#f57f17' }}> {title || 'Action protge'}</h2>
          </div>
          <div style={{ padding: 24 }}>
            {description && (
              <p style={{ marginBottom: 16, color: '#333' }}>{description}</p>
            )}
            
            {warningText && (
              <div style={{ background: '#ffebee', padding: 12, borderRadius: 8, marginBottom: 16, fontSize: 13 }}>
                <strong style={{ color: '#c62828' }}> Attention :</strong>
                <span style={{ color: '#c62828', marginLeft: 4 }}>{warningText}</span>
              </div>
            )}
            
            {!projet?.adminPassword ? (
              <div style={{ background: '#fff3e0', padding: 12, borderRadius: 8, marginBottom: 16, fontSize: 13 }}>
                <strong style={{ color: '#e65100' }}></strong>
                <span style={{ color: '#e65100', marginLeft: 4 }}>
                  Aucun mot de passe administrateur configur. 
                  <span 
                    onClick={() => { handleClose(); setCurrentPage('parametres'); }}
                    style={{ textDecoration: 'underline', cursor: 'pointer', marginLeft: 4 }}
                  >
                    Configurer maintenant
                  </span>
                </span>
              </div>
            ) : (
              <div>
                <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Mot de passe administrateur *</label>
                <div style={{ position: 'relative' }}>
                  <input 
                    type={showPwd ? 'text' : 'password'} 
                    value={password} 
                    onChange={(e) => { setPassword(e.target.value); setError(''); }}
                    onKeyPress={(e) => e.key === 'Enter' && handleConfirm()}
                    style={{ ...styles.input, paddingRight: 45, borderColor: error ? '#c62828' : undefined }} 
                    placeholder="Entrez le mot de passe"
                    autoFocus
                  />
                  <button 
                    type="button"
                    onClick={() => setShowPwd(!showPwd)}
                    style={{ position: 'absolute', right: 10, top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', cursor: 'pointer', fontSize: 16 }}
                  >
                    {showPwd ? '' : ''}
                  </button>
                </div>
                {error && <span style={{ color: '#c62828', fontSize: 12 }}> {error}</span>}
              </div>
            )}
          </div>
          <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
            <button onClick={handleClose} style={styles.buttonSecondary}>Annuler</button>
            <button onClick={handleConfirm} style={{ ...styles.button, background: buttonColor }}>
              {buttonText}
            </button>
          </div>
        </div>
      </div>
    );
  };

  // ==================== PAGE DASHBOARD ====================
  const PageDashboard = () => {
    const [showDetailSource, setShowDetailSource] = useState(null);
    
    // Calculer les totaux globaux
    const exerciceActifId = exerciceActif?.id;
    const budgetsActifs = budgets.filter(b => b.exerciceId === exerciceActifId);
    const opsActifs = ops.filter(op => op.exerciceId === exerciceActifId && ['DIRECT', 'DEFINITIF'].includes(op.type) && op.statut !== 'REJETE');
    
    const totalDotation = budgetsActifs.reduce((sum, b) => sum + (b.lignes?.reduce((s, l) => s + (l.dotation || 0), 0) || 0), 0);
    const totalEngagement = opsActifs.reduce((sum, op) => sum + (op.montant || 0), 0);
    const totalDisponible = totalDotation - totalEngagement;
    
    const opsProvisoires = ops.filter(op => op.exerciceId === exerciceActifId && op.type === 'PROVISOIRE' && op.statut !== 'REGULARISE');
    const opsEnCours = ops.filter(op => op.exerciceId === exerciceActifId && ['TRANSMIS_CF', 'TRANSMIS_AC', 'DIFFERE'].includes(op.statut));

    // Dtail par source
    const getSourceStats = (sourceId) => {
      const sourceBudgets = budgetsActifs.filter(b => b.sourceId === sourceId);
      const sourceOps = opsActifs.filter(op => op.sourceId === sourceId);
      const dotation = sourceBudgets.reduce((sum, b) => sum + (b.lignes?.reduce((s, l) => s + (l.dotation || 0), 0) || 0), 0);
      const engagement = sourceOps.reduce((sum, op) => sum + (op.montant || 0), 0);
      return { dotation, engagement, disponible: dotation - engagement, nbOps: sourceOps.length };
    };

    return (
      <div>
        <div style={{ marginBottom: 24 }}>
          <h1 style={{ fontSize: 24, fontWeight: 700, marginBottom: 8 }}> Tableau de bord</h1>
          <p style={{ color: '#6c757d' }}>
            Exercice {exerciceActif?.annee || 'Non dfini'} - Vue d'ensemble
          </p>
        </div>

        {/* Stats globales */}
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16, marginBottom: 24 }}>
          {[
            { icon: '', label: 'Dotation totale', value: formatMontant(totalDotation), color: '#0f4c3a' },
            { icon: '', label: 'Engagements', value: formatMontant(totalEngagement), color: '#f0b429' },
            { icon: '', label: 'Disponible', value: formatMontant(totalDisponible), color: '#06d6a0' },
            { icon: '', label: 'Total OP', value: opsActifs.length, color: '#1565c0' },
          ].map((s, i) => (
            <div key={i} style={styles.card}>
              <div style={{ fontSize: 12, color: '#6c757d', marginBottom: 8 }}>{s.icon} {s.label}</div>
              <div style={{ fontSize: 22, fontWeight: 700, color: s.color, fontFamily: 'monospace' }}>{s.value}</div>
            </div>
          ))}
        </div>

        {/* Dtail par source */}
        <div style={styles.card}>
          <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 16 }}> Situation par source de financement</h3>
          {sources.length === 0 ? (
            <p style={{ color: '#6c757d' }}>Aucune source configure</p>
          ) : (
            <table style={styles.table}>
              <thead>
                <tr>
                  <th style={styles.th}>SOURCE</th>
                  <th style={{ ...styles.th, textAlign: 'right' }}>DOTATION</th>
                  <th style={{ ...styles.th, textAlign: 'right' }}>ENGAGEMENTS</th>
                  <th style={{ ...styles.th, textAlign: 'right' }}>DISPONIBLE</th>
                  <th style={{ ...styles.th, textAlign: 'center' }}>NB OP</th>
                </tr>
              </thead>
              <tbody>
                {sources.map(source => {
                  const stats = getSourceStats(source.id);
                  return (
                    <tr key={source.id}>
                      <td style={styles.td}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                          <div style={{ width: 12, height: 12, borderRadius: 3, background: source.couleur || '#0f4c3a' }}></div>
                          <strong>{source.nom}</strong>
                        </div>
                      </td>
                      <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace' }}>{formatMontant(stats.dotation)}</td>
                      <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', color: '#f0b429' }}>{formatMontant(stats.engagement)}</td>
                      <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', color: stats.disponible >= 0 ? '#06d6a0' : '#dc3545', fontWeight: 600 }}>{formatMontant(stats.disponible)}</td>
                      <td style={{ ...styles.td, textAlign: 'center' }}><span style={{ ...styles.badge, background: '#e3f2fd', color: '#1565c0' }}>{stats.nbOps}</span></td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          )}
        </div>

        {/* Alertes */}
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 20 }}>
          <div style={styles.card}>
            <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 16 }}> OP Provisoires en attente ({opsProvisoires.length})</h3>
            {opsProvisoires.length === 0 ? (
              <p style={{ color: '#6c757d', fontSize: 14 }}>Aucun OP provisoire en attente</p>
            ) : (
              <div style={{ maxHeight: 200, overflowY: 'auto' }}>
                {opsProvisoires.slice(0, 5).map(op => (
                  <div key={op.id} style={{ padding: '10px 0', borderBottom: '1px solid #f1f3f4', display: 'flex', justifyContent: 'space-between' }}>
                    <span>N{op.numero} - {beneficiaires.find(b => b.id === op.beneficiaireId)?.nom || 'Inconnu'}</span>
                    <span style={{ fontFamily: 'monospace', color: '#f0b429' }}>{formatMontant(op.montant)}</span>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div style={styles.card}>
            <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 16 }}> OP en circuit ({opsEnCours.length})</h3>
            {opsEnCours.length === 0 ? (
              <p style={{ color: '#6c757d', fontSize: 14 }}>Aucun OP en cours de traitement</p>
            ) : (
              <div style={{ maxHeight: 200, overflowY: 'auto' }}>
                {opsEnCours.slice(0, 5).map(op => {
                  const statutLabels = { 'TRANSMIS_CF': 'Chez CF', 'TRANSMIS_AC': 'Chez AC', 'DIFFERE': 'Diffr' };
                  return (
                    <div key={op.id} style={{ padding: '10px 0', borderBottom: '1px solid #f1f3f4', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span>N{op.numero}</span>
                      <span style={{ ...styles.badge, background: op.statut === 'DIFFERE' ? '#fff3e0' : '#e3f2fd', color: op.statut === 'DIFFERE' ? '#e65100' : '#1565c0' }}>
                        {statutLabels[op.statut] || op.statut}
                      </span>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  // ==================== PAGE PARAMTRES UNIFIE ====================
  const PageParametres = () => {
    const [activeTab, setActiveTab] = useState('projet');

    return (
      <div>
        <h1 style={{ fontSize: 24, fontWeight: 700, marginBottom: 24 }}> Paramtres</h1>
        
        {/* Onglets */}
        <div style={styles.tabs}>
          {[
            { id: 'projet', label: ' Projet' },
            { id: 'sources', label: ' Sources' },
            { id: 'exercices', label: ' Exercices' },
            { id: 'lignes', label: ' Lignes budgtaires' },
          ].map(tab => (
            <div 
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              style={activeTab === tab.id ? styles.tabActive : styles.tab}
            >
              {tab.label}
            </div>
          ))}
        </div>

        {/* Contenu des onglets */}
        {activeTab === 'projet' && <TabProjet />}
        {activeTab === 'sources' && <TabSources />}
        {activeTab === 'exercices' && <TabExercices />}
        {activeTab === 'lignes' && <TabLignes />}
      </div>
    );
  };

  // Tab Projet
  const TabProjet = () => {
    const [form, setForm] = useState(projet || {
      pays: 'Rpublique de Cte d\'Ivoire',
      devise: 'Union  Discipline  Travail',
      ministere: '',
      nomProjet: '',
      sigle: '',
      codeImputation: '',
      nbCaracteresLigne: 4,
      coordonnateur: '',
      titreCoordonnateur: '',
      nbExemplairesCF: 4,
      nbExemplairesAC: 2,
      adminPassword: ''
    });
    const [saving, setSaving] = useState(false);
    const [saved, setSaved] = useState(false);
    const [showPassword, setShowPassword] = useState(false);
    const [confirmPassword, setConfirmPassword] = useState('');

    useEffect(() => {
      if (projet) {
        setForm(projet);
        setConfirmPassword(projet.adminPassword || '');
      }
    }, [projet]);

    const handleSave = async () => {
      // Vrifier la correspondance des mots de passe si un nouveau est dfini
      if (form.adminPassword && form.adminPassword !== confirmPassword) {
        alert(' Les mots de passe ne correspondent pas');
        return;
      }
      
      setSaving(true);
      try {
        await setDoc(doc(db, 'parametres', 'projet'), form);
        setProjet(form);
        setSaved(true);
        setTimeout(() => setSaved(false), 3000);
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        alert('Erreur lors de la sauvegarde');
      }
      setSaving(false);
    };

    return (
      <div>
        <div style={styles.card}>
          <h3 style={{ fontSize: 15, fontWeight: 600, marginBottom: 20, paddingBottom: 12, borderBottom: '1px solid #e9ecef' }}>Informations gnrales</h3>
          
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Pays</label>
              <input value={form.pays || ''} onChange={e => setForm({...form, pays: e.target.value})} style={styles.input} />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Devise nationale</label>
              <input value={form.devise || ''} onChange={e => setForm({...form, devise: e.target.value})} style={styles.input} />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Ministre de tutelle</label>
              <input value={form.ministere || ''} onChange={e => setForm({...form, ministere: e.target.value})} style={styles.input} placeholder="Ex: Ministre des Eaux et Forts" />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Nom complet du projet</label>
              <input value={form.nomProjet || ''} onChange={e => setForm({...form, nomProjet: e.target.value})} style={styles.input} placeholder="Ex: Projet d'Investissement Forestier 2" />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Sigle du projet</label>
              <input value={form.sigle || ''} onChange={e => setForm({...form, sigle: e.target.value})} style={styles.input} placeholder="Ex: PIF2" />
            </div>
          </div>
        </div>

        <div style={styles.card}>
          <h3 style={{ fontSize: 15, fontWeight: 600, marginBottom: 20, paddingBottom: 12, borderBottom: '1px solid #e9ecef' }}>Configuration technique</h3>
          
          <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: 16 }}>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Code imputation budgtaire (prfixe)</label>
              <input value={form.codeImputation || ''} onChange={e => setForm({...form, codeImputation: e.target.value})} style={styles.input} placeholder="Ex: 345 90042200006 90 11409374" />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Nb caractres ligne</label>
              <select value={form.nbCaracteresLigne || 4} onChange={e => setForm({...form, nbCaracteresLigne: parseInt(e.target.value)})} style={styles.input}>
                <option value={4}>4 caractres</option>
                <option value={6}>6 caractres</option>
              </select>
            </div>
          </div>
        </div>

        <div style={styles.card}>
          <h3 style={{ fontSize: 15, fontWeight: 600, marginBottom: 20, paddingBottom: 12, borderBottom: '1px solid #e9ecef' }}>Responsable / Signataire</h3>
          
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Nom du Coordonnateur/trice</label>
              <input value={form.coordonnateur || ''} onChange={e => setForm({...form, coordonnateur: e.target.value})} style={styles.input} placeholder="Ex: ABE-KOFFI Thrse" />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Titre officiel</label>
              <input value={form.titreCoordonnateur || ''} onChange={e => setForm({...form, titreCoordonnateur: e.target.value})} style={styles.input} placeholder="Ex: LA COORDONNATRICE DU PIF 2" />
            </div>
          </div>
        </div>

        <div style={styles.card}>
          <h3 style={{ fontSize: 15, fontWeight: 600, marginBottom: 20, paddingBottom: 12, borderBottom: '1px solid #e9ecef' }}>Configuration impressions</h3>
          
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Nombre d'exemplaires pour le CF</label>
              <input type="number" value={form.nbExemplairesCF || 4} onChange={e => setForm({...form, nbExemplairesCF: parseInt(e.target.value)})} style={styles.input} />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Nombre d'exemplaires pour l'AC</label>
              <input type="number" value={form.nbExemplairesAC || 2} onChange={e => setForm({...form, nbExemplairesAC: parseInt(e.target.value)})} style={styles.input} />
            </div>
          </div>
        </div>

        <div style={{ ...styles.card, background: '#fff8e1', border: '2px solid #f9a825' }}>
          <h3 style={{ fontSize: 15, fontWeight: 600, marginBottom: 20, paddingBottom: 12, borderBottom: '1px solid #f9a825', color: '#f57f17' }}>
             Scurit administrative
          </h3>
          
          <div style={{ marginBottom: 16 }}>
            <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Mot de passe administrateur *</label>
            <div style={{ position: 'relative' }}>
              <input 
                type={showPassword ? 'text' : 'password'} 
                value={form.adminPassword || ''} 
                onChange={e => setForm({...form, adminPassword: e.target.value})} 
                style={{ ...styles.input, paddingRight: 45 }} 
                placeholder="Dfinir un mot de passe scuris" 
              />
              <button 
                type="button"
                onClick={() => setShowPassword(!showPassword)}
                style={{ position: 'absolute', right: 10, top: '50%', transform: 'translateY(-50%)', background: 'none', border: 'none', cursor: 'pointer', fontSize: 16 }}
              >
                {showPassword ? '' : ''}
              </button>
            </div>
          </div>
          <div style={{ marginBottom: 16 }}>
            <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Confirmer le mot de passe *</label>
            <input 
              type={showPassword ? 'text' : 'password'} 
              value={confirmPassword} 
              onChange={e => setConfirmPassword(e.target.value)} 
              style={styles.input} 
              placeholder="Confirmer le mot de passe" 
            />
            {form.adminPassword && confirmPassword && form.adminPassword !== confirmPassword && (
              <span style={{ color: '#c62828', fontSize: 12 }}> Les mots de passe ne correspondent pas</span>
            )}
            {form.adminPassword && confirmPassword && form.adminPassword === confirmPassword && (
              <span style={{ color: '#2e7d32', fontSize: 12 }}> Mots de passe identiques</span>
            )}
          </div>
          
          <div style={{ background: 'white', padding: 12, borderRadius: 8, fontSize: 13, color: '#555' }}>
            <strong style={{ color: '#f57f17' }}> Ce mot de passe protge les actions sensibles :</strong>
            <ul style={{ margin: '8px 0 0 20px', padding: 0 }}>
              <li>Modifier / Supprimer / Rejeter un OP</li>
              <li>Rvision budgtaire</li>
              <li>Modification des paramtres (sources, exercices)</li>
            </ul>
          </div>
        </div>

        <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>
          <button onClick={handleSave} disabled={saving} style={{ ...styles.button, opacity: saving ? 0.7 : 1 }}>
            {saving ? 'Enregistrement...' : ' Enregistrer'}
          </button>
          {saved && <span style={{ color: '#06d6a0', fontWeight: 500 }}> Sauvegard !</span>}
        </div>
      </div>
    );
  };

  // Tab Sources
  const TabSources = () => {
    const [showModal, setShowModal] = useState(false);
    const [editSource, setEditSource] = useState(null);
    const [form, setForm] = useState({ nom: '', sigle: '', description: '', compteDebiter: 'BAILLEUR', couleur: '#0f4c3a' });

    const openNew = () => {
      setForm({ nom: '', sigle: '', description: '', compteDebiter: 'BAILLEUR', couleur: '#0f4c3a' });
      setEditSource(null);
      setShowModal(true);
    };

    const openEdit = (source) => {
      setForm(source);
      setEditSource(source);
      setShowModal(true);
    };

    const handleSave = async () => {
      if (!form.nom || !form.sigle) {
        alert('Le nom et le sigle sont obligatoires');
        return;
      }
      try {
        if (editSource) {
          await updateDoc(doc(db, 'sources', editSource.id), form);
          setSources(sources.map(s => s.id === editSource.id ? { ...s, ...form } : s));
        } else {
          const docRef = await addDoc(collection(db, 'sources'), form);
          setSources([...sources, { id: docRef.id, ...form }]);
        }
        setShowModal(false);
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
      }
    };

    const handleDelete = async (source) => {
      if (!window.confirm(`Supprimer la source "${source.nom}" ?`)) return;
      try {
        await deleteDoc(doc(db, 'sources', source.id));
        setSources(sources.filter(s => s.id !== source.id));
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la suppression');
      }
    };

    return (
      <div>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
          <p style={{ color: '#6c757d', margin: 0 }}>{sources.length} source(s) configure(s)</p>
          <button onClick={openNew} style={styles.button}> Nouvelle source</button>
        </div>

        <div style={styles.card}>
          {sources.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#6c757d', padding: 40 }}>Aucune source de financement</p>
          ) : (
            <table style={styles.table}>
              <thead>
                <tr>
                  <th style={styles.th}>NOM</th>
                  <th style={styles.th}>SIGLE</th>
                  <th style={styles.th}>COMPTE  DBITER</th>
                  <th style={styles.th}>COULEUR</th>
                  <th style={{ ...styles.th, textAlign: 'center' }}>ACTIONS</th>
                </tr>
              </thead>
              <tbody>
                {sources.map(source => (
                  <tr key={source.id}>
                    <td style={styles.td}><strong>{source.nom}</strong></td>
                    <td style={styles.td}>{source.sigle}</td>
                    <td style={styles.td}><span style={{ ...styles.badge, background: source.compteDebiter === 'BAILLEUR' ? '#e8f5e9' : '#e3f2fd', color: source.compteDebiter === 'BAILLEUR' ? '#2e7d32' : '#1565c0' }}>{source.compteDebiter}</span></td>
                    <td style={styles.td}><div style={{ width: 30, height: 30, borderRadius: 6, background: source.couleur }}></div></td>
                    <td style={{ ...styles.td, textAlign: 'center' }}>
                      <button onClick={() => openEdit(source)} style={{ ...styles.buttonSecondary, padding: '6px 12px', marginRight: 8 }}></button>
                      <button onClick={() => handleDelete(source)} style={{ ...styles.buttonSecondary, padding: '6px 12px', background: '#ffebee', color: '#c62828' }}></button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

        {showModal && (
          <div style={styles.modal}>
            <div style={styles.modalContent}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#f8f9fa' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}>{editSource ? ' Modifier la source' : ' Nouvelle source'}</h2>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Nom complet *</label>
                  <input value={form.nom} onChange={e => setForm({...form, nom: e.target.value})} style={styles.input} placeholder="Ex: Association Internationale de Dveloppement" />
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                  <div>
                    <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Sigle *</label>
                    <input value={form.sigle} onChange={e => setForm({...form, sigle: e.target.value})} style={styles.input} placeholder="Ex: IDA" />
                  </div>
                  <div>
                    <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Compte  dbiter</label>
                    <select value={form.compteDebiter} onChange={e => setForm({...form, compteDebiter: e.target.value})} style={styles.input}>
                      <option value="BAILLEUR">BAILLEUR</option>
                      <option value="TRESOR">TRESOR</option>
                    </select>
                  </div>
                </div>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Description (pour les documents)</label>
                  <textarea value={form.description || ''} onChange={e => setForm({...form, description: e.target.value})} style={{ ...styles.input, minHeight: 80, resize: 'vertical' }} placeholder="Ex: Financement Groupe Banque Mondiale : Projet N TF0B8829-CI" />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Couleur</label>
                  <input type="color" value={form.couleur} onChange={e => setForm({...form, couleur: e.target.value})} style={{ width: 60, height: 40, border: 'none', borderRadius: 8, cursor: 'pointer' }} />
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => setShowModal(false)} style={styles.buttonSecondary}>Annuler</button>
                <button onClick={handleSave} style={styles.button}> Enregistrer</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Tab Exercices
  const TabExercices = () => {
    const [showModal, setShowModal] = useState(false);
    const [form, setForm] = useState({ annee: new Date().getFullYear(), actif: true });

    const handleSave = async () => {
      try {
        // Si actif, dsactiver les autres
        if (form.actif) {
          for (const ex of exercices.filter(e => e.actif)) {
            await updateDoc(doc(db, 'exercices', ex.id), { actif: false });
          }
        }
        const docRef = await addDoc(collection(db, 'exercices'), form);
        const newExercices = exercices.map(e => form.actif ? { ...e, actif: false } : e);
        setExercices([{ id: docRef.id, ...form }, ...newExercices].sort((a, b) => b.annee - a.annee));
        setShowModal(false);
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
      }
    };

    const setActif = async (exercice) => {
      try {
        for (const ex of exercices) {
          await updateDoc(doc(db, 'exercices', ex.id), { actif: ex.id === exercice.id });
        }
        setExercices(exercices.map(e => ({ ...e, actif: e.id === exercice.id })));
      } catch (error) {
        console.error('Erreur:', error);
      }
    };

    return (
      <div>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
          <p style={{ color: '#6c757d', margin: 0 }}>{exercices.length} exercice(s)</p>
          <button onClick={() => { setForm({ annee: new Date().getFullYear() + 1, actif: false }); setShowModal(true); }} style={styles.button}> Nouvel exercice</button>
        </div>

        <div style={styles.card}>
          {exercices.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#6c757d', padding: 40 }}>Aucun exercice</p>
          ) : (
            <table style={styles.table}>
              <thead>
                <tr>
                  <th style={styles.th}>ANNE</th>
                  <th style={styles.th}>STATUT</th>
                  <th style={{ ...styles.th, textAlign: 'center' }}>ACTIONS</th>
                </tr>
              </thead>
              <tbody>
                {exercices.map(ex => (
                  <tr key={ex.id}>
                    <td style={styles.td}><strong style={{ fontSize: 18 }}>{ex.annee}</strong></td>
                    <td style={styles.td}>
                      <span style={{ ...styles.badge, background: ex.actif ? '#e8f5e9' : '#f5f5f5', color: ex.actif ? '#2e7d32' : '#6c757d' }}>
                        {ex.actif ? ' Actif' : 'Inactif'}
                      </span>
                    </td>
                    <td style={{ ...styles.td, textAlign: 'center' }}>
                      {!ex.actif && (
                        <button onClick={() => setActif(ex)} style={{ ...styles.buttonSecondary, padding: '6px 12px' }}>Dfinir comme actif</button>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
        </div>

        {showModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 400 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#f8f9fa' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}> Nouvel exercice</h2>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Anne</label>
                  <input type="number" value={form.annee} onChange={e => setForm({...form, annee: parseInt(e.target.value)})} style={styles.input} />
                </div>
                <label style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' }}>
                  <input type="checkbox" checked={form.actif} onChange={e => setForm({...form, actif: e.target.checked})} />
                  <span>Dfinir comme exercice actif</span>
                </label>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => setShowModal(false)} style={styles.buttonSecondary}>Annuler</button>
                <button onClick={handleSave} style={styles.button}> Crer</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Tab Lignes budgtaires (Bibliothque de rfrence)
  const TabLignes = () => {
    const [showModal, setShowModal] = useState(false);
    const [showImportModal, setShowImportModal] = useState(false);
    const [form, setForm] = useState({ code: '', libelle: '' });
    const [importData, setImportData] = useState([]);
    const [importing, setImporting] = useState(false);

    const handleSave = async () => {
      if (!form.code || !form.libelle) {
        alert('Veuillez remplir tous les champs');
        return;
      }
      // Vrifier si le code existe dj
      if (lignesBudgetaires.find(l => l.code === form.code)) {
        alert('Ce code existe dj dans la bibliothque');
        return;
      }
      try {
        const docRef = await addDoc(collection(db, 'lignesBudgetaires'), form);
        setLignesBudgetaires([...lignesBudgetaires, { id: docRef.id, ...form }].sort((a, b) => a.code.localeCompare(b.code)));
        setForm({ code: '', libelle: '' });
        setShowModal(false);
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
      }
    };

    const handleDelete = async (ligne) => {
      // Vrifier si la ligne est utilise dans un budget
      const isUsed = budgets.some(b => b.lignes?.some(l => l.code === ligne.code));
      if (isUsed) {
        alert(`Impossible de supprimer cette ligne.\n\nElle est utilise dans un ou plusieurs budgets.`);
        return;
      }
      if (!window.confirm(`Supprimer la ligne "${ligne.code} - ${ligne.libelle}" de la bibliothque ?`)) return;
      try {
        await deleteDoc(doc(db, 'lignesBudgetaires', ligne.id));
        setLignesBudgetaires(lignesBudgetaires.filter(l => l.id !== ligne.id));
      } catch (error) {
        console.error('Erreur:', error);
      }
    };

    // Parser le fichier CSV/Excel
    const handleFileUpload = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const text = event.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        const parsed = [];
        
        // Dtecter le sparateur (virgule ou point-virgule)
        const separator = lines[0].includes(';') ? ';' : ',';
        
        // Ignorer la premire ligne si c'est un en-tte
        const startIndex = lines[0].toLowerCase().includes('code') || lines[0].toLowerCase().includes('ligne') ? 1 : 0;
        
        for (let i = startIndex; i < lines.length; i++) {
          const cols = lines[i].split(separator).map(c => c.trim().replace(/^["']|["']$/g, ''));
          if (cols.length >= 2 && cols[0] && cols[1]) {
            // Vrifier si le code n'existe pas dj
            if (!lignesBudgetaires.find(l => l.code === cols[0]) && !parsed.find(p => p.code === cols[0])) {
              parsed.push({ code: cols[0], libelle: cols[1] });
            }
          }
        }
        
        setImportData(parsed);
      };
      reader.readAsText(file);
    };

    const handleImport = async () => {
      if (importData.length === 0) {
        alert('Aucune ligne  importer');
        return;
      }
      
      setImporting(true);
      try {
        const newLignes = [];
        for (const ligne of importData) {
          const docRef = await addDoc(collection(db, 'lignesBudgetaires'), ligne);
          newLignes.push({ id: docRef.id, ...ligne });
        }
        setLignesBudgetaires([...lignesBudgetaires, ...newLignes].sort((a, b) => a.code.localeCompare(b.code)));
        setShowImportModal(false);
        setImportData([]);
        alert(`${newLignes.length} ligne(s) importe(s) avec succs !`);
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'importation');
      }
      setImporting(false);
    };

    return (
      <div>
        <div style={{ ...styles.card, background: '#e8f5e9', marginBottom: 20 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <span style={{ fontSize: 24 }}></span>
            <div>
              <strong style={{ color: '#2e7d32' }}>Bibliothque de rfrence</strong>
              <p style={{ margin: '4px 0 0', fontSize: 13, color: '#555' }}>
                Ces lignes servent de rfrence pour crer vos budgets. Importez votre nomenclature une fois, puis rutilisez-la.
              </p>
            </div>
          </div>
        </div>

        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
          <p style={{ color: '#6c757d', margin: 0 }}>{lignesBudgetaires.length} ligne(s) dans la bibliothque</p>
          <div style={{ display: 'flex', gap: 12 }}>
            <button onClick={() => setShowImportModal(true)} style={{ ...styles.buttonSecondary, background: '#e3f2fd', color: '#1565c0' }}>
               Importer CSV/Excel
            </button>
            <button onClick={() => setShowModal(true)} style={styles.button}> Nouvelle ligne</button>
          </div>
        </div>

        <div style={styles.card}>
          {lignesBudgetaires.length === 0 ? (
            <div style={{ textAlign: 'center', padding: 40 }}>
              <div style={{ fontSize: 50, marginBottom: 16 }}></div>
              <p style={{ color: '#6c757d', marginBottom: 16 }}>Aucune ligne budgtaire dans la bibliothque</p>
              <p style={{ color: '#adb5bd', fontSize: 13 }}>Importez un fichier CSV ou ajoutez des lignes manuellement</p>
            </div>
          ) : (
            <table style={styles.table}>
              <thead>
                <tr>
                  <th style={styles.th}>CODE</th>
                  <th style={styles.th}>LIBELL</th>
                  <th style={{ ...styles.th, textAlign: 'center' }}>ACTIONS</th>
                </tr>
              </thead>
              <tbody>
                {lignesBudgetaires.map(ligne => {
                  const isUsed = budgets.some(b => b.lignes?.some(l => l.code === ligne.code));
                  return (
                    <tr key={ligne.id}>
                      <td style={styles.td}>
                        <code style={{ background: '#e8f5e9', color: '#2e7d32', padding: '4px 12px', borderRadius: 6, fontWeight: 600 }}>{ligne.code}</code>
                      </td>
                      <td style={styles.td}>{ligne.libelle}</td>
                      <td style={{ ...styles.td, textAlign: 'center' }}>
                        {isUsed ? (
                          <span style={{ ...styles.badge, background: '#f5f5f5', color: '#9e9e9e' }}>Utilise</span>
                        ) : (
                          <button onClick={() => handleDelete(ligne)} style={{ ...styles.buttonSecondary, padding: '6px 12px', background: '#ffebee', color: '#c62828' }}></button>
                        )}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          )}
        </div>

        {/* Modal Nouvelle ligne */}
        {showModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 500 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#f8f9fa' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}> Nouvelle ligne budgtaire</h2>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: 16 }}>
                  <div>
                    <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Code *</label>
                    <input value={form.code} onChange={e => setForm({...form, code: e.target.value})} style={styles.input} placeholder="Ex: 6221" />
                  </div>
                  <div>
                    <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Libell *</label>
                    <input value={form.libelle} onChange={e => setForm({...form, libelle: e.target.value})} style={styles.input} placeholder="Ex: Personnel temporaire" />
                  </div>
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => setShowModal(false)} style={styles.buttonSecondary}>Annuler</button>
                <button onClick={handleSave} style={styles.button}> Ajouter</button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Import */}
        {showImportModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 700 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#1565c0', color: 'white' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}> Importer la nomenclature</h2>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ background: '#e3f2fd', padding: 16, borderRadius: 8, marginBottom: 20 }}>
                  <strong style={{ color: '#1565c0' }}>Format attendu :</strong>
                  <p style={{ margin: '8px 0 0', fontSize: 13, color: '#555' }}>
                    Fichier CSV avec 2 colonnes : <code style={{ background: '#fff', padding: '2px 6px', borderRadius: 4 }}>Code</code> et <code style={{ background: '#fff', padding: '2px 6px', borderRadius: 4 }}>Libell</code>
                    <br />Sparateur : virgule (,) ou point-virgule (;)
                  </p>
                  <p style={{ margin: '8px 0 0', fontSize: 12, color: '#777' }}>
                    Exemple : <code>6221;Personnel temporaire</code>
                  </p>
                </div>

                <div style={{ marginBottom: 20 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Slectionner un fichier CSV</label>
                  <input 
                    type="file" 
                    accept=".csv,.txt"
                    onChange={handleFileUpload}
                    style={{ padding: 10, border: '2px dashed #e9ecef', borderRadius: 8, width: '100%', boxSizing: 'border-box' }}
                  />
                </div>

                {importData.length > 0 && (
                  <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                      <strong style={{ color: '#2e7d32' }}> {importData.length} ligne(s) prte(s)  importer</strong>
                    </div>
                    <div style={{ maxHeight: 250, overflowY: 'auto', border: '1px solid #e9ecef', borderRadius: 8 }}>
                      <table style={styles.table}>
                        <thead>
                          <tr>
                            <th style={{ ...styles.th, position: 'sticky', top: 0 }}>CODE</th>
                            <th style={{ ...styles.th, position: 'sticky', top: 0 }}>LIBELL</th>
                          </tr>
                        </thead>
                        <tbody>
                          {importData.map((ligne, i) => (
                            <tr key={i}>
                              <td style={styles.td}><code style={{ background: '#e8f5e9', color: '#2e7d32', padding: '2px 8px', borderRadius: 4, fontSize: 12 }}>{ligne.code}</code></td>
                              <td style={{ ...styles.td, fontSize: 13 }}>{ligne.libelle}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => { setShowImportModal(false); setImportData([]); }} style={styles.buttonSecondary}>Annuler</button>
                <button 
                  onClick={handleImport} 
                  disabled={importing || importData.length === 0}
                  style={{ 
                    ...styles.button, 
                    background: '#1565c0',
                    opacity: importing || importData.length === 0 ? 0.6 : 1 
                  }}
                >
                  {importing ? 'Importation...' : ` Importer ${importData.length} ligne(s)`}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // ==================== PAGE BNFICIAIRES ====================
  const PageBeneficiaires = () => {
    const [search, setSearch] = useState('');
    const [showModal, setShowModal] = useState(false);
    const [showImportModal, setShowImportModal] = useState(false);
    const [editBen, setEditBen] = useState(null);
    const [form, setForm] = useState({ nom: '', ncc: '', ribs: [] });
    const [newRib, setNewRib] = useState({ banque: '', numero: '' });
    const [importData, setImportData] = useState([]);
    const [importing, setImporting] = useState(false);

    const filtered = beneficiaires.filter(b => 
      b.nom?.toLowerCase().includes(search.toLowerCase()) ||
      b.ncc?.toLowerCase().includes(search.toLowerCase())
    );

    // Fonction utilitaire pour obtenir les RIB (rtrocompatibilit avec ancien format)
    const getRibs = (ben) => {
      if (ben.ribs && ben.ribs.length > 0) return ben.ribs;
      if (ben.rib) return [{ banque: '', numero: ben.rib }];
      return [];
    };

    const openNew = () => {
      setForm({ nom: '', ncc: '', ribs: [] });
      setNewRib({ banque: '', numero: '' });
      setEditBen(null);
      setShowModal(true);
    };

    const openEdit = (ben) => {
      setForm({ 
        nom: ben.nom, 
        ncc: ben.ncc || '', 
        ribs: getRibs(ben)
      });
      setNewRib({ banque: '', numero: '' });
      setEditBen(ben);
      setShowModal(true);
    };

    // Ajouter un RIB
    const addRib = () => {
      if (!newRib.numero.trim()) {
        alert('Veuillez saisir le numro RIB');
        return;
      }
      setForm({ ...form, ribs: [...form.ribs, { banque: newRib.banque.trim(), numero: newRib.numero.trim() }] });
      setNewRib({ banque: '', numero: '' });
    };

    // Supprimer un RIB
    const removeRib = (index) => {
      setForm({ ...form, ribs: form.ribs.filter((_, i) => i !== index) });
    };

    // Import CSV/Excel
    const handleFileUpload = (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const text = event.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        
        // Dtecter le sparateur (virgule, point-virgule, ou tabulation)
        const firstLine = lines[0] || '';
        let separator = ';';
        if (firstLine.includes('\t')) separator = '\t';
        else if (firstLine.split(',').length > firstLine.split(';').length) separator = ',';

        const parsed = [];
        lines.forEach((line, index) => {
          const cols = line.split(separator).map(c => c.trim().replace(/^["']|["']$/g, ''));
          
          // Ignorer l'en-tte si prsent
          if (index === 0) {
            const firstCol = cols[0]?.toLowerCase();
            if (firstCol === 'nom' || firstCol === 'name' || firstCol === 'beneficiaire' || firstCol === 'raison sociale') {
              return;
            }
          }

          if (cols[0]) {
            const nom = cols[0].toUpperCase();
            // Vrifier si le nom existe dj
            const exists = beneficiaires.find(b => b.nom === nom);
            if (!exists) {
              // Convertir ancien format rib en nouveau format ribs
              const ribs = cols[2] ? [{ banque: '', numero: cols[2] }] : [];
              parsed.push({
                nom: nom,
                ncc: cols[1] || '',
                ribs: ribs
              });
            }
          }
        });

        setImportData(parsed);
      };
      reader.readAsText(file);
    };

    const handleImport = async () => {
      if (importData.length === 0) return;
      
      setImporting(true);
      try {
        const newBeneficiaires = [];
        for (const ben of importData) {
          const docRef = await addDoc(collection(db, 'beneficiaires'), ben);
          newBeneficiaires.push({ id: docRef.id, ...ben });
        }
        setBeneficiaires([...beneficiaires, ...newBeneficiaires].sort((a, b) => a.nom.localeCompare(b.nom)));
        setShowImportModal(false);
        setImportData([]);
        alert(`${newBeneficiaires.length} bnficiaire(s) import(s) avec succs`);
      } catch (error) {
        console.error('Erreur import:', error);
        alert('Erreur lors de l\'import');
      }
      setImporting(false);
    };

    const handleSave = async () => {
      if (!form.nom) {
        alert('Le nom est obligatoire');
        return;
      }
      try {
        const dataToSave = {
          nom: form.nom.toUpperCase(),
          ncc: form.ncc || '',
          ribs: form.ribs || []
        };
        
        if (editBen) {
          await updateDoc(doc(db, 'beneficiaires', editBen.id), dataToSave);
          setBeneficiaires(beneficiaires.map(b => b.id === editBen.id ? { ...b, ...dataToSave } : b));
        } else {
          const docRef = await addDoc(collection(db, 'beneficiaires'), dataToSave);
          setBeneficiaires([...beneficiaires, { id: docRef.id, ...dataToSave }].sort((a, b) => a.nom.localeCompare(b.nom)));
        }
        setShowModal(false);
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
      }
    };

    const handleDelete = async (ben) => {
      if (!window.confirm(`Supprimer "${ben.nom}" ?`)) return;
      try {
        await deleteDoc(doc(db, 'beneficiaires', ben.id));
        setBeneficiaires(beneficiaires.filter(b => b.id !== ben.id));
      } catch (error) {
        console.error('Erreur:', error);
      }
    };

    return (
      <div>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
          <h1 style={{ fontSize: 24, fontWeight: 700 }}> Bnficiaires</h1>
          <div style={{ display: 'flex', gap: 12 }}>
            <button onClick={() => setShowImportModal(true)} style={{ ...styles.buttonSecondary, background: '#e3f2fd', color: '#1565c0' }}>
               Importer CSV
            </button>
            <button onClick={openNew} style={styles.button}> Nouveau</button>
          </div>
        </div>

        <div style={{ ...styles.card, padding: 16, marginBottom: 20 }}>
          <input 
            type="text" 
            placeholder=" Rechercher par nom ou NCC..." 
            value={search} 
            onChange={e => setSearch(e.target.value)}
            style={{ ...styles.input, marginBottom: 0 }}
          />
        </div>

        <div style={styles.card}>
          <div style={{ marginBottom: 16, color: '#6c757d', fontSize: 14 }}>{filtered.length} bnficiaire(s)</div>
          {filtered.length === 0 ? (
            <p style={{ textAlign: 'center', color: '#6c757d', padding: 40 }}>Aucun bnficiaire trouv</p>
          ) : (
            <table style={styles.table}>
              <thead>
                <tr>
                  <th style={styles.th}>NOM</th>
                  <th style={styles.th}>NCC</th>
                  <th style={styles.th}>RIB(s)</th>
                  <th style={{ ...styles.th, textAlign: 'center' }}>ACTIONS</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map(ben => {
                  const ribs = getRibs(ben);
                  return (
                    <tr key={ben.id}>
                      <td style={styles.td}><strong>{ben.nom}</strong></td>
                      <td style={styles.td}>{ben.ncc || <span style={{ color: '#adb5bd', fontStyle: 'italic' }}>-</span>}</td>
                      <td style={styles.td}>
                        {ribs.length > 0 ? (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>
                            {ribs.map((rib, i) => (
                              <div key={i} style={{ fontSize: 11 }}>
                                {rib.banque && <span style={{ background: '#e3f2fd', color: '#1565c0', padding: '2px 6px', borderRadius: 4, marginRight: 6, fontWeight: 600 }}>{rib.banque}</span>}
                                <code style={{ background: '#f5f5f5', padding: '2px 6px', borderRadius: 4 }}>{rib.numero}</code>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <span style={{ color: '#adb5bd', fontStyle: 'italic' }}>-</span>
                        )}
                      </td>
                      <td style={{ ...styles.td, textAlign: 'center' }}>
                        <button onClick={() => openEdit(ben)} style={{ ...styles.buttonSecondary, padding: '6px 12px', marginRight: 8 }}></button>
                        <button onClick={() => handleDelete(ben)} style={{ ...styles.buttonSecondary, padding: '6px 12px', background: '#ffebee', color: '#c62828' }}></button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          )}
        </div>

        {showModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 600 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#f8f9fa' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}>{editBen ? ' Modifier' : ' Nouveau bnficiaire'}</h2>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Nom / Raison sociale *</label>
                  <input value={form.nom} onChange={e => setForm({...form, nom: e.target.value})} style={styles.input} placeholder="Ex: SOGEA SATOM" />
                </div>
                <div style={{ marginBottom: 20 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>NCC (Compte Contribuable)</label>
                  <input value={form.ncc || ''} onChange={e => setForm({...form, ncc: e.target.value})} style={styles.input} placeholder="Ex: 1904588 U" />
                </div>
                
                {/* Section RIB */}
                <div style={{ background: '#f8f9fa', padding: 16, borderRadius: 8 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 12 }}>Rfrences bancaires (RIB)</label>
                  
                  {/* Liste des RIB existants */}
                  {form.ribs && form.ribs.length > 0 && (
                    <div style={{ marginBottom: 16 }}>
                      {form.ribs.map((rib, index) => (
                        <div key={index} style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8, background: 'white', padding: 10, borderRadius: 6, border: '1px solid #e9ecef' }}>
                          {rib.banque && (
                            <span style={{ background: '#e3f2fd', color: '#1565c0', padding: '4px 10px', borderRadius: 4, fontWeight: 600, fontSize: 12 }}>
                              {rib.banque}
                            </span>
                          )}
                          <code style={{ flex: 1, fontSize: 12, color: '#333' }}>{rib.numero}</code>
                          <button 
                            type="button"
                            onClick={() => removeRib(index)} 
                            style={{ background: '#ffebee', color: '#c62828', border: 'none', borderRadius: 4, padding: '4px 8px', cursor: 'pointer', fontSize: 12 }}
                          >
                            
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* Formulaire ajout nouveau RIB */}
                  <div style={{ display: 'grid', gridTemplateColumns: '120px 1fr auto', gap: 8, alignItems: 'end' }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Banque</label>
                      <input 
                        value={newRib.banque} 
                        onChange={e => setNewRib({...newRib, banque: e.target.value})} 
                        style={{ ...styles.input, marginBottom: 0, padding: '8px 10px' }} 
                        placeholder="SGBCI" 
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Numro RIB</label>
                      <input 
                        value={newRib.numero} 
                        onChange={e => setNewRib({...newRib, numero: e.target.value})} 
                        style={{ ...styles.input, marginBottom: 0, padding: '8px 10px', fontFamily: 'monospace' }} 
                        placeholder="CI005 01012 012345678901 25" 
                      />
                    </div>
                    <button 
                      type="button"
                      onClick={addRib} 
                      style={{ ...styles.button, padding: '8px 16px' }}
                    >
                      
                    </button>
                  </div>
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => setShowModal(false)} style={styles.buttonSecondary}>Annuler</button>
                <button onClick={handleSave} style={styles.button}> Enregistrer</button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Import Bnficiaires */}
        {showImportModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 700 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#1565c0', color: 'white' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}> Importer des bnficiaires</h2>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ background: '#e3f2fd', padding: 16, borderRadius: 8, marginBottom: 20 }}>
                  <strong style={{ color: '#1565c0' }}> Format attendu (CSV/Excel)</strong>
                  <p style={{ margin: '8px 0 0', fontSize: 13, color: '#555' }}>
                    3 colonnes : <code style={{ background: '#fff', padding: '2px 6px', borderRadius: 4 }}>Nom ; NCC ; RIB</code><br/>
                    <span style={{ fontSize: 12, color: '#6c757d' }}>Sparateur accept : virgule, point-virgule ou tabulation. Les doublons seront ignors.</span>
                  </p>
                </div>

                <div style={{ marginBottom: 20 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 8 }}>Fichier  importer</label>
                  <input 
                    type="file" 
                    accept=".csv,.txt,.xls,.xlsx"
                    onChange={handleFileUpload}
                    style={{ width: '100%', padding: 12, border: '2px dashed #1565c0', borderRadius: 8, cursor: 'pointer' }}
                  />
                </div>

                {importData.length > 0 && (
                  <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                      <strong style={{ color: '#2e7d32' }}> {importData.length} bnficiaire(s)  importer</strong>
                    </div>
                    <div style={{ maxHeight: 250, overflowY: 'auto', border: '1px solid #e9ecef', borderRadius: 8 }}>
                      <table style={styles.table}>
                        <thead>
                          <tr>
                            <th style={{ ...styles.th, fontSize: 11 }}>NOM</th>
                            <th style={{ ...styles.th, fontSize: 11 }}>NCC</th>
                            <th style={{ ...styles.th, fontSize: 11 }}>RIB</th>
                          </tr>
                        </thead>
                        <tbody>
                          {importData.slice(0, 50).map((ben, i) => (
                            <tr key={i}>
                              <td style={{ ...styles.td, fontSize: 12 }}>{ben.nom}</td>
                              <td style={{ ...styles.td, fontSize: 12 }}>{ben.ncc || '-'}</td>
                              <td style={{ ...styles.td, fontSize: 12, fontFamily: 'monospace' }}>
                                {ben.ribs && ben.ribs.length > 0 ? ben.ribs[0].numero : '-'}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                      {importData.length > 50 && (
                        <div style={{ padding: 12, textAlign: 'center', color: '#6c757d', fontSize: 12 }}>
                          ... et {importData.length - 50} autre(s)
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => { setShowImportModal(false); setImportData([]); }} style={styles.buttonSecondary}>Annuler</button>
                <button 
                  onClick={handleImport} 
                  disabled={importing || importData.length === 0}
                  style={{ 
                    ...styles.button, 
                    background: '#1565c0',
                    opacity: importing || importData.length === 0 ? 0.6 : 1 
                  }}
                >
                  {importing ? 'Import en cours...' : ` Importer ${importData.length} bnficiaire(s)`}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // ==================== PAGE BUDGET ====================
  const PageBudget = () => {
    // Utiliser la source globale ou la premire source par dfaut
    const activeSource = activeBudgetSource || sources[0]?.id || null;
    const setActiveSource = (sourceId) => setActiveBudgetSource(sourceId);
    
    const [showAnterieur, setShowAnterieur] = useState(false);
    const [selectedExercice, setSelectedExercice] = useState(exerciceActif?.id || null);
    const [showModal, setShowModal] = useState(false);
    const [showPasswordModal, setShowPasswordModal] = useState(false);
    const [showRevisionModal, setShowRevisionModal] = useState(false);
    const [selectedLigne, setSelectedLigne] = useState('');
    const [budgetLignes, setBudgetLignes] = useState([]);
    const [saving, setSaving] = useState(false);
    const [password, setPassword] = useState('');
    const [motifRevision, setMotifRevision] = useState('');
    const [selectedVersion, setSelectedVersion] = useState(null);

    const PASSWORD_CORRECTION = 'admin';

    // Obtenir le budget actuel pour la source et l'exercice slectionns
    const currentExerciceId = showAnterieur ? selectedExercice : exerciceActif?.id;
    const currentExerciceObj = exercices.find(e => e.id === currentExerciceId);
    const currentSourceObj = sources.find(s => s.id === activeSource);

    // Obtenir tous les budgets pour cette source/exercice (toutes versions)
    const allBudgetsForSourceExercice = budgets
      .filter(b => b.sourceId === activeSource && b.exerciceId === currentExerciceId)
      .sort((a, b) => (b.version || 1) - (a.version || 1));

    // Budget actif = dernire version
    const currentBudget = selectedVersion 
      ? allBudgetsForSourceExercice.find(b => b.id === selectedVersion)
      : allBudgetsForSourceExercice[0];
    
    const latestVersion = allBudgetsForSourceExercice[0];
    const isLatestVersion = !selectedVersion || selectedVersion === latestVersion?.id;

    // Calculer les engagements par ligne (depuis les OP)
    const getEngagementLigne = (ligneCode) => {
      return ops
        .filter(op => 
          op.sourceId === activeSource && 
          op.exerciceId === currentExerciceId &&
          op.ligneBudgetaire === ligneCode &&
          ['DIRECT', 'DEFINITIF', 'PROVISOIRE'].includes(op.type) &&
          op.statut !== 'REJETE' &&
          op.statut !== 'ANNULE'
        )
        .reduce((sum, op) => sum + (op.montant || 0), 0);
    };

    // Ouvrir modal cration (budget initial)
    const openCreateModal = () => {
      setBudgetLignes([]);
      setSelectedLigne('');
      setShowModal(true);
    };

    // Ouvrir modal correction (avec mot de passe)
    const openCorrectionModal = () => {
      setPassword('');
      setShowPasswordModal(true);
    };

    // Vrifier mot de passe et ouvrir dition
    const verifyPasswordAndEdit = () => {
      if (password === PASSWORD_CORRECTION) {
        setShowPasswordModal(false);
        setBudgetLignes(currentBudget.lignes.map(l => ({ ...l })));
        setSelectedLigne('');
        setShowModal(true);
      } else {
        alert('Mot de passe incorrect');
      }
    };

    // Ouvrir modal nouvelle rvision
    const openRevisionModal = () => {
      setMotifRevision('');
      setShowRevisionModal(true);
    };

    // Crer une nouvelle rvision
    const createRevision = async () => {
      if (!motifRevision.trim()) {
        alert('Veuillez indiquer le motif de la rvision');
        return;
      }

      setSaving(true);
      try {
        const newVersion = (latestVersion?.version || 1) + 1;
        const revisionData = {
          sourceId: activeSource,
          exerciceId: currentExerciceId,
          version: newVersion,
          lignes: latestVersion.lignes.map(l => ({ ...l })),
          motifRevision: motifRevision.trim(),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };

        const docRef = await addDoc(collection(db, 'budgets'), revisionData);
        setBudgets([...budgets, { id: docRef.id, ...revisionData }]);
        setShowRevisionModal(false);
        
        // Ouvrir l'dition de la nouvelle version
        setBudgetLignes(revisionData.lignes);
        setSelectedLigne('');
        setSelectedVersion(docRef.id);
        setShowModal(true);
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la cration de la rvision');
      }
      setSaving(false);
    };

    // Ajouter une ligne au budget (depuis le select)
    const addLigne = () => {
      if (!selectedLigne) return;
      const ligne = lignesBudgetaires.find(l => l.code === selectedLigne);
      if (!ligne) return;
      if (budgetLignes.find(l => l.code === ligne.code)) {
        alert('Cette ligne existe dj dans le budget');
        return;
      }
      setBudgetLignes([...budgetLignes, { code: ligne.code, libelle: ligne.libelle, dotation: 0 }]);
      setSelectedLigne('');
    };

    // Supprimer une ligne du budget
    const removeLigne = (code) => {
      const engagement = getEngagementLigne(code);
      if (engagement > 0) {
        alert(`Impossible de supprimer cette ligne.\n\nElle a des engagements de ${formatMontant(engagement)} FCFA.\n\nVous devez d'abord supprimer ou modifier les OP imputs sur cette ligne.`);
        return;
      }
      setBudgetLignes(budgetLignes.filter(l => l.code !== code));
    };

    // Modifier la dotation d'une ligne
    const updateDotation = (code, dotation) => {
      const engagement = getEngagementLigne(code);
      const newDotation = parseInt(dotation) || 0;
      
      if (newDotation < engagement) {
        alert(` Attention\n\nLa dotation (${formatMontant(newDotation)}) est infrieure aux engagements (${formatMontant(engagement)}).\n\nCela crera un disponible ngatif.`);
      }
      
      setBudgetLignes(budgetLignes.map(l => 
        l.code === code ? { ...l, dotation: newDotation } : l
      ));
    };

    // Sauvegarder le budget
    const handleSave = async () => {
      if (budgetLignes.length === 0) {
        alert('Veuillez ajouter au moins une ligne budgtaire');
        return;
      }

      setSaving(true);
      try {
        const budgetData = {
          sourceId: activeSource,
          exerciceId: currentExerciceId,
          lignes: budgetLignes,
          updatedAt: new Date().toISOString()
        };

        if (currentBudget && isLatestVersion) {
          // Mise  jour (correction)
          await updateDoc(doc(db, 'budgets', currentBudget.id), budgetData);
          setBudgets(budgets.map(b => b.id === currentBudget.id ? { ...b, ...budgetData } : b));
        } else if (!currentBudget) {
          // Cration budget initial
          budgetData.version = 1;
          budgetData.createdAt = new Date().toISOString();
          const docRef = await addDoc(collection(db, 'budgets'), budgetData);
          setBudgets([...budgets, { id: docRef.id, ...budgetData }]);
        }

        setShowModal(false);
        setSelectedVersion(null);
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde');
      }
      setSaving(false);
    };

    // Calculer les totaux
    const getTotaux = (budget) => {
      if (!budget || !budget.lignes) return { dotation: 0, engagement: 0, disponible: 0 };
      
      let totalDotation = 0;
      let totalEngagement = 0;

      budget.lignes.forEach(ligne => {
        totalDotation += ligne.dotation || 0;
        totalEngagement += getEngagementLigne(ligne.code);
      });

      return {
        dotation: totalDotation,
        engagement: totalEngagement,
        disponible: totalDotation - totalEngagement
      };
    };

    const totaux = getTotaux(currentBudget);

    // Lignes disponibles (de la bibliothque, non encore dans le budget)
    const lignesDisponibles = lignesBudgetaires.filter(l => 
      !budgetLignes.find(bl => bl.code === l.code)
    );

    // Label de version
    const getVersionLabel = (budget) => {
      if (!budget) return '';
      const v = budget.version || 1;
      if (v === 1) return 'Budget Initial (v1)';
      return `Rvision ${v - 1} (v${v})`;
    };

    // Export du suivi budgtaire
    const exportSuiviBudgetaire = () => {
      if (!currentBudget || !currentBudget.lignes) return;

      const now = new Date().toLocaleDateString('fr-FR');
      let csv = `SUIVI BUDGETAIRE - ${currentSourceObj?.nom || ''}\n`;
      csv += `Exercice: ${currentExerciceObj?.annee || ''}\n`;
      csv += `Version: ${getVersionLabel(currentBudget)}\n`;
      csv += `Date d'export: ${now}\n\n`;
      
      csv += `Code;Libell;Dotation;Engagements;Disponible;Taux (%)\n`;
      
      currentBudget.lignes.forEach(ligne => {
        const engagement = getEngagementLigne(ligne.code);
        const disponible = (ligne.dotation || 0) - engagement;
        const taux = ligne.dotation > 0 ? ((engagement / ligne.dotation) * 100).toFixed(1) : '0';
        csv += `${ligne.code};${ligne.libelle};${ligne.dotation || 0};${engagement};${disponible};${taux}\n`;
      });
      
      csv += `\nTOTAL;;${totaux.dotation};${totaux.engagement};${totaux.disponible};${totaux.dotation > 0 ? ((totaux.engagement / totaux.dotation) * 100).toFixed(1) : '0'}\n`;

      const filename = `Suivi_Budget_${currentSourceObj?.sigle || 'Source'}_${currentExerciceObj?.annee || ''}_v${currentBudget.version || 1}.csv`;
      exportToCSV(csv, filename);
    };

    return (
      <div>
        <h1 style={{ fontSize: 24, fontWeight: 700, marginBottom: 24 }}> Budget</h1>
        
        {/* Onglets Sources */}
        <div style={styles.sourceTabs}>
          {sources.length === 0 ? (
            <div style={{ color: '#6c757d', fontSize: 14 }}>
              Aucune source configure. <span style={{ color: '#0f4c3a', cursor: 'pointer', textDecoration: 'underline' }} onClick={() => setCurrentPage('parametres')}>Configurer les sources</span>
            </div>
          ) : (
            sources.map(source => (
              <div
                key={source.id}
                onClick={() => { setActiveSource(source.id); setSelectedVersion(null); }}
                style={activeSource === source.id 
                  ? { ...styles.sourceTabActive, background: source.couleur || '#0f4c3a', borderColor: source.couleur || '#0f4c3a' }
                  : styles.sourceTab
                }
              >
                {source.sigle || source.nom}
              </div>
            ))
          )}
        </div>

        {sources.length > 0 && activeSource && (
          <>
            {/* Slection exercice + Version */}
            <div style={{ ...styles.card, padding: 16 }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: 16 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 16, flexWrap: 'wrap' }}>
                  <div>
                    <span style={{ fontSize: 13, color: '#6c757d' }}>Exercice : </span>
                    <strong style={{ fontSize: 18, color: '#0f4c3a' }}>{currentExerciceObj?.annee || 'Non dfini'}</strong>
                    {!showAnterieur && exerciceActif && <span style={{ ...styles.badge, background: '#e8f5e9', color: '#2e7d32', marginLeft: 8 }}>Actif</span>}
                  </div>
                  
                  <label style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer', fontSize: 13 }}>
                    <input 
                      type="checkbox" 
                      checked={showAnterieur} 
                      onChange={(e) => {
                        setShowAnterieur(e.target.checked);
                        if (!e.target.checked) setSelectedExercice(exerciceActif?.id);
                        setSelectedVersion(null);
                      }}
                    />
                    Consulter exercices antrieurs
                  </label>

                  {showAnterieur && (
                    <select 
                      value={selectedExercice || ''} 
                      onChange={(e) => { setSelectedExercice(e.target.value); setSelectedVersion(null); }}
                      style={{ padding: '8px 12px', borderRadius: 6, border: '2px solid #e9ecef', fontSize: 14 }}
                    >
                      {exercices.map(ex => (
                        <option key={ex.id} value={ex.id}>{ex.annee}{ex.actif ? ' (actif)' : ''}</option>
                      ))}
                    </select>
                  )}
                </div>

                {/* Boutons actions */}
                {!showAnterieur && exerciceActif && (
                  <div style={{ display: 'flex', gap: 8 }}>
                    {!currentBudget ? (
                      <button onClick={openCreateModal} style={styles.button}>
                         Crer le budget initial
                      </button>
                    ) : (
                      <>
                        <button onClick={openCorrectionModal} style={{ ...styles.buttonSecondary, background: '#fff3e0', color: '#e65100' }}>
                           Correction
                        </button>
                        <button onClick={openRevisionModal} style={styles.button}>
                           Nouvelle rvision
                        </button>
                      </>
                    )}
                  </div>
                )}
              </div>

              {/* Affichage version actuelle */}
              {currentBudget && (
                <div style={{ marginTop: 16, paddingTop: 16, borderTop: '1px solid #e9ecef', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <span style={{ ...styles.badge, background: currentSourceObj?.couleur || '#0f4c3a', color: 'white', fontSize: 13 }}>
                      {getVersionLabel(currentBudget)}
                    </span>
                    {!isLatestVersion && (
                      <span style={{ ...styles.badge, background: '#ffebee', color: '#c62828' }}> Version archive</span>
                    )}
                    {currentBudget.motifRevision && (
                      <span style={{ fontSize: 13, color: '#6c757d', fontStyle: 'italic' }}>
                        "{currentBudget.motifRevision}"
                      </span>
                    )}
                  </div>
                  
                  {allBudgetsForSourceExercice.length > 1 && (
                    <button onClick={() => {
                      setHistoriqueParams({ sourceId: activeSource, exerciceId: currentExerciceId });
                      setCurrentPage('historique');
                    }} style={{ ...styles.buttonSecondary, padding: '6px 12px', fontSize: 12 }}>
                       Historique ({allBudgetsForSourceExercice.length} versions)
                    </button>
                  )}
                </div>
              )}
            </div>

            {/* Stats rapides */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16, marginBottom: 20 }}>
              <div style={styles.card}>
                <div style={{ fontSize: 12, color: '#6c757d', marginBottom: 4 }}> Dotation totale</div>
                <div style={{ fontSize: 22, fontWeight: 700, color: currentSourceObj?.couleur || '#0f4c3a', fontFamily: 'monospace' }}>
                  {formatMontant(totaux.dotation)}
                </div>
              </div>
              <div style={styles.card}>
                <div style={{ fontSize: 12, color: '#6c757d', marginBottom: 4 }}> Engagements</div>
                <div style={{ fontSize: 22, fontWeight: 700, color: '#f0b429', fontFamily: 'monospace' }}>
                  {formatMontant(totaux.engagement)}
                </div>
              </div>
              <div style={styles.card}>
                <div style={{ fontSize: 12, color: '#6c757d', marginBottom: 4 }}> Disponible</div>
                <div style={{ fontSize: 22, fontWeight: 700, color: totaux.disponible >= 0 ? '#06d6a0' : '#dc3545', fontFamily: 'monospace' }}>
                  {formatMontant(totaux.disponible)}
                </div>
              </div>
            </div>

            {/* Tableau du budget */}
            <div style={styles.card}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                <h3 style={{ fontSize: 16, fontWeight: 600, margin: 0 }}>
                  Lignes budgtaires - {currentSourceObj?.nom} ({currentExerciceObj?.annee})
                </h3>
                {currentBudget && currentBudget.lignes && currentBudget.lignes.length > 0 && (
                  <button onClick={exportSuiviBudgetaire} style={{ ...styles.buttonSecondary, padding: '8px 16px', fontSize: 12, background: '#e3f2fd', color: '#1565c0' }}>
                     Exporter Excel
                  </button>
                )}
              </div>

              {!currentBudget || !currentBudget.lignes || currentBudget.lignes.length === 0 ? (
                <div style={{ textAlign: 'center', padding: 40, color: '#6c757d' }}>
                  <div style={{ fontSize: 50, marginBottom: 16 }}></div>
                  <p>Aucun budget dfini pour cette source et cet exercice</p>
                  {lignesBudgetaires.length === 0 && (
                    <p style={{ fontSize: 13, color: '#adb5bd', marginTop: 8 }}>
                       Vous devez d'abord importer vos lignes budgtaires dans les <span style={{ color: '#0f4c3a', cursor: 'pointer', textDecoration: 'underline' }} onClick={() => setCurrentPage('parametres')}>Paramtres</span>
                    </p>
                  )}
                  {!showAnterieur && exerciceActif && lignesBudgetaires.length > 0 && (
                    <button onClick={openCreateModal} style={{ ...styles.button, marginTop: 16 }}>
                       Crer le budget initial
                    </button>
                  )}
                </div>
              ) : (
                <table style={styles.table}>
                  <thead>
                    <tr>
                      <th style={styles.th}>CODE</th>
                      <th style={styles.th}>LIBELL</th>
                      <th style={{ ...styles.th, textAlign: 'right' }}>DOTATION</th>
                      <th style={{ ...styles.th, textAlign: 'right' }}>ENGAGEMENTS</th>
                      <th style={{ ...styles.th, textAlign: 'right' }}>DISPONIBLE</th>
                      <th style={{ ...styles.th, textAlign: 'center' }}>TAUX</th>
                    </tr>
                  </thead>
                  <tbody>
                    {currentBudget.lignes.map(ligne => {
                      const engagement = getEngagementLigne(ligne.code);
                      const disponible = (ligne.dotation || 0) - engagement;
                      const taux = ligne.dotation > 0 ? ((engagement / ligne.dotation) * 100).toFixed(1) : 0;
                      
                      return (
                        <tr key={ligne.code}>
                          <td style={styles.td}>
                            <code style={{ background: currentSourceObj?.couleur || '#0f4c3a', color: 'white', padding: '4px 10px', borderRadius: 6, fontWeight: 600, fontSize: 12 }}>
                              {ligne.code}
                            </code>
                          </td>
                          <td style={styles.td}>{ligne.libelle}</td>
                          <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', fontWeight: 600 }}>
                            {formatMontant(ligne.dotation)}
                          </td>
                          <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', color: '#f0b429' }}>
                            {formatMontant(engagement)}
                          </td>
                          <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', fontWeight: 600, color: disponible >= 0 ? '#06d6a0' : '#dc3545' }}>
                            {formatMontant(disponible)}
                          </td>
                          <td style={{ ...styles.td, textAlign: 'center' }}>
                            <div style={{ 
                              background: taux >= 100 ? '#ffebee' : taux >= 80 ? '#fff3e0' : '#e8f5e9',
                              color: taux >= 100 ? '#c62828' : taux >= 80 ? '#e65100' : '#2e7d32',
                              padding: '4px 10px',
                              borderRadius: 12,
                              fontSize: 12,
                              fontWeight: 600,
                              display: 'inline-block'
                            }}>
                              {taux}%
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                  <tfoot>
                    <tr style={{ background: '#f8f9fa', fontWeight: 600 }}>
                      <td colSpan={2} style={{ ...styles.td, fontWeight: 700 }}>TOTAL</td>
                      <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', fontWeight: 700 }}>
                        {formatMontant(totaux.dotation)}
                      </td>
                      <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', color: '#f0b429', fontWeight: 700 }}>
                        {formatMontant(totaux.engagement)}
                      </td>
                      <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', color: totaux.disponible >= 0 ? '#06d6a0' : '#dc3545', fontWeight: 700 }}>
                        {formatMontant(totaux.disponible)}
                      </td>
                      <td style={{ ...styles.td, textAlign: 'center' }}>
                        <div style={{ 
                          background: '#e3f2fd',
                          color: '#1565c0',
                          padding: '4px 10px',
                          borderRadius: 12,
                          fontSize: 12,
                          fontWeight: 600,
                          display: 'inline-block'
                        }}>
                          {totaux.dotation > 0 ? ((totaux.engagement / totaux.dotation) * 100).toFixed(1) : 0}%
                        </div>
                      </td>
                    </tr>
                  </tfoot>
                </table>
              )}
            </div>
          </>
        )}

        {/* Modal Cration/Modification Budget */}
        {showModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 800 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: currentSourceObj?.couleur || '#0f4c3a', color: 'white' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}>
                  {currentBudget ? ` Modifier - ${getVersionLabel(currentBudget)}` : ' Crer le budget initial'} - {currentSourceObj?.nom} ({currentExerciceObj?.annee})
                </h2>
              </div>
              
              <div style={{ padding: 24 }}>
                {/* Ajouter une ligne via Autocomplete */}
                <div style={{ marginBottom: 20 }}>
                  <label style={{ display: 'block', fontSize: 13, fontWeight: 600, marginBottom: 8 }}>
                     Ajouter une ligne depuis la bibliothque
                  </label>
                  <div style={{ display: 'flex', gap: 12 }}>
                    <div style={{ flex: 1 }}>
                      <Autocomplete
                        options={lignesDisponibles.map(ligne => ({
                          value: ligne.code,
                          label: `${ligne.code} - ${ligne.libelle}`,
                          searchFields: [ligne.code, ligne.libelle]
                        }))}
                        value={selectedLigne ? 
                          lignesDisponibles.filter(x => x.code === selectedLigne).map(l => ({
                            value: l.code,
                            label: `${l.code} - ${l.libelle}`
                          }))[0] || null
                        : null}
                        onChange={(option) => setSelectedLigne(option?.value || '')}
                        placeholder=" Rechercher par code ou libell..."
                        noOptionsMessage="Aucune ligne disponible"
                        accentColor={currentSourceObj?.couleur || '#0f4c3a'}
                      />
                    </div>
                    <button 
                      onClick={addLigne} 
                      disabled={!selectedLigne}
                      style={{ 
                        ...styles.button, 
                        opacity: selectedLigne ? 1 : 0.5,
                        cursor: selectedLigne ? 'pointer' : 'not-allowed'
                      }}
                    >
                       Ajouter
                    </button>
                  </div>
                  {lignesBudgetaires.length === 0 && (
                    <p style={{ fontSize: 12, color: '#c62828', marginTop: 8 }}>
                       Aucune ligne dans la bibliothque. <span style={{ textDecoration: 'underline', cursor: 'pointer' }} onClick={() => { setShowModal(false); setCurrentPage('parametres'); }}>Importer des lignes</span>
                    </p>
                  )}
                </div>

                {/* Lignes du budget */}
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 13, fontWeight: 600, marginBottom: 8 }}>
                    Lignes du budget ({budgetLignes.length})
                  </label>
                  
                  {budgetLignes.length === 0 ? (
                    <div style={{ padding: 24, background: '#f8f9fa', borderRadius: 8, textAlign: 'center', color: '#6c757d' }}>
                      Aucune ligne ajoute. Slectionnez une ligne dans la liste ci-dessus.
                    </div>
                  ) : (
                    <div style={{ background: '#f8f9fa', borderRadius: 8, overflow: 'hidden' }}>
                      <table style={styles.table}>
                        <thead>
                          <tr>
                            <th style={{ ...styles.th, width: 100 }}>CODE</th>
                            <th style={styles.th}>LIBELL</th>
                            <th style={{ ...styles.th, width: 180 }}>DOTATION (FCFA)</th>
                            <th style={{ ...styles.th, width: 120, textAlign: 'right' }}>ENGAG</th>
                            <th style={{ ...styles.th, width: 60 }}></th>
                          </tr>
                        </thead>
                        <tbody>
                          {budgetLignes.map(ligne => {
                            const engagement = getEngagementLigne(ligne.code);
                            return (
                              <tr key={ligne.code}>
                                <td style={styles.td}>
                                  <code style={{ background: currentSourceObj?.couleur || '#0f4c3a', color: 'white', padding: '3px 8px', borderRadius: 4, fontSize: 11 }}>
                                    {ligne.code}
                                  </code>
                                </td>
                                <td style={{ ...styles.td, fontSize: 13 }}>{ligne.libelle}</td>
                                <td style={styles.td}>
                                  <input
                                    type="number"
                                    value={ligne.dotation || ''}
                                    onChange={(e) => updateDotation(ligne.code, e.target.value)}
                                    placeholder="0"
                                    style={{ 
                                      width: '100%', 
                                      padding: '8px 10px', 
                                      border: '2px solid #e9ecef', 
                                      borderRadius: 6, 
                                      fontFamily: 'monospace',
                                      textAlign: 'right',
                                      fontSize: 14,
                                      boxSizing: 'border-box'
                                    }}
                                  />
                                </td>
                                <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', color: engagement > 0 ? '#f0b429' : '#adb5bd', fontSize: 13 }}>
                                  {formatMontant(engagement)}
                                </td>
                                <td style={{ ...styles.td, textAlign: 'center' }}>
                                  <button
                                    onClick={() => removeLigne(ligne.code)}
                                    title={engagement > 0 ? 'Impossible de supprimer (engagements existants)' : 'Supprimer'}
                                    style={{ 
                                      padding: '4px 8px', 
                                      background: engagement > 0 ? '#f5f5f5' : '#ffebee', 
                                      color: engagement > 0 ? '#bdbdbd' : '#c62828', 
                                      border: 'none', 
                                      borderRadius: 4, 
                                      cursor: engagement > 0 ? 'not-allowed' : 'pointer',
                                      fontSize: 14
                                    }}
                                  >
                                    
                                  </button>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                        <tfoot>
                          <tr style={{ background: '#e9ecef' }}>
                            <td colSpan={2} style={{ ...styles.td, fontWeight: 700 }}>TOTAL</td>
                            <td style={{ ...styles.td, fontFamily: 'monospace', fontWeight: 700, textAlign: 'right', paddingRight: 16 }}>
                              {formatMontant(budgetLignes.reduce((sum, l) => sum + (l.dotation || 0), 0))}
                            </td>
                            <td style={{ ...styles.td, fontFamily: 'monospace', color: '#f0b429', textAlign: 'right' }}>
                              {formatMontant(budgetLignes.reduce((sum, l) => sum + getEngagementLigne(l.code), 0))}
                            </td>
                            <td></td>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  )}
                </div>
              </div>

              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => { setShowModal(false); setSelectedVersion(null); }} style={styles.buttonSecondary}>Annuler</button>
                <button 
                  onClick={handleSave} 
                  disabled={saving || budgetLignes.length === 0}
                  style={{ 
                    ...styles.button, 
                    background: currentSourceObj?.couleur || '#0f4c3a',
                    opacity: saving || budgetLignes.length === 0 ? 0.6 : 1,
                    cursor: saving || budgetLignes.length === 0 ? 'not-allowed' : 'pointer'
                  }}
                >
                  {saving ? 'Enregistrement...' : ' Enregistrer'}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Mot de passe */}
        {showPasswordModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 400 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#e65100', color: 'white' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}> Correction du budget</h2>
              </div>
              <div style={{ padding: 24 }}>
                <p style={{ marginBottom: 16, color: '#555' }}>
                  Vous allez modifier le budget actuel. Cette action ncessite un mot de passe administrateur.
                </p>
                <div>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Mot de passe</label>
                  <input 
                    type="password" 
                    value={password} 
                    onChange={(e) => setPassword(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && verifyPasswordAndEdit()}
                    placeholder="Entrez le mot de passe"
                    style={styles.input}
                    autoFocus
                  />
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => setShowPasswordModal(false)} style={styles.buttonSecondary}>Annuler</button>
                <button onClick={verifyPasswordAndEdit} style={{ ...styles.button, background: '#e65100' }}> Valider</button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Nouvelle rvision */}
        {showRevisionModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 500 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: currentSourceObj?.couleur || '#0f4c3a', color: 'white' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}> Crer une nouvelle rvision</h2>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ background: '#fff3e0', padding: 16, borderRadius: 8, marginBottom: 20 }}>
                  <strong style={{ color: '#e65100' }}> Information importante</strong>
                  <p style={{ margin: '8px 0 0', fontSize: 13, color: '#555' }}>
                    Une nouvelle rvision (v{(latestVersion?.version || 1) + 1}) sera cre. 
                    La version actuelle ({getVersionLabel(latestVersion)}) sera archive et ne pourra plus tre modifie.
                  </p>
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Motif de la rvision *</label>
                  <textarea 
                    value={motifRevision} 
                    onChange={(e) => setMotifRevision(e.target.value)}
                    placeholder="Ex: Augmentation suite avenant, Report exercice N-1, etc."
                    style={{ ...styles.input, minHeight: 80, resize: 'vertical' }}
                  />
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => setShowRevisionModal(false)} style={styles.buttonSecondary}>Annuler</button>
                <button 
                  onClick={() => {
                    if (!motifRevision.trim()) {
                      alert('Le motif de la rvision est obligatoire');
                      return;
                    }
                    createRevision();
                  }} 
                  disabled={saving || !motifRevision.trim()}
                  style={{ 
                    ...styles.button, 
                    background: currentSourceObj?.couleur || '#0f4c3a',
                    opacity: saving || !motifRevision.trim() ? 0.6 : 1,
                    cursor: saving || !motifRevision.trim() ? 'not-allowed' : 'pointer'
                  }}
                >
                  {saving ? 'Cration...' : ' Crer la rvision'}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // ==================== PAGE HISTORIQUE BUDGET ====================
  const PageHistoriqueBudget = () => {
    const { sourceId, exerciceId } = historiqueParams;
    
    const currentSourceObj = sources.find(s => s.id === sourceId);
    const currentExerciceObj = exercices.find(e => e.id === exerciceId);
    
    // Obtenir tous les budgets pour cette source/exercice
    const allBudgetsForSourceExercice = budgets
      .filter(b => b.sourceId === sourceId && b.exerciceId === exerciceId)
      .sort((a, b) => (a.version || 1) - (b.version || 1)); // Trier par version croissante
    
    const latestVersion = allBudgetsForSourceExercice[allBudgetsForSourceExercice.length - 1];

    // Calculer les totaux d'un budget
    const getTotaux = (budget) => {
      if (!budget || !budget.lignes) return { dotation: 0 };
      return {
        dotation: budget.lignes.reduce((sum, l) => sum + (l.dotation || 0), 0)
      };
    };

    // Label de version
    const getVersionLabel = (budget) => {
      if (!budget) return '';
      const v = budget.version || 1;
      if (v === 1) return 'Budget Initial';
      return `V${v}`;
    };

    // Export de l'historique
    const exportHistorique = () => {
      if (allBudgetsForSourceExercice.length === 0) return;

      const now = new Date().toLocaleDateString('fr-FR');
      let csv = `HISTORIQUE DES VERSIONS BUDGETAIRES - ${currentSourceObj?.nom || ''}\n`;
      csv += `Exercice: ${currentExerciceObj?.annee || ''}\n`;
      csv += `Date d'export: ${now}\n\n`;
      
      // En-tte avec dates
      csv += `DATE;`;
      allBudgetsForSourceExercice.forEach(budget => {
        csv += `${budget.createdAt ? new Date(budget.createdAt).toLocaleDateString('fr-FR') : '-'};`;
      });
      csv += `\n`;

      // En-tte avec versions
      csv += `LIGNE;`;
      allBudgetsForSourceExercice.forEach((budget, index) => {
        csv += `${getVersionLabel(budget)}${index > 0 ? ' (variation)' : ''};`;
      });
      csv += `DOTATION FINALE\n`;

      // Collecter toutes les lignes
      const allLignes = new Map();
      allBudgetsForSourceExercice.forEach(budget => {
        (budget.lignes || []).forEach(ligne => {
          if (!allLignes.has(ligne.code)) {
            allLignes.set(ligne.code, ligne.libelle);
          }
        });
      });

      // Lignes de donnes
      Array.from(allLignes.keys()).sort().forEach(code => {
        csv += `${code};`;
        
        let prevDotation = 0;
        allBudgetsForSourceExercice.forEach((budget, index) => {
          const ligne = (budget.lignes || []).find(l => l.code === code);
          const dotation = ligne?.dotation || 0;
          
          if (index === 0) {
            csv += `${dotation};`;
          } else {
            const variation = dotation - prevDotation;
            csv += `${variation === 0 ? '' : (variation > 0 ? '+' : '') + variation};`;
          }
          prevDotation = dotation;
        });
        
        // Dotation finale
        const lastBudget = allBudgetsForSourceExercice[allBudgetsForSourceExercice.length - 1];
        const lastLigne = (lastBudget?.lignes || []).find(l => l.code === code);
        csv += `${lastLigne?.dotation || 0}\n`;
      });

      // Ligne total
      csv += `TOTAL;`;
      let prevTotal = 0;
      allBudgetsForSourceExercice.forEach((budget, index) => {
        const total = (budget.lignes || []).reduce((sum, l) => sum + (l.dotation || 0), 0);
        if (index === 0) {
          csv += `${total};`;
        } else {
          const variation = total - prevTotal;
          csv += `${variation === 0 ? '' : (variation > 0 ? '+' : '') + variation};`;
        }
        prevTotal = total;
      });
      csv += `${getTotaux(latestVersion).dotation}\n`;

      const filename = `Historique_Budget_${currentSourceObj?.sigle || 'Source'}_${currentExerciceObj?.annee || ''}.csv`;
      exportToCSV(csv, filename);
    };

    if (!sourceId || !exerciceId) {
      return (
        <div>
          <button onClick={() => setCurrentPage('budget')} style={{ ...styles.buttonSecondary, marginBottom: 20 }}>
             Retour au budget
          </button>
          <div style={{ textAlign: 'center', padding: 60 }}>
            <p style={{ color: '#6c757d' }}>Aucune donne  afficher</p>
          </div>
        </div>
      );
    }

    return (
      <div>
        {/* En-tte */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 24 }}>
          <div>
            <button onClick={() => setCurrentPage('budget')} style={{ ...styles.buttonSecondary, padding: '8px 16px', marginBottom: 12 }}>
               Retour au budget
            </button>
            <h1 style={{ fontSize: 24, fontWeight: 700, margin: 0 }}> Historique des versions</h1>
            <p style={{ color: '#6c757d', marginTop: 8 }}>
              <span style={{ 
                display: 'inline-block', 
                width: 12, 
                height: 12, 
                borderRadius: '50%', 
                background: currentSourceObj?.couleur || '#0f4c3a',
                marginRight: 8
              }}></span>
              {currentSourceObj?.nom} - Exercice {currentExerciceObj?.annee}
            </p>
          </div>
          <button onClick={exportHistorique} style={{ ...styles.button, background: '#1565c0' }}>
             Exporter Excel
          </button>
        </div>

        {/* Lgende des versions */}
        <div style={{ ...styles.card, padding: 16, marginBottom: 20 }}>
          <div style={{ display: 'flex', gap: 24, flexWrap: 'wrap' }}>
            {allBudgetsForSourceExercice.map((budget) => (
              <div key={budget.id} style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                <div style={{ 
                  width: 12, 
                  height: 12, 
                  borderRadius: '50%', 
                  background: budget.id === latestVersion?.id ? '#4caf50' : currentSourceObj?.couleur || '#0f4c3a' 
                }}></div>
                <div>
                  <div style={{ fontSize: 12, fontWeight: 600 }}>
                    {getVersionLabel(budget)}
                    {budget.id === latestVersion?.id && <span style={{ color: '#4caf50', marginLeft: 4 }}>(actif)</span>}
                  </div>
                  <div style={{ fontSize: 11, color: '#6c757d' }}>
                    {budget.createdAt ? new Date(budget.createdAt).toLocaleDateString('fr-FR') : '-'}
                    {budget.motifRevision && ` - ${budget.motifRevision}`}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Tableau principal */}
        <div style={styles.card}>
          <div style={{ overflowX: 'auto' }}>
            <table style={styles.table}>
              <thead>
                {/* Ligne des dates */}
                <tr style={{ background: '#f8f9fa' }}>
                  <th style={{ ...styles.th, borderBottom: 'none', minWidth: 150 }}>DATE</th>
                  {allBudgetsForSourceExercice.map(budget => (
                    <th key={budget.id} style={{ ...styles.th, textAlign: 'right', borderBottom: 'none', minWidth: 120 }}>
                      {budget.createdAt ? new Date(budget.createdAt).toLocaleDateString('fr-FR') : '-'}
                    </th>
                  ))}
                  <th style={{ ...styles.th, textAlign: 'right', borderBottom: 'none', minWidth: 140, background: '#e8f5e9' }}></th>
                </tr>
                {/* Ligne des versions */}
                <tr>
                  <th style={{ ...styles.th, minWidth: 150 }}>LIGNE</th>
                  {allBudgetsForSourceExercice.map((budget, index) => (
                    <th key={budget.id} style={{ 
                      ...styles.th, 
                      textAlign: 'right', 
                      minWidth: 120,
                      background: budget.id === latestVersion?.id ? '#e8f5e9' : '#f8f9fa'
                    }}>
                      {getVersionLabel(budget)}
                      {index > 0 && <div style={{ fontSize: 9, fontWeight: 400, color: '#6c757d' }}>(variation)</div>}
                    </th>
                  ))}
                  <th style={{ ...styles.th, textAlign: 'right', minWidth: 140, background: currentSourceObj?.couleur || '#0f4c3a', color: 'white' }}>
                    DOTATION FINALE
                  </th>
                </tr>
              </thead>
              <tbody>
                {(() => {
                  // Collecter toutes les lignes
                  const allLignes = new Map();
                  allBudgetsForSourceExercice.forEach(budget => {
                    (budget.lignes || []).forEach(ligne => {
                      if (!allLignes.has(ligne.code)) {
                        allLignes.set(ligne.code, ligne.libelle);
                      }
                    });
                  });

                  return Array.from(allLignes.keys()).sort().map(code => {
                    // Calculer les valeurs pour chaque version
                    const valuesPerVersion = allBudgetsForSourceExercice.map((budget, index) => {
                      const ligne = (budget.lignes || []).find(l => l.code === code);
                      const dotation = ligne?.dotation || 0;
                      
                      let variation = null;
                      if (index > 0) {
                        const prevBudget = allBudgetsForSourceExercice[index - 1];
                        const prevLigne = (prevBudget.lignes || []).find(l => l.code === code);
                        variation = dotation - (prevLigne?.dotation || 0);
                      }
                      
                      return { dotation, variation, isLatest: budget.id === latestVersion?.id };
                    });

                    const dotationFinale = valuesPerVersion[valuesPerVersion.length - 1]?.dotation || 0;

                    return (
                      <tr key={code}>
                        <td style={styles.td}>
                          <code style={{ background: '#f5f5f5', padding: '2px 8px', borderRadius: 4, fontSize: 12, fontWeight: 600 }}>
                            {code}
                          </code>
                          <div style={{ fontSize: 11, color: '#6c757d', marginTop: 2 }}>{allLignes.get(code)}</div>
                        </td>
                        {valuesPerVersion.map((item, index) => (
                          <td key={index} style={{ 
                            ...styles.td, 
                            textAlign: 'right', 
                            fontFamily: 'monospace',
                            background: item.isLatest ? '#f1f8e9' : 'transparent'
                          }}>
                            {index === 0 ? (
                              <span style={{ fontWeight: 500 }}>{formatMontant(item.dotation)}</span>
                            ) : (
                              item.variation === 0 ? (
                                <span style={{ color: '#bdbdbd' }}>-</span>
                              ) : (
                                <span style={{ 
                                  color: item.variation > 0 ? '#2e7d32' : '#c62828',
                                  fontWeight: 600
                                }}>
                                  {item.variation > 0 ? '+' : ''}{formatMontant(item.variation)}
                                </span>
                              )
                            )}
                          </td>
                        ))}
                        <td style={{ 
                          ...styles.td, 
                          textAlign: 'right', 
                          fontFamily: 'monospace', 
                          fontWeight: 700,
                          background: '#e8f5e9',
                          color: currentSourceObj?.couleur || '#0f4c3a'
                        }}>
                          {formatMontant(dotationFinale)}
                        </td>
                      </tr>
                    );
                  });
                })()}
              </tbody>
              <tfoot>
                <tr style={{ background: '#f8f9fa' }}>
                  <td style={{ ...styles.td, fontWeight: 700 }}>TOTAL</td>
                  {allBudgetsForSourceExercice.map((budget, index) => {
                    const totalDotation = (budget.lignes || []).reduce((sum, l) => sum + (l.dotation || 0), 0);
                    
                    let variation = null;
                    if (index > 0) {
                      const prevBudget = allBudgetsForSourceExercice[index - 1];
                      const prevTotal = (prevBudget.lignes || []).reduce((sum, l) => sum + (l.dotation || 0), 0);
                      variation = totalDotation - prevTotal;
                    }

                    return (
                      <td key={budget.id} style={{ 
                        ...styles.td, 
                        textAlign: 'right', 
                        fontFamily: 'monospace', 
                        fontWeight: 700,
                        background: budget.id === latestVersion?.id ? '#e8f5e9' : '#f8f9fa'
                      }}>
                        {index === 0 ? (
                          formatMontant(totalDotation)
                        ) : (
                          variation === 0 ? (
                            <span style={{ color: '#bdbdbd' }}>-</span>
                          ) : (
                            <span style={{ color: variation > 0 ? '#2e7d32' : '#c62828' }}>
                              {variation > 0 ? '+' : ''}{formatMontant(variation)}
                            </span>
                          )
                        )}
                      </td>
                    );
                  })}
                  <td style={{ 
                    ...styles.td, 
                    textAlign: 'right', 
                    fontFamily: 'monospace', 
                    fontWeight: 700,
                    fontSize: 16,
                    background: currentSourceObj?.couleur || '#0f4c3a',
                    color: 'white'
                  }}>
                    {formatMontant(getTotaux(latestVersion).dotation)}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    );
  };

  // ==================== PAGE NOUVEL OP ====================
  const PageNouvelOp = ({ consultOpData, setConsultOpData }) => {
    const [activeSource, setActiveSource] = useState(sources[0]?.id || null);
    const [form, setForm] = useState({
      type: 'PROVISOIRE',
      beneficiaireId: '',
      ribIndex: 0,
      modeReglement: 'VIREMENT',
      objet: '',
      piecesJustificatives: '',
      montant: '',
      ligneBudgetaire: '',
      montantTVA: '',
      tvaRecuperable: false,
      opProvisoireNumero: '',
      opProvisoireId: ''
    });
    const [saving, setSaving] = useState(false);
    const [showDuplicateModal, setShowDuplicateModal] = useState(false);
    const [showConsultModal, setShowConsultModal] = useState(false);
    const [consultSearch, setConsultSearch] = useState('');
    const [isConsultMode, setIsConsultMode] = useState(false);
    const [isEditMode, setIsEditMode] = useState(false); // Mode modification d'un OP existant
    const [consultedOp, setConsultedOp] = useState(null); // L'OP en consultation

    const currentSourceObj = sources.find(s => s.id === activeSource);
    const selectedBeneficiaire = beneficiaires.find(b => b.id === form.beneficiaireId);

    // Charger un OP en mode consultation
    const loadOpForConsult = (op) => {
      if (!op) return;
      setConsultedOp(op);
      setIsConsultMode(true);
      // Changer la source active
      if (op.sourceId) setActiveSource(op.sourceId);
      // Trouver l'index du RIB
      const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
      const ribs = ben?.ribs || (ben?.rib ? [{ numero: ben.rib, banque: '' }] : []);
      const ribIndex = ribs.findIndex(r => r.numero === (typeof op.rib === 'object' ? op.rib?.numero : op.rib)) || 0;
      // Remplir le formulaire
      setForm({
        type: op.type || 'PROVISOIRE',
        beneficiaireId: op.beneficiaireId || '',
        ribIndex: ribIndex >= 0 ? ribIndex : 0,
        modeReglement: op.modeReglement || 'VIREMENT',
        objet: op.objet || '',
        piecesJustificatives: op.piecesJustificatives || '',
        montant: String(op.montant || ''),
        ligneBudgetaire: op.ligneBudgetaire || '',
        montantTVA: String(op.montantTVA || ''),
        tvaRecuperable: op.tvaRecuperable || false,
        opProvisoireNumero: op.opProvisoireNumero || '',
        opProvisoireId: op.opProvisoireId || ''
      });
    };

    // Quitter le mode consultation
    const exitConsultMode = () => {
      setIsConsultMode(false);
      setIsEditMode(false);
      setConsultedOp(null);
      if (setConsultOpData) setConsultOpData(null);
      handleClear();
    };

    // Si on vient de Liste OP avec un consultOpData - se dclenche au montage
    useEffect(() => {
      if (consultOpData) {
        loadOpForConsult(consultOpData);
        if (setConsultOpData) setConsultOpData(null);
      }
    }, [consultOpData]);
    
    // Fonction utilitaire pour obtenir les RIB (rtrocompatibilit)
    const getBeneficiaireRibs = (ben) => {
      if (!ben) return [];
      if (ben.ribs && ben.ribs.length > 0) return ben.ribs;
      if (ben.rib) return [{ banque: '', numero: ben.rib }];
      return [];
    };
    
    const beneficiaireRibs = getBeneficiaireRibs(selectedBeneficiaire);
    const selectedRib = beneficiaireRibs[form.ribIndex] || beneficiaireRibs[0] || null;

    // OP disponibles pour duplication (tous les OP de la mme source/exercice)
    const opsPourDuplication = ops.filter(op => 
      op.sourceId === activeSource &&
      op.exerciceId === exerciceActif?.id
    ).sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

    // Fonction de duplication (sans montant ni TVA)
    const handleDuplicate = (opId) => {
      const op = ops.find(o => o.id === opId);
      if (!op) return;
      
      // Pr-remplir le formulaire avec les donnes de l'OP slectionn
      // Montant et TVA ne sont PAS copis car ils peuvent varier
      setForm({
        type: op.type === 'ANNULATION' ? 'PROVISOIRE' : op.type, // Tous les types sauf Annulation
        beneficiaireId: op.beneficiaireId || '',
        ribIndex: 0,
        modeReglement: op.modeReglement || 'VIREMENT',
        objet: op.objet || '',
        piecesJustificatives: op.piecesJustificatives || '',
        montant: '', //  saisir
        ligneBudgetaire: op.ligneBudgetaire || '',
        montantTVA: '', //  saisir
        tvaRecuperable: op.tvaRecuperable || false,
        opProvisoireNumero: '',
        opProvisoireId: ''
      });
      
      setShowDuplicateModal(false);
    };
    
    // Budget actif pour la source et l'exercice actif
    const currentBudget = budgets
      .filter(b => b.sourceId === activeSource && b.exerciceId === exerciceActif?.id)
      .sort((a, b) => (b.version || 1) - (a.version || 1))[0];

    // Ligne budgtaire slectionne
    const selectedLigne = currentBudget?.lignes?.find(l => l.code === form.ligneBudgetaire);

    // Calculs budgtaires
    const getDotation = () => selectedLigne?.dotation || 0;
    
    const getEngagementsAnterieurs = () => {
      if (!form.ligneBudgetaire) return 0;
      return ops
        .filter(op => 
          op.sourceId === activeSource && 
          op.exerciceId === exerciceActif?.id &&
          op.ligneBudgetaire === form.ligneBudgetaire &&
          ['DIRECT', 'DEFINITIF', 'PROVISOIRE'].includes(op.type) &&
          !['REJETE', 'ANNULE'].includes(op.statut)
        )
        .reduce((sum, op) => sum + (op.montant || 0), 0);
    };

    const getEngagementActuel = () => {
      const montant = parseFloat(form.montant) || 0;
      // Le montant est utilis tel quel (ngatif pour annulation, positif pour les autres)
      // Pour Dfinitif : remplace le provisoire, donc pas d'impact supplmentaire si mme montant
      if (form.type === 'DEFINITIF' && form.opProvisoireId) {
        const opProv = ops.find(o => o.id === form.opProvisoireId);
        return montant - (opProv?.montant || 0);
      }
      return montant;
    };

    const getEngagementsCumules = () => getEngagementsAnterieurs() + getEngagementActuel();
    const getDisponible = () => getDotation() - getEngagementsCumules();

    // OP Provisoires disponibles pour Annulation/Dfinitif
    const opProvisoiresDisponibles = ops.filter(op => 
      op.sourceId === activeSource &&
      op.exerciceId === exerciceActif?.id &&
      op.type === 'PROVISOIRE' &&
      !['REJETE', 'ANNULE'].includes(op.statut) &&
      !ops.find(o => o.opProvisoireId === op.id && ['DEFINITIF', 'ANNULATION'].includes(o.type))
    );

    // Gnrer le prochain numro
    const genererNumero = () => {
      const sigleProjet = projet?.sigle || 'PROJET';
      const sigleSource = currentSourceObj?.sigle || 'OP';
      const annee = exerciceActif?.annee || new Date().getFullYear();
      const opsSource = ops.filter(op => 
        op.sourceId === activeSource && 
        op.exerciceId === exerciceActif?.id
      );
      const nextNum = opsSource.length + 1;
      return `N${String(nextNum).padStart(4, '0')}/${sigleProjet}-${sigleSource}/${annee}`;
    };

    // Quand on slectionne un OP Provisoire
    const handleSelectOpProvisoire = (opId) => {
      if (!opId) {
        setForm({ ...form, opProvisoireId: '', opProvisoireNumero: '' });
        return;
      }
      const op = ops.find(o => o.id === opId);
      if (op) {
        setForm({
          ...form,
          opProvisoireId: opId,
          opProvisoireNumero: op.numero,
          beneficiaireId: op.beneficiaireId,
          ligneBudgetaire: op.ligneBudgetaire,
          objet: op.objet,
          // Pr-remplir le montant uniquement pour ANNULATION
          montant: form.type === 'ANNULATION' ? String(op.montant) : form.montant,
          modeReglement: op.modeReglement || 'VIREMENT'
        });
      }
    };

    // Effacer le formulaire
    const handleClear = () => {
      setForm({
        type: 'PROVISOIRE',
        beneficiaireId: '',
        ribIndex: 0,
        modeReglement: 'VIREMENT',
        objet: '',
        piecesJustificatives: '',
        montant: '',
        ligneBudgetaire: '',
        montantTVA: '',
        tvaRecuperable: false,
        opProvisoireNumero: '',
        opProvisoireId: ''
      });
    };

    // Validation et sauvegarde
    const handleSave = async () => {
      // Validations
      if (!activeSource) {
        alert('Veuillez slectionner une source de financement');
        return;
      }
      if (!exerciceActif) {
        alert('Aucun exercice actif. Veuillez en dfinir un dans les Paramtres.');
        return;
      }
      if (!form.type) {
        alert('Veuillez slectionner le type d\'OP');
        return;
      }
      if (!form.beneficiaireId) {
        alert('Veuillez slectionner un bnficiaire');
        return;
      }
      if (!form.ligneBudgetaire) {
        alert('Veuillez slectionner une ligne budgtaire');
        return;
      }
      if (!form.objet.trim()) {
        alert('Veuillez saisir l\'objet de la dpense');
        return;
      }
      if (!form.montant || parseFloat(form.montant) === 0) {
        alert('Veuillez saisir un montant valide (diffrent de zro)');
        return;
      }
      if (['ANNULATION', 'DEFINITIF'].includes(form.type) && !form.opProvisoireId && !form.opProvisoireNumero.trim()) {
        alert(`Veuillez renseigner le N d'OP Provisoire  ${form.type === 'ANNULATION' ? 'annuler' : 'rgulariser'}`);
        return;
      }

      // Vrification disponible (bloquant si < 0 sauf pour Annulation)
      if (form.type !== 'ANNULATION' && getDisponible() < 0) {
        alert(` Impossible de crer cet OP.\n\nLe disponible budgtaire serait ngatif (${formatMontant(getDisponible())} FCFA).\n\nVeuillez rduire le montant ou augmenter la dotation.`);
        return;
      }

      setSaving(true);
      try {
        const sigleProjet = projet?.sigle || 'PROJET';
        const sigleSource = currentSourceObj?.sigle || 'OP';
        const annee = exerciceActif?.annee || new Date().getFullYear();
        
        // Rcuprer TOUS les OP de cette source/exercice depuis Firebase (pas le state local)
        const allOpsSnap = await getDocs(query(
          collection(db, 'ops'),
          where('sourceId', '==', activeSource),
          where('exerciceId', '==', exerciceActif.id)
        ));
        const allNumerosExistants = allOpsSnap.docs.map(d => d.data().numero);
        
        // Trouver le prochain numro VRAIMENT disponible
        let nextNum = allOpsSnap.size + 1;
        let numero = `N${String(nextNum).padStart(4, '0')}/${sigleProjet}-${sigleSource}/${annee}`;
        let tentatives = 0;
        while (allNumerosExistants.includes(numero) && tentatives < 50) {
          nextNum++;
          numero = `N${String(nextNum).padStart(4, '0')}/${sigleProjet}-${sigleSource}/${annee}`;
          tentatives++;
        }
        
        const numeroInitial = genererNumero();
        if (numero !== numeroInitial) {
          alert(` Le numro ${numeroInitial} a dj t utilis par un autre utilisateur.\n\nVotre OP prendra le numro : ${numero}`);
        }
        
        const opData = {
          numero,
          type: form.type,
          sourceId: activeSource,
          exerciceId: exerciceActif.id,
          beneficiaireId: form.beneficiaireId,
          modeReglement: form.modeReglement,
          rib: selectedRib ? selectedRib : null,
          ligneBudgetaire: form.ligneBudgetaire,
          objet: form.objet.trim(),
          piecesJustificatives: form.piecesJustificatives.trim(),
          montant: parseFloat(form.montant),
          montantTVA: form.montantTVA ? parseFloat(form.montantTVA) : null,
          tvaRecuperable: form.tvaRecuperable,
          statut: 'CREE',
          opProvisoireId: form.opProvisoireId || null,
          opProvisoireNumero: form.opProvisoireNumero || null,
          dateCreation: new Date().toISOString().split('T')[0],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };

        const docRef = await addDoc(collection(db, 'ops'), opData);
        
        // Re-vrification aprs criture : dtecter si un doublon a t cr au mme instant
        const doublonSnap = await getDocs(query(
          collection(db, 'ops'),
          where('numero', '==', numero)
        ));
        if (doublonSnap.size > 1) {
          // Doublon dtect ! Corriger en prenant le numro suivant
          const allOpsSnap2 = await getDocs(query(
            collection(db, 'ops'),
            where('sourceId', '==', activeSource),
            where('exerciceId', '==', exerciceActif.id)
          ));
          const allNums2 = allOpsSnap2.docs.map(d => d.data().numero);
          let fixNum = allOpsSnap2.size + 1;
          let fixNumero = `N${String(fixNum).padStart(4, '0')}/${sigleProjet}-${sigleSource}/${annee}`;
          while (allNums2.includes(fixNumero)) {
            fixNum++;
            fixNumero = `N${String(fixNum).padStart(4, '0')}/${sigleProjet}-${sigleSource}/${annee}`;
          }
          await updateDoc(doc(db, 'ops', docRef.id), { numero: fixNumero, updatedAt: new Date().toISOString() });
          opData.numero = fixNumero;
          alert(` Doublon dtect et corrig automatiquement.\n\nNouveau numro attribu : ${fixNumero}`);
        }
        
        setOps([...ops, { id: docRef.id, ...opData }]);

        alert(` OP ${numero} cr avec succs !`);
        handleClear();
        setCurrentPage('ops');
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la cration de l\'OP');
      }
      setSaving(false);
    };

    return (
      <div>
        {/* En-tte */}
        <div style={{ 
          background: currentSourceObj?.couleur || '#0f4c3a', 
          color: 'white', 
          padding: '20px 24px', 
          borderRadius: '10px 10px 0 0',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          <h1 style={{ margin: 0, fontSize: 20, fontWeight: 700 }}>
            FORMULAIRE OP {currentSourceObj?.sigle || ''}
          </h1>
          <div style={{ display: 'flex', gap: 12 }}>
            {sources.map(source => (
              <button
                key={source.id}
                onClick={() => setActiveSource(source.id)}
                style={{
                  padding: '8px 16px',
                  borderRadius: 6,
                  border: 'none',
                  background: activeSource === source.id ? 'white' : 'rgba(255,255,255,0.2)',
                  color: activeSource === source.id ? (source.couleur || '#0f4c3a') : 'white',
                  fontWeight: 600,
                  cursor: 'pointer'
                }}
              >
                {source.sigle || source.nom}
              </button>
            ))}
          </div>
        </div>

        {!exerciceActif ? (
          <div style={{ ...styles.card, borderRadius: '0 0 10px 10px', textAlign: 'center', padding: 40 }}>
            <div style={{ fontSize: 50, marginBottom: 16 }}></div>
            <p style={{ color: '#e65100', fontWeight: 600 }}>Aucun exercice actif</p>
            <p style={{ color: '#6c757d' }}>Veuillez dfinir un exercice actif dans les <span style={{ color: '#0f4c3a', cursor: 'pointer', textDecoration: 'underline' }} onClick={() => setCurrentPage('parametres')}>Paramtres</span></p>
          </div>
        ) : (
          <div style={{ ...styles.card, borderRadius: '0 0 10px 10px', padding: 0 }}>
            <div style={{ padding: 24 }}>
              {/* Ligne 1 : NOP + Boutons Consulter/Dupliquer/Effacer */}
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'end', marginBottom: 20 }}>
                <div style={{ width: 250 }}>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>{isEditMode ? 'N OP (modification)' : isConsultMode ? 'N OP (consultation)' : 'N OP'}</label>
                  <input 
                    type="text" 
                    value={isConsultMode ? (consultedOp?.numero || '') : genererNumero()} 
                    readOnly 
                    style={{ ...styles.input, marginBottom: 0, background: isEditMode ? '#fff3e0' : isConsultMode ? '#e8f5e9' : '#f8f9fa', fontWeight: 700, fontFamily: 'monospace', fontSize: 16, border: isEditMode ? '2px solid #f57f17' : isConsultMode ? '2px solid #4caf50' : undefined }} 
                  />
                </div>
                <div style={{ display: 'flex', gap: 10 }}>
                  {(isConsultMode || isEditMode) ? (
                    <button 
                      onClick={exitConsultMode} 
                      style={{ ...styles.buttonSecondary, padding: '12px 20px', background: '#ffebee', color: '#c62828' }}
                    >
                       Quitter {isEditMode ? 'modification' : 'consultation'}
                    </button>
                  ) : (
                    <>
                      <button 
                        onClick={() => { setConsultSearch(''); setShowConsultModal(true); }} 
                        style={{ ...styles.buttonSecondary, padding: '12px 20px', background: '#e3f2fd', color: '#1565c0' }}
                      >
                         Consulter un OP
                      </button>
                      <button 
                        onClick={() => setShowDuplicateModal(true)} 
                        style={{ ...styles.buttonSecondary, padding: '12px 20px', background: '#fff3e0', color: '#e65100' }}
                      >
                         Dupliquer un OP
                      </button>
                    </>
                  )}
                  <button onClick={() => { exitConsultMode(); handleClear(); }} style={{ ...styles.buttonSecondary, padding: '12px 24px' }}>
                    EFFACER
                  </button>
                </div>
              </div>

              {/* Wrapper lecture seule en mode consultation */}
              <div style={(isConsultMode && !isEditMode) ? { pointerEvents: 'none', opacity: 0.85 } : {}}>
              {/* Ligne 2 : Type d'OP en boutons compacts */}
              <div style={{ marginBottom: 20 }}>
                <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 10, color: '#6c757d' }}>TYPE D'OP *</label>
                <div style={{ display: 'flex', gap: 10 }}>
                  {[
                    { value: 'PROVISOIRE', label: 'Provisoire', color: '#ff9800' },
                    { value: 'DIRECT', label: 'Direct', color: '#2196f3' },
                    { value: 'DEFINITIF', label: 'Dfinitif', color: '#4caf50' },
                    { value: 'ANNULATION', label: 'Annulation', color: '#f44336' }
                  ].map(type => (
                    <button
                      key={type.value}
                      type="button"
                      onClick={() => setForm({ ...form, type: type.value, opProvisoireId: '', opProvisoireNumero: '' })}
                      style={{
                        padding: '10px 20px',
                        borderRadius: 8,
                        border: 'none',
                        background: form.type === type.value ? type.color : '#f0f0f0',
                        color: form.type === type.value ? 'white' : '#555',
                        fontWeight: 600,
                        fontSize: 13,
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                    >
                      {type.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Ligne 3 : Bnficiaire, NCC */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 200px', gap: 20, marginBottom: 20 }}>
                <div>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>BNFICIAIRE *</label>
                  <Autocomplete
                    options={beneficiaires.map(b => ({
                      value: b.id,
                      label: b.nom,
                      searchFields: [b.nom, b.ncc || '', ...(b.ribs || []).map(r => r.numero), ...(b.ribs || []).map(r => r.banque), b.rib || '']
                    }))}
                    value={form.beneficiaireId ? {
                      value: form.beneficiaireId,
                      label: beneficiaires.find(b => b.id === form.beneficiaireId)?.nom || ''
                    } : null}
                    onChange={(option) => setForm({ ...form, beneficiaireId: option?.value || '', ribIndex: 0 })}
                    placeholder=" Rechercher par nom ou NCC..."
                    isDisabled={['ANNULATION', 'DEFINITIF'].includes(form.type) && form.opProvisoireId}
                    noOptionsMessage="Aucun bnficiaire trouv"
                    accentColor={currentSourceObj?.couleur || '#0f4c3a'}
                  />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>NCC</label>
                  <input 
                    type="text" 
                    value={selectedBeneficiaire?.ncc || ''} 
                    readOnly 
                    style={{ ...styles.input, marginBottom: 0, background: '#f8f9fa' }} 
                  />
                </div>
              </div>

              {/* Ligne 3 : Mode de rglement */}
              <div style={{ marginBottom: 20 }}>
                <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 10, color: '#6c757d' }}>MODE DE RGLEMENT</label>
                <div style={{ display: 'flex', gap: 30 }}>
                  {['ESPECES', 'CHEQUE', 'VIREMENT'].map(mode => (
                    <label key={mode} style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' }}>
                      <input 
                        type="radio" 
                        name="modeReglement" 
                        checked={form.modeReglement === mode}
                        onChange={() => setForm({ ...form, modeReglement: mode })}
                        style={{ width: 18, height: 18 }}
                      />
                      <span style={{ fontSize: 14 }}>{mode}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Ligne 4 : Rfrences bancaires */}
              {form.modeReglement === 'VIREMENT' && (
                <div style={{ marginBottom: 20 }}>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>
                    RFRENCES BANCAIRES (RIB) {beneficiaireRibs.length > 1 && '*'}
                  </label>
                  {!selectedBeneficiaire ? (
                    <div style={{ ...styles.input, marginBottom: 0, background: '#f8f9fa', color: '#adb5bd', fontStyle: 'italic' }}>
                      Slectionnez d'abord un bnficiaire
                    </div>
                  ) : beneficiaireRibs.length === 0 ? (
                    <div style={{ ...styles.input, marginBottom: 0, background: '#fff3e0', color: '#e65100' }}>
                       Aucun RIB enregistr pour ce bnficiaire
                    </div>
                  ) : beneficiaireRibs.length === 1 ? (
                    <div style={{ ...styles.input, marginBottom: 0, background: '#f8f9fa', fontFamily: 'monospace', display: 'flex', alignItems: 'center', gap: 8 }}>
                      {beneficiaireRibs[0].banque && (
                        <span style={{ background: '#e3f2fd', color: '#1565c0', padding: '4px 10px', borderRadius: 4, fontWeight: 600, fontSize: 12 }}>
                          {beneficiaireRibs[0].banque}
                        </span>
                      )}
                      <span>{beneficiaireRibs[0].numero}</span>
                    </div>
                  ) : (
                    <select
                      value={form.ribIndex}
                      onChange={(e) => setForm({ ...form, ribIndex: parseInt(e.target.value) })}
                      style={{ ...styles.input, marginBottom: 0 }}
                    >
                      {beneficiaireRibs.map((rib, index) => (
                        <option key={index} value={index}>
                          {rib.banque ? `${rib.banque} - ` : ''}{rib.numero}
                        </option>
                      ))}
                    </select>
                  )}
                </div>
              )}

              {/* Ligne 5 : Objet de la dpense */}
              <div style={{ marginBottom: 20 }}>
                <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>OBJET DE LA DPENSE *</label>
                <textarea 
                  value={form.objet} 
                  onChange={(e) => setForm({ ...form, objet: e.target.value })}
                  style={{ ...styles.input, marginBottom: 0, minHeight: 80, resize: 'vertical', background: '#fff0f0' }} 
                  placeholder="Dcrire l'objet de la dpense..."
                />
              </div>

              {/* Ligne 6 : Pices justificatives */}
              <div style={{ marginBottom: 20 }}>
                <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>PICES JUSTIFICATIVES</label>
                <textarea 
                  value={form.piecesJustificatives} 
                  onChange={(e) => setForm({ ...form, piecesJustificatives: e.target.value })}
                  style={{ ...styles.input, marginBottom: 0, minHeight: 60, resize: 'vertical', background: '#fff0f0' }} 
                  placeholder="Lister les pices jointes..."
                />
              </div>

              {/* Ligne 7 : Montant et Ligne budgtaire */}
              <div style={{ display: 'grid', gridTemplateColumns: '250px 1fr', gap: 20, marginBottom: 20 }}>
                <div>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>MONTANT (FCFA) *</label>
                  <input 
                    type="number" 
                    value={form.montant} 
                    onChange={(e) => setForm({ ...form, montant: e.target.value })}
                    style={{ ...styles.input, marginBottom: 0, background: '#fff0f0', fontFamily: 'monospace', fontSize: 16, textAlign: 'right' }} 
                    placeholder="0"
                    disabled={form.type === 'ANNULATION' && form.opProvisoireId}
                  />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>LIGNE BUDGTAIRE *</label>
                  <Autocomplete
                    options={(currentBudget?.lignes || []).map(l => ({
                      value: l.code,
                      label: `${l.code} - ${l.libelle}`,
                      searchFields: [l.code, l.libelle]
                    }))}
                    value={form.ligneBudgetaire ? 
                      (currentBudget?.lignes || []).filter(x => x.code === form.ligneBudgetaire).map(l => ({
                        value: l.code,
                        label: `${l.code} - ${l.libelle}`
                      }))[0] || null
                    : null}
                    onChange={(option) => setForm({ ...form, ligneBudgetaire: option?.value || '' })}
                    placeholder=" Rechercher par code ou libell..."
                    isDisabled={['ANNULATION', 'DEFINITIF'].includes(form.type) && form.opProvisoireId}
                    noOptionsMessage="Aucune ligne trouve"
                    accentColor={currentSourceObj?.couleur || '#0f4c3a'}
                  />
                </div>
              </div>

              {/* Ligne 8 : Infos budgtaires + Date + TVA */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 20, marginBottom: 20 }}>
                {/* Colonne gauche : Infos budget */}
                <div style={{ background: '#f8f9fa', padding: 16, borderRadius: 8 }}>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 150px', gap: 8 }}>
                    <span style={{ fontSize: 12, color: '#6c757d' }}>Dotation budgtaire</span>
                    <span style={{ fontSize: 13, fontFamily: 'monospace', textAlign: 'right', fontWeight: 500 }}>{formatMontant(getDotation())}</span>
                    
                    <span style={{ fontSize: 12, color: '#6c757d' }}>Engagements antrieurs</span>
                    <span style={{ fontSize: 13, fontFamily: 'monospace', textAlign: 'right', fontWeight: 500 }}>{formatMontant(getEngagementsAnterieurs())}</span>
                    
                    <span style={{ fontSize: 12, color: '#6c757d' }}>Engagement actuel</span>
                    <span style={{ fontSize: 13, fontFamily: 'monospace', textAlign: 'right', fontWeight: 600, color: getEngagementActuel() < 0 ? '#2e7d32' : '#e65100' }}>
                      {getEngagementActuel() >= 0 ? '+' : ''}{formatMontant(getEngagementActuel())}
                    </span>
                    
                    <span style={{ fontSize: 12, color: '#6c757d' }}>Engagements cumuls</span>
                    <span style={{ fontSize: 13, fontFamily: 'monospace', textAlign: 'right', fontWeight: 500 }}>{formatMontant(getEngagementsCumules())}</span>
                    
                    <span style={{ fontSize: 12, fontWeight: 600, color: '#333' }}>Disponible budgtaire</span>
                    <span style={{ 
                      fontSize: 14, 
                      fontFamily: 'monospace', 
                      textAlign: 'right', 
                      fontWeight: 700,
                      color: getDisponible() >= 0 ? '#2e7d32' : '#c62828'
                    }}>
                      {formatMontant(getDisponible())}
                    </span>
                  </div>
                  {getDisponible() < 0 && form.type !== 'ANNULATION' && (
                    <div style={{ marginTop: 12, padding: 8, background: '#ffebee', borderRadius: 4, color: '#c62828', fontSize: 12, fontWeight: 600 }}>
                       Budget insuffisant - OP non validable
                    </div>
                  )}
                </div>

                {/* Colonne droite : Date + TVA */}
                <div>
                  <div style={{ marginBottom: 16 }}>
                    <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>DATE</label>
                    <input 
                      type="date" 
                      value={new Date().toISOString().split('T')[0]} 
                      readOnly
                      style={{ ...styles.input, marginBottom: 0, background: '#f8f9fa' }} 
                    />
                  </div>

                  {/* TVA pour OP Direct ou Dfinitif */}
                  {['DIRECT', 'DEFINITIF'].includes(form.type) && (
                    <>
                      <div style={{ marginBottom: 12 }}>
                        <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 8, color: '#6c757d' }}>TVA RCUPRABLE</label>
                        <div style={{ display: 'flex', gap: 20 }}>
                          <label style={{ display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer' }}>
                            <input 
                              type="radio" 
                              checked={form.tvaRecuperable === true}
                              onChange={() => setForm({ ...form, tvaRecuperable: true })}
                            />
                            <span>OUI</span>
                          </label>
                          <label style={{ display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer' }}>
                            <input 
                              type="radio" 
                              checked={form.tvaRecuperable === false}
                              onChange={() => setForm({ ...form, tvaRecuperable: false })}
                            />
                            <span>NON</span>
                          </label>
                        </div>
                      </div>
                      {form.tvaRecuperable && (
                        <div>
                          <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>MONTANT TVA</label>
                          <input 
                            type="number" 
                            value={form.montantTVA} 
                            onChange={(e) => setForm({ ...form, montantTVA: e.target.value })}
                            style={{ ...styles.input, marginBottom: 0, fontFamily: 'monospace', textAlign: 'right' }} 
                            placeholder="0"
                          />
                        </div>
                      )}
                    </>
                  )}
                </div>
              </div>

              {/* Ligne 9 : N OP Provisoire (pour Annulation/Dfinitif) */}
              {['ANNULATION', 'DEFINITIF'].includes(form.type) && (
                <div style={{ marginBottom: 20, padding: 16, background: form.type === 'ANNULATION' ? '#ffebee' : '#e8f5e9', borderRadius: 8 }}>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 10, color: '#6c757d' }}>
                    N OP PROVISOIRE  {form.type === 'ANNULATION' ? 'ANNULER' : 'RGULARISER'} *
                  </label>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr auto 1fr', gap: 12, alignItems: 'end' }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, marginBottom: 4, color: '#6c757d' }}>Saisie manuelle</label>
                      <input 
                        type="text" 
                        value={form.opProvisoireNumero} 
                        onChange={(e) => setForm({ ...form, opProvisoireNumero: e.target.value, opProvisoireId: '' })}
                        style={{ ...styles.input, marginBottom: 0 }} 
                        placeholder="Ex: ETAT-2025-0012"
                      />
                    </div>
                    <div style={{ padding: '0 8px', color: '#6c757d', fontSize: 12 }}>ou</div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, marginBottom: 4, color: '#6c757d' }}>Slectionner un OP existant</label>
                      <Autocomplete
                        options={opProvisoiresDisponibles.map(op => {
                          const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
                          return {
                            value: op.id,
                            label: `${op.numero} - ${ben?.nom || 'N/A'} - ${formatMontant(op.montant)} F`,
                            searchFields: [op.numero, ben?.nom || '', String(op.montant), op.objet || '']
                          };
                        })}
                        value={form.opProvisoireId ? 
                          opProvisoiresDisponibles.filter(o => o.id === form.opProvisoireId).map(op => {
                            const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
                            return {
                              value: op.id,
                              label: `${op.numero} - ${ben?.nom || 'N/A'} - ${formatMontant(op.montant)} F`
                            };
                          })[0] || null
                        : null}
                        onChange={(option) => handleSelectOpProvisoire(option?.value || '')}
                        placeholder=" Rechercher par N, bnficiaire..."
                        noOptionsMessage="Aucun OP Provisoire disponible"
                        accentColor={form.type === 'ANNULATION' ? '#c62828' : '#2e7d32'}
                      />
                    </div>
                  </div>
                </div>
              )}

              </div>{/* Fin wrapper lecture seule */}
              
              {/* Boutons selon le mode */}
              {(isConsultMode && !isEditMode) ? (
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: 16, borderTop: '2px solid #4caf50' }}>
                  <div style={{ display: 'flex', gap: 10 }}>
                    <span style={{ padding: '10px 16px', background: '#e8f5e9', color: '#2e7d32', borderRadius: 8, fontWeight: 700, fontSize: 13 }}>
                       Mode consultation  {consultedOp?.numero}
                    </span>
                  </div>
                  <div style={{ display: 'flex', gap: 10 }}>
                    <button
                      type="button"
                      onClick={() => {
                        const selectedRib = beneficiaireRibs[form.ribIndex] || {};
                        const engagementActuel = parseFloat(form.montant) || 0;
                        const engagementsCumules = getEngagementsAnterieurs() + engagementActuel;
                        const isBailleur = currentSourceObj?.sigle?.includes('IDA') || currentSourceObj?.sigle?.includes('BAD') || currentSourceObj?.sigle?.includes('UE');
                        const isTresor = currentSourceObj?.sigle?.includes('BN') || currentSourceObj?.sigle?.includes('TRESOR') || currentSourceObj?.sigle?.includes('ETAT');
                        const codeImputationComplet = (currentSourceObj?.codeImputation || '') + ' ' + (form.ligneBudgetaire || '');
                    
                    const printContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>OP ${isConsultMode ? (consultedOp?.numero || '') : genererNumero()}</title>
  <style>
    @page { size: A4; margin: 10mm; }
    @media print {
      .toolbar { display: none !important; }
      body { background: #fff !important; padding: 0 !important; }
      .page-container { box-shadow: none !important; margin: 0 !important; width: 100% !important; }
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Century Gothic', 'Trebuchet MS', sans-serif; 
      font-size: 11px; 
      line-height: 1.4;
      background: #e0e0e0;
      padding: 0;
    }
    .toolbar {
      background: #1a1a2e;
      padding: 12px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .toolbar button {
      padding: 8px 20px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-print { background: #2196F3; color: #fff; }
    .btn-print:hover { background: #1976D2; }
    .btn-pdf { background: #4CAF50; color: #fff; }
    .btn-pdf:hover { background: #388E3C; }
    .toolbar-title { color: #fff; font-size: 14px; margin-left: auto; }
    .page-container {
      width: 210mm;
      min-height: 297mm;
      margin: 20px auto;
      background: #fff;
      padding: 8mm;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .inner-frame {
      border: 2px solid #000;
      height: 100%;
    }
    .header {
      display: flex;
      border-bottom: 1px solid #000;
    }
    .header-logo {
      width: 22%;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid #000;
    }
    .header-logo img { max-height: 75px; max-width: 100%; }
    .header-center {
      width: 56%;
      padding: 6px;
      text-align: center;
      border-right: 1px solid #000;
    }
    .header-center .republic { font-weight: bold; font-size: 11px; }
    .header-center .sep { font-size: 8px; letter-spacing: 0.5px; color: #333; }
    .header-center .ministry { font-style: italic; font-size: 10px; }
    .header-center .project { font-weight: bold; font-size: 10px; }
    .header-right {
      width: 22%;
      padding: 8px;
      font-size: 10px;
      text-align: right;
    }
    .op-title-section {
      text-align: center;
      padding: 6px 10px;
      border-bottom: 1px solid #000;
    }
    .op-title { font-weight: bold; text-decoration: underline; font-size: 11px; }
    .op-numero { font-size: 10px; margin-top: 2px; }
    .body-content {
      padding: 12px 15px;
      border-bottom: 1px solid #000;
    }
    .exercice-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .type-red { color: #c00; font-weight: bold; }
    .field { margin-bottom: 8px; }
    .field-title { text-decoration: underline; font-size: 10px; margin-bottom: 6px; }
    .field-value { font-weight: bold; }
    .field-large {
      margin: 15px 0;
      min-height: 45px;
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .checkbox-line {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .checkbox-label { min-width: 230px; }
    .checkbox-options { display: flex; gap: 50px; }
    .check-item { display: flex; align-items: center; gap: 6px; }
    .box { 
      width: 18px; 
      height: 14px; 
      border: 1px solid #000; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      font-size: 10px;
    }
    .budget-section { margin-top: 15px; }
    .budget-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .budget-row .col-left { width: 33.33%; }
    .budget-row .col-center { width: 33.33%; }
    .budget-row .col-right { width: 33.33%; }
    .value-box {
      border: 1px solid #000;
      padding: 4px 10px;
      text-align: right;
      font-weight: bold;
      white-space: nowrap;
      font-size: 10px;
    }
    .budget-table {
      width: 100%;
      border-collapse: collapse;
    }
    .budget-table td {
      border: 1px solid #000;
      padding: 4px 8px;
      font-size: 10px;
    }
    .budget-table .col-letter { 
      width: 4%;
      text-align: center; 
      font-weight: bold; 
    }
    .budget-table .col-label { width: 29.33%; }
    .budget-table .col-amount { 
      width: 33.33%;
      text-align: right;
      padding-right: 10px;
    }
    .budget-table .col-empty {
      width: 33.33%;
      border: none;
    }
    .signatures-section {
      display: flex;
      border-bottom: 1px solid #000;
    }
    .sig-box {
      width: 33.33%;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #000;
    }
    .sig-box:last-child { border-right: none; }
    .sig-header {
      text-align: center;
      font-weight: bold;
      font-size: 9px;
      padding: 6px;
      border-bottom: 1px solid #000;
      line-height: 1.3;
    }
    .sig-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 8px;
    }
    .sig-name {
      text-align: right;
      font-weight: bold;
      text-decoration: underline;
      font-size: 9px;
    }
    .abidjan-row {
      display: flex;
      border-bottom: 1px solid #000;
    }
    .abidjan-cell {
      width: 33.33%;
      padding: 4px 10px;
      font-size: 9px;
      border-right: 1px solid #000;
    }
    .abidjan-cell:last-child { border-right: none; }
    .acquit-section { display: flex; }
    .acquit-empty { 
      width: 66.66%;
      border-right: 1px solid #000;
    }
    .acquit-box {
      width: 33.33%;
      min-height: 110px;
      display: flex;
      flex-direction: column;
    }
    .acquit-header {
      text-align: center;
      font-size: 9px;
      padding: 6px;
      border-bottom: 1px solid #000;
    }
    .acquit-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 8px;
    }
    .acquit-date {
      font-size: 9px;
      text-align: left;
    }
    @media print { 
      body { padding: 0; }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button class="btn-print" onclick="window.print()"> Imprimer</button>
    <button class="btn-pdf" onclick="window.print()"> Exporter PDF</button>
    <span class="toolbar-title">Aperu  OP ${isConsultMode ? (consultedOp?.numero || '') : genererNumero()}</span>
  </div>
  <div class="page-container">
  <div class="inner-frame">
    <div class="header">
      <div class="header-logo">
        <img src="${LOGO_PIF2}" alt="PIF2" />
      </div>
      <div class="header-center">
        <div class="republic">REPUBLIQUE DE CTE D'IVOIRE</div>
        <div class="sep">------------------------</div>
        <div class="ministry">MINISTERE DES EAUX ET FORETS</div>
        <div class="sep">------------------------</div>
        <div class="project">PROJET D'INVESTISSEMENT FORESTIER 2</div>
        <div class="sep">------------------------</div>
      </div>
      <div class="header-right">
        <div style="text-align: center;">
          <img src="${ARMOIRIE}" alt="Armoirie" style="max-height: 50px; max-width: 60px; margin-bottom: 3px;" />
          <div>Union  Discipline  Travail</div>
        </div>
      </div>
    </div>
    
    <div class="op-title-section">
      <div class="op-title">ORDRE DE PAIEMENT</div>
      <div class="op-numero">N${isConsultMode ? (consultedOp?.numero || '') : genererNumero()}</div>
    </div>
    
    <div class="body-content">
      <div class="exercice-line">
        <div>EXERCICE&nbsp;&nbsp;&nbsp;&nbsp;<strong>${exerciceActif?.annee || ''}</strong></div>
        <div class="type-red">${form.type}</div>
      </div>
      
      <div class="field">
        <div class="field-title">REFERENCE DU BENEFICIAIRE</div>
      </div>
      
      <div class="field">
        BENEFICIAIRE :&nbsp;&nbsp;&nbsp;<span class="field-value">${selectedBeneficiaire?.nom || ''}</span>
      </div>
      
      <div class="field">
        COMPTE CONTRIBUABLE :&nbsp;&nbsp;&nbsp;<span class="field-value">${selectedBeneficiaire?.ncc || ''}</span>
      </div>
      
      <div class="checkbox-line">
        <span class="checkbox-label">COMPTE DE DISPONIBILITE A DEBITER :</span>
        <div class="checkbox-options">
          <span class="check-item">BAILLEUR <span class="box">${isBailleur ? 'x' : ''}</span></span>
          <span class="check-item">TRESOR <span class="box">${isTresor ? 'x' : ''}</span></span>
        </div>
      </div>
      
      <div class="checkbox-line">
        <span class="checkbox-label">MODE DE REGLEMENT :</span>
        <div class="checkbox-options">
          <span class="check-item">ESPECE <span class="box">${form.modeReglement === 'ESPECES' ? 'x' : ''}</span></span>
          <span class="check-item">CHEQUE <span class="box">${form.modeReglement === 'CHEQUE' ? 'x' : ''}</span></span>
          <span class="check-item">VIREMENT <span class="box">${form.modeReglement === 'VIREMENT' ? 'x' : ''}</span></span>
        </div>
      </div>
      
      <div class="field">
        REFERENCES BANCAIRES :&nbsp;&nbsp;&nbsp;<span class="field-value">${form.modeReglement === 'VIREMENT' ? (selectedRib.banque ? selectedRib.banque + ' - ' : '') + (selectedRib.numero || '') : ''}</span>
      </div>
      
      <div class="field-large">
        OBJET DE LA DEPENSE :&nbsp;&nbsp;&nbsp;<span class="field-value">${form.objet || ''}</span>
      </div>
      
      <div class="field-large">
        PIECES JUSTIFICATIVES :&nbsp;&nbsp;&nbsp;<span class="field-value">${form.piecesJustificatives || ''}</span>
      </div>
      
      <div class="budget-section">
        <div class="budget-row">
          <div class="col-left">MONTANT TOTAL :</div>
          <div class="col-center">
            <div class="value-box">${formatMontant(Math.abs(engagementActuel))}</div>
          </div>
          <div class="col-right"></div>
        </div>
        
        <div class="budget-row">
          <div class="col-left">IMPUTATION BUDGETAIRE :</div>
          <div class="col-center">
            <div class="value-box">${codeImputationComplet.trim()}</div>
          </div>
          <div class="col-right"></div>
        </div>
        
        <table class="budget-table">
          <tr>
            <td class="col-letter">A</td>
            <td class="col-label">Dotation budgtaire</td>
            <td class="col-amount">${formatMontant(getDotation())}</td>
            <td class="col-empty"></td>
          </tr>
          <tr>
            <td class="col-letter">B</td>
            <td class="col-label">Engagements antrieurs</td>
            <td class="col-amount">${formatMontant(getEngagementsAnterieurs())}</td>
            <td class="col-empty"></td>
          </tr>
          <tr>
            <td class="col-letter">C</td>
            <td class="col-label">Engagement actuel</td>
            <td class="col-amount">${formatMontant(Math.abs(engagementActuel))}</td>
            <td class="col-empty"></td>
          </tr>
          <tr>
            <td class="col-letter">D</td>
            <td class="col-label">Engagements cumuls (B + C)</td>
            <td class="col-amount">${formatMontant(engagementsCumules)}</td>
            <td class="col-empty"></td>
          </tr>
          <tr>
            <td class="col-letter">E</td>
            <td class="col-label">Disponible budgtaire (A - D)</td>
            <td class="col-amount">${formatMontant(getDisponible())}</td>
            <td class="col-empty"></td>
          </tr>
        </table>
      </div>
    </div>
    
    <div class="signatures-section">
      <div class="sig-box">
        <div class="sig-header">VISA<br/>COORDONNATRICE</div>
        <div class="sig-content">
          <div class="sig-name">ABE-KOFFI Thrse</div>
        </div>
      </div>
      <div class="sig-box">
        <div class="sig-header">VISA<br/>CONTRLEUR FINANCIER</div>
        <div class="sig-content"></div>
      </div>
      <div class="sig-box">
        <div class="sig-header">VISA AGENT<br/>COMPTABLE</div>
        <div class="sig-content"></div>
      </div>
    </div>
    
    <div class="abidjan-row">
      <div class="abidjan-cell">Abidjan, le</div>
      <div class="abidjan-cell">Abidjan, le</div>
      <div class="abidjan-cell">Abidjan, le</div>
    </div>
    
    <div class="acquit-section">
      <div class="acquit-empty"></div>
      <div class="acquit-box">
        <div class="acquit-header">ACQUIT LIBERATOIRE</div>
        <div class="acquit-content">
          <div class="acquit-date">Abidjan, le</div>
        </div>
      </div>
    </div>
  </div>
  </div>
</body>
</html>`;
                    const printWindow = window.open('', '_blank', 'width=900,height=700');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                  }}
                  style={{ ...styles.buttonSecondary, padding: '14px 24px', fontSize: 14 }}
                >
                   Imprimer
                </button>
                    <button
                      onClick={() => {
                        const pwd = window.prompt(' Mot de passe requis pour modifier :');
                        if (pwd === (projet?.motDePasseAdmin || 'admin123')) {
                          setIsEditMode(true);
                        } else if (pwd !== null) {
                          alert(' Mot de passe incorrect');
                        }
                      }}
                      style={{ ...styles.button, padding: '14px 24px', fontSize: 14, background: '#f57f17' }}
                    >
                       Modifier
                    </button>
                    <button
                      onClick={() => {
                        const pwd = window.prompt(' Mot de passe requis pour rejeter :');
                        if (pwd !== (projet?.motDePasseAdmin || 'admin123')) {
                          if (pwd !== null) alert(' Mot de passe incorrect');
                          return;
                        }
                        const motif = window.prompt('Motif du rejet :');
                        if (motif !== null) {
                          updateDoc(doc(db, 'ops', consultedOp.id), { 
                            statut: 'REJETE_CF', 
                            motifRejet: motif,
                            updatedAt: new Date().toISOString()
                          });
                          setOps(ops.map(o => o.id === consultedOp.id ? { ...o, statut: 'REJETE_CF', motifRejet: motif } : o));
                          alert(`OP ${consultedOp.numero} rejet.`);
                          exitConsultMode();
                        }
                      }}
                      style={{ ...styles.button, padding: '14px 24px', fontSize: 14, background: '#c62828' }}
                    >
                       Rejeter
                    </button>
                    <button
                      onClick={async () => {
                        const pwd = window.prompt(' Mot de passe requis pour supprimer :');
                        if (pwd !== (projet?.motDePasseAdmin || 'admin123')) {
                          if (pwd !== null) alert(' Mot de passe incorrect');
                          return;
                        }
                        
                        // Vrifier si la suppression impacte des OP suivants
                        const opsSuivants = ops.filter(o => 
                          o.sourceId === consultedOp.sourceId &&
                          o.exerciceId === consultedOp.exerciceId &&
                          o.ligneBudgetaire === consultedOp.ligneBudgetaire &&
                          (o.createdAt || '') > (consultedOp.createdAt || '') &&
                          o.id !== consultedOp.id
                        );
                        
                        let confirmMsg = `Voulez-vous vraiment supprimer l'OP ${consultedOp.numero} ?`;
                        if (opsSuivants.length > 0) {
                          const numeros = opsSuivants.slice(0, 5).map(o => o.numero).join(', ');
                          confirmMsg = ` ATTENTION : Cette suppression impactera le cumul des engagements des OP suivants sur la mme ligne budgtaire :\n${numeros}${opsSuivants.length > 5 ? '...' : ''}\n\nVoulez-vous continuer ?`;
                        }
                        
                        if (window.confirm(confirmMsg)) {
                          try {
                            await deleteDoc(doc(db, 'ops', consultedOp.id));
                            setOps(ops.filter(o => o.id !== consultedOp.id));
                            alert(` OP ${consultedOp.numero} supprim.`);
                            exitConsultMode();
                          } catch (error) {
                            alert('Erreur : ' + error.message);
                          }
                        }
                      }}
                      style={{ ...styles.button, padding: '14px 24px', fontSize: 14, background: '#424242' }}
                    >
                       Supprimer
                    </button>
                  </div>
                </div>
              ) : isEditMode ? (
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: 16, borderTop: '2px solid #f57f17' }}>
                  <div style={{ display: 'flex', gap: 10, alignItems: 'center' }}>
                    <span style={{ padding: '10px 16px', background: '#fff3e0', color: '#e65100', borderRadius: 8, fontWeight: 700, fontSize: 13 }}>
                       Modification  {consultedOp?.numero}
                    </span>
                    <button
                      onClick={() => setIsEditMode(false)}
                      style={{ ...styles.buttonSecondary, padding: '10px 16px', fontSize: 12 }}
                    >
                      Annuler
                    </button>
                  </div>
                  <button
                    onClick={async () => {
                      try {
                        if (!consultedOp?.id) return;
                        const ben = beneficiaires.find(b => b.id === form.beneficiaireId);
                        const benRibs = ben?.ribs || (ben?.rib ? [{ numero: ben.rib, banque: '' }] : []);
                        const selectedRib = benRibs[form.ribIndex || 0];
                        
                        const newMontant = parseFloat(form.montant) || consultedOp.montant;
                        
                        // Vrifier si la modification du montant impacte les OP suivants
                        if (newMontant !== consultedOp.montant) {
                          const opsSuivants = ops.filter(o => 
                            o.sourceId === consultedOp.sourceId &&
                            o.exerciceId === consultedOp.exerciceId &&
                            o.ligneBudgetaire === consultedOp.ligneBudgetaire &&
                            (o.createdAt || '') > (consultedOp.createdAt || '') &&
                            o.id !== consultedOp.id
                          );
                          
                          if (opsSuivants.length > 0) {
                            const numeros = opsSuivants.slice(0, 5).map(o => o.numero).join(', ');
                            const diff = newMontant - consultedOp.montant;
                            const confirmMsg = ` ATTENTION : Cette modification de montant (${diff > 0 ? '+' : ''}${formatMontant(diff)} F) impactera le cumul des engagements des OP suivants sur la mme ligne budgtaire :\n${numeros}${opsSuivants.length > 5 ? '...' : ''}\n\nVoulez-vous continuer ?`;
                            if (!window.confirm(confirmMsg)) return;
                          }
                        }
                        
                        const updates = {
                          type: form.type,
                          beneficiaireId: form.beneficiaireId,
                          modeReglement: form.modeReglement,
                          rib: form.modeReglement === 'VIREMENT' ? (selectedRib?.numero || '') : '',
                          banque: form.modeReglement === 'VIREMENT' ? (selectedRib?.banque || '') : '',
                          objet: form.objet,
                          piecesJustificatives: form.piecesJustificatives,
                          montant: newMontant,
                          ligneBudgetaire: form.ligneBudgetaire,
                          tvaRecuperable: form.tvaRecuperable || false,
                          montantTVA: form.tvaRecuperable ? (parseFloat(form.montantTVA) || 0) : 0,
                          updatedAt: new Date().toISOString()
                        };
                        
                        await updateDoc(doc(db, 'ops', consultedOp.id), updates);
                        setOps(ops.map(o => o.id === consultedOp.id ? { ...o, ...updates } : o));
                        setConsultedOp({ ...consultedOp, ...updates });
                        setIsEditMode(false);
                        alert(` OP ${consultedOp.numero} modifi avec succs !`);
                      } catch (error) {
                        alert('Erreur : ' + error.message);
                      }
                    }}
                    style={{ ...styles.button, padding: '14px 40px', fontSize: 16, background: '#f57f17' }}
                  >
                     ENREGISTRER LES MODIFICATIONS
                  </button>
                </div>
              ) : (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: 16, borderTop: '1px solid #e9ecef' }}>
                <button
                  type="button"
                  onClick={() => {
                    // Rutilise la mme logique d'impression que le mode consultation
                    const selectedRib = beneficiaireRibs[form.ribIndex] || {};
                    const engagementActuel = parseFloat(form.montant) || 0;
                    const engagementsCumules = getEngagementsAnterieurs() + engagementActuel;
                    const isBailleur = currentSourceObj?.sigle?.includes('IDA') || currentSourceObj?.sigle?.includes('BAD') || currentSourceObj?.sigle?.includes('UE');
                    const isTresor = currentSourceObj?.sigle?.includes('BN') || currentSourceObj?.sigle?.includes('TRESOR') || currentSourceObj?.sigle?.includes('ETAT');
                    const codeImputationComplet = (currentSourceObj?.codeImputation || '') + ' ' + (form.ligneBudgetaire || '');
                    if (!form.beneficiaireId || !form.montant) { alert('Remplissez au minimum le bnficiaire et le montant pour imprimer.'); return; }
                    alert('Pour imprimer, enregistrez d\'abord l\'OP puis consultez-le via le bouton  Consulter un OP.');
                  }}
                  style={{ ...styles.buttonSecondary, padding: '14px 24px', fontSize: 14 }}
                >
                   Imprimer
                </button>
                <button
                  onClick={handleSave}
                  disabled={saving || (getDisponible() < 0 && form.type !== 'ANNULATION')}
                  style={{
                    ...styles.button,
                    padding: '14px 40px',
                    fontSize: 16,
                    background: (getDisponible() < 0 && form.type !== 'ANNULATION') ? '#bdbdbd' : (currentSourceObj?.couleur || '#0f4c3a'),
                    cursor: (saving || (getDisponible() < 0 && form.type !== 'ANNULATION')) ? 'not-allowed' : 'pointer'
                  }}
                >
                  {saving ? 'Enregistrement...' : 'ENREGISTRER'}
                </button>
              </div>
              )}
            </div>
          </div>
        )}

        {/* Modal Consulter un OP */}
        {showConsultModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 700 }}>
              <div style={{ padding: 20, borderBottom: '1px solid #e9ecef', background: '#e3f2fd' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <h2 style={{ margin: 0, fontSize: 18, color: '#1565c0' }}> Consulter un OP</h2>
                  <button onClick={() => setShowConsultModal(false)} style={{ background: 'none', border: 'none', fontSize: 22, cursor: 'pointer' }}></button>
                </div>
              </div>
              <div style={{ padding: 20 }}>
                <input
                  type="text"
                  placeholder="Tapez le N OP, bnficiaire, objet ou montant..."
                  value={consultSearch}
                  onChange={e => setConsultSearch(e.target.value)}
                  style={{ ...styles.input, marginBottom: 12, fontSize: 14 }}
                  autoFocus
                />
                {consultSearch.trim().length >= 2 ? (
                <div style={{ maxHeight: 400, overflowY: 'auto' }}>
                  {ops
                    .filter(op => {
                      const term = consultSearch.toLowerCase();
                      const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
                      return (
                        (op.numero || '').toLowerCase().includes(term) ||
                        (ben?.nom || '').toLowerCase().includes(term) ||
                        (op.objet || '').toLowerCase().includes(term) ||
                        String(op.montant || '').includes(term)
                      );
                    })
                    .sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''))
                    .slice(0, 20)
                    .map(op => {
                      const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
                      const src = sources.find(s => s.id === op.sourceId);
                      return (
                        <div
                          key={op.id}
                          onClick={() => { loadOpForConsult(op); setShowConsultModal(false); setConsultSearch(''); }}
                          style={{
                            padding: '12px 16px',
                            borderBottom: '1px solid #f0f0f0',
                            cursor: 'pointer',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            transition: 'background 0.15s'
                          }}
                          onMouseOver={e => e.currentTarget.style.background = '#e3f2fd'}
                          onMouseOut={e => e.currentTarget.style.background = 'transparent'}
                        >
                          <div>
                            <div style={{ fontWeight: 700, fontFamily: 'monospace', fontSize: 14 }}>{op.numero}</div>
                            <div style={{ fontSize: 12, color: '#666', marginTop: 2 }}>{ben?.nom || 'N/A'}  {op.objet?.substring(0, 60) || ''}{(op.objet || '').length > 60 ? '...' : ''}</div>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <div style={{ fontWeight: 700, fontFamily: 'monospace', color: '#0f4c3a' }}>{formatMontant(op.montant)} F</div>
                            <div style={{ display: 'flex', gap: 6, marginTop: 4 }}>
                              <span style={{ padding: '2px 8px', borderRadius: 8, fontSize: 10, fontWeight: 600, background: src?.couleur || '#999', color: '#fff' }}>{src?.sigle || ''}</span>
                              <span style={{ padding: '2px 8px', borderRadius: 8, fontSize: 10, fontWeight: 600, background: op.type === 'PROVISOIRE' ? '#ff9800' : op.type === 'DIRECT' ? '#2196f3' : op.type === 'DEFINITIF' ? '#4caf50' : '#f44336', color: '#fff' }}>{op.type}</span>
                            </div>
                          </div>
                        </div>
                      );
                    })
                  }
                  {ops.filter(op => {
                    const term = consultSearch.toLowerCase();
                    const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
                    return (op.numero || '').toLowerCase().includes(term) || (ben?.nom || '').toLowerCase().includes(term) || (op.objet || '').toLowerCase().includes(term);
                  }).length === 0 && (
                    <div style={{ padding: 30, textAlign: 'center', color: '#999' }}>Aucun OP trouv</div>
                  )}
                </div>
                ) : (
                  <div style={{ padding: 30, textAlign: 'center', color: '#999' }}>
                    Saisissez au moins 2 caractres pour rechercher
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal Dupliquer un OP */}
        {showDuplicateModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 500 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#fff3e0' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <h2 style={{ margin: 0, fontSize: 18, color: '#e65100' }}> Dupliquer un OP</h2>
                  <button onClick={() => setShowDuplicateModal(false)} style={{ background: 'none', border: 'none', fontSize: 22, cursor: 'pointer' }}></button>
                </div>
              </div>
              <div style={{ padding: 24 }}>
                <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 8 }}>Rechercher un OP  dupliquer</label>
                <Autocomplete
                  options={opsPourDuplication.map(op => {
                    const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
                    return {
                      value: op.id,
                      label: `${op.numero} - ${ben?.nom || 'N/A'} (${op.type})`,
                      searchFields: [op.numero, ben?.nom || '', op.objet || '', op.type]
                    };
                  })}
                  value={null}
                  onChange={(option) => option && handleDuplicate(option.value)}
                  placeholder=" Rechercher par N, bnficiaire, objet..."
                  noOptionsMessage="Aucun OP trouv"
                  accentColor="#e65100"
                />

                {opsPourDuplication.length === 0 && (
                  <div style={{ textAlign: 'center', padding: 40, color: '#6c757d' }}>
                    <div style={{ fontSize: 40, marginBottom: 12 }}></div>
                    <p>Aucun OP cr pour cette source et cet exercice.</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // ==================== PAGE BORDEREAUX ====================
  const PageBordereaux = () => {
    const [activeTab, setActiveTab] = useState('NOUVEAU_CF');
    const [selectedOps, setSelectedOps] = useState([]);
    const [activeSourceBT, setActiveSourceBT] = useState(sources[0]?.id || null);
    const [dateBordereau, setDateBordereau] = useState(new Date().toISOString().split('T')[0]);
    const [observations, setObservations] = useState('');
    const [saving, setSaving] = useState(false);
    const [searchBT, setSearchBT] = useState('');

    const exerciceActifLocal = exercices.find(e => e.actif);
    const currentSrc = sources.find(s => s.id === activeSourceBT);

    // OP ligibles pour transmission CF : statut CREE, source et exercice actifs
    const opsEligiblesCF = ops.filter(op =>
      op.statut === 'CREE' &&
      op.sourceId === activeSourceBT &&
      op.exerciceId === exerciceActifLocal?.id &&
      !['PROVISOIRE'].includes(op.type)
    );

    // OP ligibles pour transmission AC : statut VISE_CF
    const opsEligiblesAC = ops.filter(op =>
      op.statut === 'VISE_CF' &&
      op.sourceId === activeSourceBT &&
      op.exerciceId === exerciceActifLocal?.id
    );

    const opsEligibles = activeTab === 'NOUVEAU_CF' ? opsEligiblesCF : activeTab === 'NOUVEAU_AC' ? opsEligiblesAC : [];

    // Filtrer par recherche
    const opsFiltered = opsEligibles.filter(op => {
      if (!searchBT) return true;
      const term = searchBT.toLowerCase();
      const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
      return (op.numero || '').toLowerCase().includes(term) ||
        (ben?.nom || '').toLowerCase().includes(term) ||
        (op.objet || '').toLowerCase().includes(term);
    });

    // Toggle slection d'un OP
    const toggleOp = (opId) => {
      setSelectedOps(prev => prev.includes(opId) ? prev.filter(id => id !== opId) : [...prev, opId]);
    };

    // Slectionner/Dslectionner tout
    const toggleAll = () => {
      if (selectedOps.length === opsFiltered.length) {
        setSelectedOps([]);
      } else {
        setSelectedOps(opsFiltered.map(op => op.id));
      }
    };

    // Gnrer le numro du bordereau
    const genererNumeroBT = (typeBT) => {
      const prefix = typeBT === 'CF' ? 'BT-CF' : 'BT-AC';
      const sigleProjet = projet?.sigle || 'PROJET';
      const sigleSrc = currentSrc?.sigle || 'SRC';
      const annee = exerciceActifLocal?.annee || new Date().getFullYear();
      const existants = bordereaux.filter(bt =>
        bt.type === typeBT &&
        bt.sourceId === activeSourceBT &&
        bt.exerciceId === exerciceActifLocal?.id
      );
      const nextNum = existants.length + 1;
      return `${prefix}-${String(nextNum).padStart(4, '0')}/${sigleProjet}-${sigleSrc}/${annee}`;
    };

    // Total des OP slectionns
    const totalSelected = selectedOps.reduce((sum, id) => {
      const op = ops.find(o => o.id === id);
      return sum + (op?.montant || 0);
    }, 0);

    // Crer le bordereau
    const handleCreateBordereau = async () => {
      if (selectedOps.length === 0) { alert('Veuillez slectionner au moins un OP.'); return; }
      const typeBT = activeTab === 'NOUVEAU_CF' ? 'CF' : 'AC';
      const numero = genererNumeroBT(typeBT);

      if (!window.confirm(`Crer le bordereau ${numero} avec ${selectedOps.length} OP pour un total de ${formatMontant(totalSelected)} F ?\n\nLes OP seront transmis au ${typeBT}.`)) return;

      setSaving(true);
      try {
        const btData = {
          numero,
          type: typeBT,
          sourceId: activeSourceBT,
          exerciceId: exerciceActifLocal.id,
          dateCreation: dateBordereau,
          opsIds: selectedOps,
          nbOps: selectedOps.length,
          totalMontant: totalSelected,
          statut: 'ENVOYE',
          observations: observations.trim(),
          createdAt: new Date().toISOString()
        };

        await addDoc(collection(db, 'bordereaux'), btData);

        // Mettre  jour chaque OP : statut + rfrence bordereau + date transmission
        const newStatut = typeBT === 'CF' ? 'TRANSMIS_CF' : 'TRANSMIS_AC';
        const dateField = typeBT === 'CF' ? 'dateTransmissionCF' : 'dateTransmissionAC';
        const btField = typeBT === 'CF' ? 'bordereauCF' : 'bordereauAC';

        for (const opId of selectedOps) {
          await updateDoc(doc(db, 'ops', opId), {
            statut: newStatut,
            [dateField]: dateBordereau,
            [btField]: numero,
            updatedAt: new Date().toISOString()
          });
        }

        alert(` Bordereau ${numero} cr avec succs !\n${selectedOps.length} OP transmis au ${typeBT}.`);
        setSelectedOps([]);
        setObservations('');
        setActiveTab(typeBT === 'CF' ? 'LISTE_CF' : 'LISTE_AC');
      } catch (error) {
        alert('Erreur : ' + error.message);
      }
      setSaving(false);
    };

    // Imprimer un bordereau
    const handlePrintBordereau = (bt) => {
      const src = sources.find(s => s.id === bt.sourceId);
      const btOps = bt.opsIds.map(id => ops.find(o => o.id === id)).filter(Boolean);
      const printContent = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>${bt.numero}</title>
<style>
  @page { size: A4; margin: 10mm; }
  @media print { .toolbar { display: none !important; } body { background: #fff !important; padding: 0 !important; } .page-container { box-shadow: none !important; margin: 0 !important; width: 100% !important; } }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Century Gothic', 'Trebuchet MS', sans-serif; font-size: 11px; background: #e0e0e0; }
  .toolbar { background: #1a1a2e; padding: 12px 20px; display: flex; gap: 12px; align-items: center; position: sticky; top: 0; z-index: 100; }
  .toolbar button { padding: 8px 20px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
  .btn-print { background: #2196F3; color: white; }
  .btn-pdf { background: #4CAF50; color: white; }
  .toolbar-title { color: rgba(255,255,255,0.7); margin-left: auto; font-size: 12px; }
  .page-container { width: 210mm; min-height: 297mm; margin: 20px auto; background: white; padding: 12mm; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid #1a1a2e; }
  .header-left { display: flex; align-items: center; gap: 10px; }
  .header-left img { width: 55px; height: auto; }
  .header-left .info { font-size: 9px; line-height: 1.4; }
  .header-right { text-align: right; font-size: 9px; }
  .bt-title { text-align: center; margin: 15px 0; font-size: 16px; font-weight: bold; text-transform: uppercase; text-decoration: underline; }
  .bt-numero { text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 5px; }
  .bt-date { text-align: center; font-size: 11px; margin-bottom: 15px; }
  .bt-dest { margin-bottom: 15px; font-size: 11px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
  th { background: #1a1a2e; color: white; padding: 6px 8px; font-size: 9px; text-align: left; }
  td { padding: 5px 8px; font-size: 10px; border-bottom: 1px solid #ddd; }
  tr:nth-child(even) { background: #f8f8f8; }
  .total-row { font-weight: bold; background: #e8f5e9 !important; font-size: 11px; }
  .footer { margin-top: 30px; display: flex; justify-content: space-between; }
  .footer .sign-block { width: 45%; text-align: center; }
  .footer .sign-block .title { font-weight: bold; font-size: 10px; margin-bottom: 5px; }
  .footer .sign-block .line { border-bottom: 1px dotted #333; height: 60px; }
  .accuse { margin-top: 30px; padding: 10px; border: 1px dashed #999; font-size: 10px; }
  .accuse .title { font-weight: bold; margin-bottom: 8px; }
</style></head><body>
<div class="toolbar">
  <button class="btn-print" onclick="window.print()"> Imprimer</button>
  <button class="btn-pdf" onclick="window.print()"> Exporter PDF</button>
  <span class="toolbar-title">Aperu  ${bt.numero}</span>
</div>
<div class="page-container">
  <div class="header">
    <div class="header-left">
      <img src="${ARMOIRIE}" alt="Armoirie" />
      <div class="info">
        <div style="font-weight:bold">RPUBLIQUE DE CTE D'IVOIRE</div>
        <div>Union - Discipline - Travail</div>
        <div style="margin-top:4px;font-weight:bold">${projet?.ministere || ''}</div>
        <div style="font-weight:bold">${projet?.nomProjet || ''}</div>
      </div>
    </div>
    <div class="header-right">
      <div style="font-weight:bold;font-size:11px">${src?.nom || ''}</div>
      <div>${src?.sigle || ''}</div>
    </div>
  </div>
  
  <div class="bt-title">Bordereau de Transmission ${bt.type === 'CF' ? 'au Contrleur Financier' : " l'Agent Comptable"}</div>
  <div class="bt-numero">${bt.numero}</div>
  <div class="bt-date">Date : ${bt.dateCreation}</div>
  
  <div class="bt-dest">
    <strong>De :</strong> ${projet?.titreCoordonnateur || 'Le Coordonnateur'} - ${projet?.nomProjet || ''}<br/>
    <strong> :</strong> ${bt.type === 'CF' ? 'Monsieur le Contrleur Financier' : "Monsieur l'Agent Comptable"}
    ${bt.observations ? '<br/><strong>Objet :</strong> ' + bt.observations : ''}
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:35px">N</th>
        <th style="width:130px">N OP</th>
        <th>BNFICIAIRE</th>
        <th>OBJET</th>
        <th style="width:65px">LIGNE</th>
        <th style="width:100px;text-align:right">MONTANT (FCFA)</th>
        <th style="width:50px;text-align:center">PJ</th>
      </tr>
    </thead>
    <tbody>
      ${btOps.map((op, i) => {
        const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
        return `<tr>
          <td>${i + 1}</td>
          <td style="font-family:monospace;font-weight:bold;font-size:9px">${op.numero}</td>
          <td>${ben?.nom || 'N/A'}</td>
          <td>${op.objet || '-'}</td>
          <td style="font-family:monospace">${op.ligneBudgetaire || '-'}</td>
          <td style="text-align:right;font-family:monospace;font-weight:bold">${Number(op.montant || 0).toLocaleString('fr-FR')}</td>
          <td style="text-align:center">${op.piecesJustificatives ? '' : '-'}</td>
        </tr>`;
      }).join('')}
      <tr class="total-row">
        <td colspan="5" style="text-align:right">TOTAL (${btOps.length} OP)</td>
        <td style="text-align:right;font-family:monospace">${Number(bt.totalMontant || 0).toLocaleString('fr-FR')}</td>
        <td></td>
      </tr>
    </tbody>
  </table>

  <p style="font-size:10px;margin-bottom:20px">Arrt le prsent bordereau  la somme de <strong>${Number(bt.totalMontant || 0).toLocaleString('fr-FR')} FCFA</strong> pour <strong>${btOps.length}</strong> ordre(s) de paiement.</p>

  <div class="footer">
    <div class="sign-block">
      <div class="title">${projet?.titreCoordonnateur || 'Le Coordonnateur'}</div>
      <div class="line"></div>
      <div style="font-size:9px;margin-top:4px">${projet?.coordonnateur || ''}</div>
    </div>
    <div class="sign-block">
      <div class="title">${bt.type === 'CF' ? 'Le Contrleur Financier' : "L'Agent Comptable"}</div>
      <div class="line"></div>
    </div>
  </div>

  <div class="accuse">
    <div class="title"> Accus de rception</div>
    <div>Reu le : ____/____/________  ____h____</div>
    <div style="margin-top:5px">Nombre de dossiers reus : ________</div>
    <div style="margin-top:5px">Nom et signature : _______________________________</div>
  </div>
</div>
</body></html>`;
      const pw = window.open('', '_blank', 'width=900,height=700');
      pw.document.write(printContent);
      pw.document.close();
    };

    // Supprimer un bordereau (seulement si statut ENVOYE)
    const handleDeleteBordereau = async (bt) => {
      if (bt.statut !== 'ENVOYE') {
        alert(' Impossible de supprimer un bordereau dj rceptionn ou trait.');
        return;
      }
      
      const pwd = window.prompt(' Mot de passe requis pour supprimer :');
      if (pwd !== (projet?.motDePasseAdmin || 'admin123')) {
        if (pwd !== null) alert(' Mot de passe incorrect');
        return;
      }
      
      if (!window.confirm(`Supprimer le bordereau ${bt.numero} ?\n\nLes ${bt.nbOps} OP concerns reviendront au statut prcdent.`)) return;
      
      try {
        // Remettre les OP au statut prcdent
        const previousStatut = bt.type === 'CF' ? 'CREE' : 'VISE_CF';
        const dateField = bt.type === 'CF' ? 'dateTransmissionCF' : 'dateTransmissionAC';
        const btField = bt.type === 'CF' ? 'bordereauCF' : 'bordereauAC';
        
        for (const opId of bt.opsIds) {
          await updateDoc(doc(db, 'ops', opId), {
            statut: previousStatut,
            [dateField]: null,
            [btField]: null,
            updatedAt: new Date().toISOString()
          });
        }
        
        // Supprimer le bordereau
        await deleteDoc(doc(db, 'bordereaux', bt.id));
        alert(` Bordereau ${bt.numero} supprim. Les OP sont revenus au statut ${previousStatut}.`);
      } catch (error) {
        alert('Erreur : ' + error.message);
      }
    };

    // Modifier la date d'un bordereau (seulement si statut ENVOYE)
    const handleModifyBordereauDate = async (bt) => {
      if (bt.statut !== 'ENVOYE') {
        alert(' Impossible de modifier un bordereau dj rceptionn ou trait.');
        return;
      }
      
      const pwd = window.prompt(' Mot de passe requis pour modifier :');
      if (pwd !== (projet?.motDePasseAdmin || 'admin123')) {
        if (pwd !== null) alert(' Mot de passe incorrect');
        return;
      }
      
      const newDate = window.prompt('Nouvelle date de transmission (AAAA-MM-JJ) :', bt.dateCreation);
      if (!newDate || !/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
        if (newDate !== null) alert('Format de date invalide. Utilisez AAAA-MM-JJ.');
        return;
      }
      
      try {
        const dateField = bt.type === 'CF' ? 'dateTransmissionCF' : 'dateTransmissionAC';
        
        // Mettre  jour le bordereau
        await updateDoc(doc(db, 'bordereaux', bt.id), {
          dateCreation: newDate,
          updatedAt: new Date().toISOString()
        });
        
        // Mettre  jour la date sur tous les OP
        for (const opId of bt.opsIds) {
          await updateDoc(doc(db, 'ops', opId), {
            [dateField]: newDate,
            updatedAt: new Date().toISOString()
          });
        }
        
        alert(` Date du bordereau modifie au ${newDate}.`);
      } catch (error) {
        alert('Erreur : ' + error.message);
      }
    };

    // Bordereaux filtrs par type
    const bordereauCF = bordereaux.filter(bt => bt.type === 'CF' && bt.sourceId === activeSourceBT && bt.exerciceId === exerciceActifLocal?.id);
    const bordereauAC = bordereaux.filter(bt => bt.type === 'AC' && bt.sourceId === activeSourceBT && bt.exerciceId === exerciceActifLocal?.id);
    const listeBT = activeTab === 'LISTE_CF' ? bordereauCF : activeTab === 'LISTE_AC' ? bordereauAC : [];

    return (
      <div>
        {/* En-tte */}
        <div style={{ background: '#1a1a2e', color: 'white', padding: '20px 24px', borderRadius: '10px 10px 0 0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <h1 style={{ fontSize: 24, fontWeight: 700, margin: 0 }}> Bordereaux de Transmission</h1>
        </div>

        {/* Onglets source */}
        <div style={{ display: 'flex', gap: 8, padding: '16px 0', flexWrap: 'wrap' }}>
          {sources.map(src => (
            <button key={src.id} onClick={() => { setActiveSourceBT(src.id); setSelectedOps([]); }}
              style={{ padding: '8px 16px', borderRadius: 8, border: 'none', background: activeSourceBT === src.id ? (src.couleur || '#0f4c3a') : '#f0f0f0', color: activeSourceBT === src.id ? 'white' : '#333', fontWeight: 600, cursor: 'pointer', fontSize: 13 }}>
              {src.sigle}
            </button>
          ))}
        </div>

        {/* Sous-onglets */}
        <div style={{ display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' }}>
          {[
            { key: 'NOUVEAU_CF', label: ' Nouveau BT au CF', color: '#1565c0' },
            { key: 'NOUVEAU_AC', label: ' Nouveau BT  l\'AC', color: '#2e7d32' },
            { key: 'LISTE_CF', label: ' BT au CF', count: bordereauCF.length },
            { key: 'LISTE_AC', label: ' BT  l\'AC', count: bordereauAC.length },
          ].map(tab => (
            <button key={tab.key} onClick={() => { setActiveTab(tab.key); setSelectedOps([]); }}
              style={{ padding: '10px 18px', borderRadius: 8, border: 'none', background: activeTab === tab.key ? (tab.color || '#0f4c3a') : '#f0f0f0', color: activeTab === tab.key ? 'white' : '#333', fontWeight: 600, cursor: 'pointer', fontSize: 13 }}>
              {tab.label} {tab.count !== undefined && <span style={{ background: 'rgba(255,255,255,0.2)', padding: '2px 8px', borderRadius: 10, fontSize: 11, marginLeft: 4 }}>{tab.count}</span>}
            </button>
          ))}
        </div>

        {/* Cration de bordereau */}
        {(activeTab === 'NOUVEAU_CF' || activeTab === 'NOUVEAU_AC') && (
          <div style={styles.card}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
              <h3 style={{ margin: 0, color: activeTab === 'NOUVEAU_CF' ? '#1565c0' : '#2e7d32' }}>
                {activeTab === 'NOUVEAU_CF' ? ' Transmission au Contrleur Financier' : ' Transmission  l\'Agent Comptable'}
              </h3>
              <div style={{ display: 'flex', gap: 10, alignItems: 'center' }}>
                <label style={{ fontSize: 12, fontWeight: 600 }}>Date :</label>
                <input type="date" value={dateBordereau} onChange={e => setDateBordereau(e.target.value)}
                  style={{ ...styles.input, marginBottom: 0, width: 160 }} />
              </div>
            </div>

            <input type="text" placeholder=" Rechercher un OP..." value={searchBT} onChange={e => setSearchBT(e.target.value)}
              style={{ ...styles.input, marginBottom: 12 }} />

            {opsFiltered.length === 0 ? (
              <div style={{ textAlign: 'center', padding: 40, color: '#999' }}>
                <div style={{ fontSize: 40, marginBottom: 10 }}></div>
                <p>Aucun OP {activeTab === 'NOUVEAU_CF' ? ' transmettre au CF' : 'vis par le CF  transmettre  l\'AC'} pour cette source</p>
              </div>
            ) : (
              <>
                <table style={styles.table}>
                  <thead>
                    <tr>
                      <th style={{ ...styles.th, width: 40 }}>
                        <input type="checkbox" checked={selectedOps.length === opsFiltered.length && opsFiltered.length > 0} onChange={toggleAll} />
                      </th>
                      <th style={{ ...styles.th, width: 140 }}>N OP</th>
                      <th style={styles.th}>BNFICIAIRE</th>
                      <th style={styles.th}>OBJET</th>
                      <th style={{ ...styles.th, width: 70 }}>LIGNE</th>
                      <th style={{ ...styles.th, width: 110, textAlign: 'right' }}>MONTANT</th>
                    </tr>
                  </thead>
                  <tbody>
                    {opsFiltered.map(op => {
                      const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
                      const checked = selectedOps.includes(op.id);
                      return (
                        <tr key={op.id} onClick={() => toggleOp(op.id)} style={{ cursor: 'pointer', background: checked ? '#e3f2fd' : 'transparent' }}>
                          <td style={styles.td}><input type="checkbox" checked={checked} onChange={() => toggleOp(op.id)} /></td>
                          <td style={{ ...styles.td, fontFamily: 'monospace', fontSize: 10, fontWeight: 600 }}>{op.numero}</td>
                          <td style={{ ...styles.td, fontSize: 12 }}>{ben?.nom || 'N/A'}</td>
                          <td style={{ ...styles.td, fontSize: 11, maxWidth: 200, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{op.objet || '-'}</td>
                          <td style={{ ...styles.td, fontFamily: 'monospace', fontSize: 11 }}>{op.ligneBudgetaire || '-'}</td>
                          <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', fontWeight: 600 }}>{formatMontant(op.montant)}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>

                {selectedOps.length > 0 && (
                  <div style={{ marginTop: 16, padding: 16, background: '#f5f5f5', borderRadius: 8 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                      <span style={{ fontWeight: 700, fontSize: 14 }}>
                        {selectedOps.length} OP slectionn(s)  Total : <span style={{ color: '#0f4c3a' }}>{formatMontant(totalSelected)} F</span>
                      </span>
                      <span style={{ fontFamily: 'monospace', fontSize: 12, color: '#666' }}>
                        N : {genererNumeroBT(activeTab === 'NOUVEAU_CF' ? 'CF' : 'AC')}
                      </span>
                    </div>
                    <textarea placeholder="Observations (facultatif)..." value={observations} onChange={e => setObservations(e.target.value)}
                      style={{ ...styles.input, minHeight: 60, resize: 'vertical', marginBottom: 12 }} />
                    <button onClick={handleCreateBordereau} disabled={saving}
                      style={{ ...styles.button, padding: '14px 40px', fontSize: 16, background: activeTab === 'NOUVEAU_CF' ? '#1565c0' : '#2e7d32', width: '100%' }}>
                      {saving ? 'Cration en cours...' : ` Crer le bordereau et transmettre au ${activeTab === 'NOUVEAU_CF' ? 'CF' : 'AC'}`}
                    </button>
                  </div>
                )}
              </>
            )}
          </div>
        )}

        {/* Liste des bordereaux */}
        {(activeTab === 'LISTE_CF' || activeTab === 'LISTE_AC') && (
          <div style={styles.card}>
            {listeBT.length === 0 ? (
              <div style={{ textAlign: 'center', padding: 40, color: '#999' }}>
                <div style={{ fontSize: 40, marginBottom: 10 }}></div>
                <p>Aucun bordereau {activeTab === 'LISTE_CF' ? 'au CF' : ' l\'AC'} pour cette source</p>
              </div>
            ) : (
              <table style={styles.table}>
                <thead>
                  <tr>
                    <th style={{ ...styles.th, width: 200 }}>N BORDEREAU</th>
                    <th style={{ ...styles.th, width: 100 }}>DATE</th>
                    <th style={{ ...styles.th, width: 60, textAlign: 'center' }}>NB OP</th>
                    <th style={{ ...styles.th, width: 130, textAlign: 'right' }}>TOTAL</th>
                    <th style={styles.th}>OBSERVATIONS</th>
                    <th style={{ ...styles.th, width: 100 }}>STATUT</th>
                    <th style={{ ...styles.th, width: 120, textAlign: 'center' }}>ACTIONS</th>
                  </tr>
                </thead>
                <tbody>
                  {listeBT.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || '')).map(bt => {
                    const statutBT = bt.statut === 'ENVOYE' ? { bg: '#fff3e0', color: '#e65100', label: 'Envoy' }
                      : bt.statut === 'RECEPTIONNE' ? { bg: '#e3f2fd', color: '#1565c0', label: 'Rceptionn' }
                      : { bg: '#e8f5e9', color: '#2e7d32', label: 'Trait' };
                    return (
                      <tr key={bt.id}>
                        <td style={{ ...styles.td, fontFamily: 'monospace', fontWeight: 700, fontSize: 11 }}>{bt.numero}</td>
                        <td style={{ ...styles.td, fontSize: 12 }}>{bt.dateCreation}</td>
                        <td style={{ ...styles.td, textAlign: 'center', fontWeight: 700 }}>{bt.nbOps}</td>
                        <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', fontWeight: 700 }}>{formatMontant(bt.totalMontant)}</td>
                        <td style={{ ...styles.td, fontSize: 11, maxWidth: 200, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{bt.observations || '-'}</td>
                        <td style={styles.td}>
                          <span style={{ background: statutBT.bg, color: statutBT.color, padding: '3px 8px', borderRadius: 4, fontSize: 10, fontWeight: 600 }}>{statutBT.label}</span>
                        </td>
                        <td style={{ ...styles.td, textAlign: 'center' }}>
                          <div style={{ display: 'flex', gap: 4, justifyContent: 'center' }}>
                            <button onClick={() => handlePrintBordereau(bt)} title="Imprimer"
                              style={{ background: '#e3f2fd', color: '#1565c0', border: 'none', borderRadius: 6, padding: '6px 10px', cursor: 'pointer', fontSize: 12 }}>
                              
                            </button>
                            {bt.statut === 'ENVOYE' && (
                              <>
                                <button onClick={() => handleModifyBordereauDate(bt)} title="Modifier la date"
                                  style={{ background: '#fff3e0', color: '#e65100', border: 'none', borderRadius: 6, padding: '6px 10px', cursor: 'pointer', fontSize: 12 }}>
                                  
                                </button>
                                <button onClick={() => handleDeleteBordereau(bt)} title="Supprimer"
                                  style={{ background: '#ffebee', color: '#c62828', border: 'none', borderRadius: 6, padding: '6px 10px', cursor: 'pointer', fontSize: 12 }}>
                                  
                                </button>
                              </>
                            )}
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            )}
          </div>
        )}
      </div>
    );
  };

  // ==================== PAGE LISTE DES OP ====================
  const PageListeOP = () => {
    const [activeSource, setActiveSource] = useState('ALL'); // 'ALL' pour toutes sources
    const [activeTab, setActiveTab] = useState('CUMUL_OP'); // Onglet de suivi actif
    const [showAnterieur, setShowAnterieur] = useState(false); // Afficher exercices antrieurs
    const [selectedExercice, setSelectedExercice] = useState(exerciceActif?.id || null);
    const [filters, setFilters] = useState({
      type: '',
      statut: '',
      search: '',
      ligneBudgetaire: '',
      dateDebut: '',
      dateFin: ''
    });
    const [showDetail, setShowDetail] = useState(null);
    const [showActionModal, setShowActionModal] = useState(null); // { op, action: 'DIFFERER_CF'|'REJETER_CF'|... }
    const [actionForm, setActionForm] = useState({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '', boiteArchive: '', bordereau: '' });
    const [showPaiementModal, setShowPaiementModal] = useState(null);
    const [showPasswordModal, setShowPasswordModal] = useState(null);
    const [showImportModal, setShowImportModal] = useState(false);
    const [importData, setImportData] = useState([]);
    const [importError, setImportError] = useState('');
    const [showStatutModal, setShowStatutModal] = useState(null); // { op, nouveauStatut } - pour changement manuel de statut
    const [showEditModal, setShowEditModal] = useState(null); // OP  modifier
    const [editForm, setEditForm] = useState({});
    const [showArchiveModal, setShowArchiveModal] = useState(null); // OP  archiver
    const [showTransmissionModal, setShowTransmissionModal] = useState(null); // { op, destination: 'CF'|'AC' }
    const [showCircuitModal, setShowCircuitModal] = useState(null); // OP pour modal circuit complet
    const [circuitForm, setCircuitForm] = useState({}); // Formulaire circuit

    // Exercice courant (actif ou slectionn)
    const currentExerciceId = showAnterieur ? selectedExercice : exerciceActif?.id;
    const currentExercice = exercices.find(e => e.id === currentExerciceId);
    const currentSourceObj = activeSource === 'ALL' ? null : sources.find(s => s.id === activeSource);

    // Toutes les lignes budgtaires disponibles pour l'exercice courant
    const allLignes = [...new Set(
      budgets
        .filter(b => b.exerciceId === currentExerciceId)
        .flatMap(b => b.lignes || [])
        .map(l => l.code)
    )].sort();

    // Couleurs par type
    const typeColors = {
      PROVISOIRE: '#ff9800',
      DIRECT: '#2196f3',
      DEFINITIF: '#4caf50',
      ANNULATION: '#f44336'
    };

    // Couleurs par statut
    const statutConfig = {
      CREE: { bg: '#e3f2fd', color: '#1565c0', label: 'Cr', icon: '' },
      TRANSMIS_CF: { bg: '#fff3e0', color: '#e65100', label: 'Transmis CF', icon: '' },
      DIFFERE_CF: { bg: '#fff8e1', color: '#f9a825', label: 'Diffr CF', icon: '' },
      RETOURNE_CF: { bg: '#e1f5fe', color: '#0277bd', label: 'Retourn CF', icon: '' },
      VISE_CF: { bg: '#e8f5e9', color: '#2e7d32', label: 'Vis CF', icon: '' },
      REJETE_CF: { bg: '#ffebee', color: '#c62828', label: 'Rejet CF', icon: '' },
      TRANSMIS_AC: { bg: '#f3e5f5', color: '#7b1fa2', label: 'Transmis AC', icon: '' },
      DIFFERE_AC: { bg: '#fff8e1', color: '#f9a825', label: 'Diffr AC', icon: '' },
      RETOURNE_AC: { bg: '#e1f5fe', color: '#0277bd', label: 'Retourn AC', icon: '' },
      PAYE_PARTIEL: { bg: '#fff3e0', color: '#ef6c00', label: 'Pay partiel', icon: '' },
      PAYE: { bg: '#e0f2f1', color: '#00695c', label: 'Pay', icon: '' },
      REJETE_AC: { bg: '#ffebee', color: '#c62828', label: 'Rejet AC', icon: '' },
      ARCHIVE: { bg: '#eceff1', color: '#546e7a', label: 'Archiv', icon: '' }
    };

    // OP de l'exercice courant (toutes sources ou source slectionne)
    const opsExercice = ops.filter(op => {
      if (op.exerciceId !== currentExerciceId) return false;
      if (activeSource !== 'ALL' && op.sourceId !== activeSource) return false;
      return true;
    });

    // Provisoires  rgulariser (sans DEFINITIF ou ANNULATION lis)
    const provisoiresARegulariser = opsExercice.filter(op => {
      if (op.type !== 'PROVISOIRE') return false;
      if (['REJETE_CF', 'REJETE_AC', 'ARCHIVE'].includes(op.statut)) return false;
      const hasRegularisation = opsExercice.some(o => 
        (o.type === 'DEFINITIF' || o.type === 'ANNULATION') && 
        o.opProvisoireId === op.id
      );
      return !hasRegularisation;
    });

    // Calcul anciennet en jours
    const getAnciennete = (dateStr) => {
      if (!dateStr) return 0;
      const date = new Date(dateStr);
      const now = new Date();
      return Math.floor((now - date) / (1000 * 60 * 60 * 24));
    };

    // Compteurs par onglet
    // Provisoires  annuler : OP provisoires sans dfinitif ni annulation associ
    const provisoiresAnnuler = opsExercice.filter(op => {
      if (op.type !== 'PROVISOIRE') return false;
      const hasDefinitif = opsExercice.some(o => o.opProvisoireId === op.id && o.type === 'DEFINITIF');
      const hasAnnulation = opsExercice.some(o => o.opProvisoireId === op.id && o.type === 'ANNULATION');
      return !hasDefinitif && !hasAnnulation && !['REJETE_CF', 'REJETE_AC'].includes(op.statut);
    });
    
    const counts = {
      CUMUL_OP: opsExercice.length,
      PROV_A_ANNULER: provisoiresAnnuler.length,
      A_REGULARISER: provisoiresARegulariser.length
    };

    // Filtrer selon l'onglet actif
    const getFilteredByTab = () => {
      let result = opsExercice;
      
      switch (activeTab) {
        case 'CUMUL_OP':
          // Tous les OP
          break;
        case 'PROV_A_ANNULER':
          result = provisoiresAnnuler;
          break;
        case 'A_REGULARISER':
          result = provisoiresARegulariser;
          break;
        default:
          break;
      }
      
      return result;
    };

    // Appliquer les filtres supplmentaires
    const filteredOps = getFilteredByTab().filter(op => {
      if (filters.type && op.type !== filters.type) return false;
      if (filters.statut && op.statut !== filters.statut) return false;
      if (filters.ligneBudgetaire && op.ligneBudgetaire !== filters.ligneBudgetaire) return false;
      if (filters.search) {
        const search = filters.search.toLowerCase();
        const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
        const source = sources.find(s => s.id === op.sourceId);
        if (
          !op.numero?.toLowerCase().includes(search) &&
          !ben?.nom?.toLowerCase().includes(search) &&
          !op.objet?.toLowerCase().includes(search) &&
          !source?.sigle?.toLowerCase().includes(search)
        ) return false;
      }
      if (filters.dateDebut && op.dateCreation < filters.dateDebut) return false;
      if (filters.dateFin && op.dateCreation > filters.dateFin) return false;
      return true;
    }).sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

    // Construire la liste d'affichage avec lignes de rejet ddoubles
    // Tri chronologique (plus ancien en premier) pour calculer l'ordre et le cumul
    const filteredOpsChrono = [...filteredOps].sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''));
    
    const buildDisplayOps = () => {
      const lines = [];
      // D'abord les OP dans l'ordre chronologique de cration
      filteredOpsChrono.forEach(op => {
        lines.push({ ...op, isRejetLine: false, displayDate: op.createdAt || op.dateCreation });
      });
      // Ajouter les lignes de rejet (montant ngatif) pour les OP rejets
      filteredOpsChrono.forEach(op => {
        if (['REJETE_CF', 'REJETE_AC'].includes(op.statut)) {
          lines.push({
            ...op,
            isRejetLine: true,
            displayNumero: (op.numero || '') + ' - REJET',
            displayMontant: -(op.montant || 0),
            displayDate: op.updatedAt || op.createdAt || op.dateCreation
          });
        }
      });
      // Trier par date (cration pour les normaux, date de rejet pour les lignes de rejet)
      lines.sort((a, b) => (a.displayDate || '').localeCompare(b.displayDate || ''));
      
      // Calculer ordre, cumul engag et disponible
      let cumul = 0;
      let ordre = 0;
      // Trouver la dotation pour la ligne budgtaire filtre (si filtre actif)
      const getDotationLigne = () => {
        if (!filters.ligneBudgetaire) return null;
        let totalDotation = 0;
        budgets.forEach(b => {
          if (b.lignes) {
            const ligne = b.lignes.find(l => l.code === filters.ligneBudgetaire);
            if (ligne) totalDotation += (ligne.dotation || 0);
          }
        });
        return totalDotation;
      };
      const dotation = getDotationLigne();
      
      lines.forEach(line => {
        ordre++;
        line.ordre = ordre;
        if (line.isRejetLine) {
          cumul += line.displayMontant; // ngatif
        } else if (!['REJETE_CF', 'REJETE_AC'].includes(line.statut)) {
          cumul += (line.montant || 0);
        }
        // Si l'OP est rejet mais c'est la ligne de cration, on compte quand mme le montant positif
        // car le rejet sera soustrait dans la ligne REJET
        if (!line.isRejetLine && ['REJETE_CF', 'REJETE_AC'].includes(line.statut)) {
          cumul += (line.montant || 0);
        }
        line.cumulEngage = cumul;
        line.disponible = dotation !== null ? dotation - cumul : null;
      });
      
      return lines;
    };
    
    const displayOps = buildDisplayOps();

    // Totaux
    const totaux = {
      count: filteredOps.length,
      montant: filteredOps.reduce((sum, op) => sum + (op.montant || 0), 0),
      paye: filteredOps.reduce((sum, op) => sum + (op.totalPaye || 0), 0)
    };

    // === ACTIONS ===
    
    // Ouvrir modal transmission CF
    const handleOpenTransmissionCF = (op) => {
      setActionForm({ ...actionForm, date: new Date().toISOString().split('T')[0], bordereau: op.bordereauCF || '' });
      setShowTransmissionModal({ op, destination: 'CF' });
    };

    // Ouvrir modal transmission AC
    const handleOpenTransmissionAC = (op) => {
      setActionForm({ ...actionForm, date: new Date().toISOString().split('T')[0], bordereau: op.bordereauAC || '' });
      setShowTransmissionModal({ op, destination: 'AC' });
    };

    // Confirmer transmission (CF ou AC)
    const handleConfirmTransmission = async () => {
      const { op, destination } = showTransmissionModal;
      try {
        const updates = { 
          statut: destination === 'CF' ? 'TRANSMIS_CF' : 'TRANSMIS_AC',
          updatedAt: new Date().toISOString()
        };
        
        if (destination === 'CF') {
          updates.dateTransmissionCF = actionForm.date;
          updates.bordereauCF = actionForm.bordereau.trim() || null;
        } else {
          updates.dateTransmissionAC = actionForm.date;
          updates.bordereauAC = actionForm.bordereau.trim() || null;
        }
        
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
        setShowTransmissionModal(null);
        setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '', boiteArchive: '', bordereau: '' });
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la transmission');
      }
    };

    // Viser CF
    const handleViserCF = async (op) => {
      if (!window.confirm(`Viser l'OP ${op.numero} ?`)) return;
      try {
        const updates = { 
          statut: 'VISE_CF',
          dateVisaCF: new Date().toISOString().split('T')[0],
          updatedAt: new Date().toISOString()
        };
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du visa');
      }
    };

    // Retourner pour correction (CF ou AC)
    const handleRetourner = async (op, origine) => {
      const motif = window.prompt(`Motif du retour par le ${origine} :`);
      if (!motif) return;
      try {
        const updates = { 
          statut: origine === 'CF' ? 'RETOURNE_CF' : 'RETOURNE_AC',
          [`dateRetour${origine}`]: new Date().toISOString().split('T')[0],
          [`motifRetour${origine}`]: motif.trim(),
          updatedAt: new Date().toISOString()
        };
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du retour');
      }
    };

    // Diffrer (CF ou AC)
    const handleDifferer = async () => {
      if (!actionForm.motif.trim()) {
        alert('Le motif est obligatoire');
        return;
      }
      const op = showActionModal.op;
      const isCF = showActionModal.action === 'DIFFERER_CF';
      try {
        const updates = { 
          statut: isCF ? 'DIFFERE_CF' : 'DIFFERE_AC',
          [`dateDiffere${isCF ? 'CF' : 'AC'}`]: actionForm.date,
          [`motifDiffere${isCF ? 'CF' : 'AC'}`]: actionForm.motif.trim(),
          updatedAt: new Date().toISOString()
        };
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
        setShowActionModal(null);
        setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '' });
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du diffr');
      }
    };

    // Rejeter (CF ou AC) - libre le budget (protg par mot de passe)
    const handleRejeterWithPassword = () => {
      if (!actionForm.motif.trim()) {
        alert('Le motif est obligatoire');
        return;
      }
      const op = showActionModal.op;
      const isCF = showActionModal.action === 'REJETER_CF';
      
      setShowPasswordModal({
        title: `Rejeter l'OP ${op.numero}`,
        description: `Rejet par le ${isCF ? 'CF' : 'AC'} avec motif : "${actionForm.motif.trim()}"`,
        warningMessage: `Le rejet va librer ${formatMontant(op.montant)} FCFA sur la ligne ${op.ligneBudgetaire}.`,
        confirmText: ' Confirmer le rejet',
        confirmColor: '#c62828',
        action: async () => {
          try {
            const updates = { 
              statut: isCF ? 'REJETE_CF' : 'REJETE_AC',
              dateRejet: actionForm.date,
              motifRejet: actionForm.motif.trim(),
              rejetePar: isCF ? 'CF' : 'AC',
              updatedAt: new Date().toISOString()
            };
            await updateDoc(doc(db, 'ops', op.id), updates);
            setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
            setShowActionModal(null);
            setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '' });
            setShowPasswordModal(null);
          } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors du rejet');
          }
        }
      });
    };

    // Enregistrer un paiement
    const handlePaiement = async () => {
      if (!actionForm.reference.trim()) {
        alert('La rfrence est obligatoire');
        return;
      }
      const montantPaye = parseFloat(actionForm.montant);
      if (!montantPaye || montantPaye <= 0) {
        alert('Le montant doit tre suprieur  0');
        return;
      }
      
      const op = showPaiementModal;
      const totalPayeActuel = op.totalPaye || 0;
      const resteAPayer = op.montant - totalPayeActuel;
      
      if (montantPaye > resteAPayer) {
        alert(`Le montant ne peut pas dpasser le reste  payer (${formatMontant(resteAPayer)} FCFA)`);
        return;
      }
      
      try {
        const nouveauPaiement = {
          date: actionForm.date,
          reference: actionForm.reference.trim(),
          montant: montantPaye,
          mode: op.modeReglement || 'VIREMENT'
        };
        
        const paiements = [...(op.paiements || []), nouveauPaiement];
        const nouveauTotalPaye = totalPayeActuel + montantPaye;
        const nouveauReste = op.montant - nouveauTotalPaye;
        const nouveauStatut = nouveauReste <= 0 ? 'PAYE' : 'PAYE_PARTIEL';
        
        const updates = { 
          paiements,
          totalPaye: nouveauTotalPaye,
          resteAPayer: nouveauReste,
          statut: nouveauStatut,
          datePaiement: nouveauStatut === 'PAYE' ? actionForm.date : op.datePaiement,
          updatedAt: new Date().toISOString()
        };
        
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
        setShowPaiementModal(null);
        setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '' });
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'enregistrement du paiement');
      }
    };

    // Archiver - ouvrir le modal
    const handleArchiver = (op) => {
      setActionForm({ ...actionForm, date: new Date().toISOString().split('T')[0], boiteArchive: op.boiteArchive || '' });
      setShowArchiveModal(op);
    };
    
    // Confirmer l'archivage
    const handleConfirmArchive = async () => {
      const op = showArchiveModal;
      try {
        const updates = { 
          statut: 'ARCHIVE',
          dateArchivage: actionForm.date,
          boiteArchive: actionForm.boiteArchive.trim() || null,
          updatedAt: new Date().toISOString()
        };
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
        setShowArchiveModal(null);
        setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '', boiteArchive: '' });
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'archivage');
      }
    };

    // Supprimer un OP (protg par mot de passe)
    const handleDeleteWithPassword = (op) => {
      let warningMsg = `Cette action est irrversible.`;
      
      // Avertissement selon le statut
      if (!['REJETE_CF', 'REJETE_AC', 'ARCHIVE'].includes(op.statut)) {
        warningMsg += ` Le budget de ${formatMontant(op.montant)} FCFA sur la ligne ${op.ligneBudgetaire} sera libr.`;
      }
      if (['TRANSMIS_CF', 'VISE_CF', 'TRANSMIS_AC', 'PAYE_PARTIEL', 'PAYE'].includes(op.statut)) {
        warningMsg += `  Attention : cet OP est dj en cours de traitement !`;
      }
      
      setShowPasswordModal({
        title: 'Supprimer un OP',
        description: `Supprimer dfinitivement l'OP ${op.numero} (${statutConfig[op.statut]?.label || op.statut}) ?`,
        warningMessage: warningMsg,
        confirmText: ' Confirmer la suppression',
        confirmColor: '#c62828',
        action: async () => {
          try {
            await deleteDoc(doc(db, 'ops', op.id));
            setOps(ops.filter(o => o.id !== op.id));
            setShowPasswordModal(null);
            setShowDetail(null); // Fermer le dtail si ouvert
          } catch (error) {
            console.error('Erreur:', error);
            alert('Erreur lors de la suppression');
          }
        }
      });
    };

    // Retransmettre (aprs diffr)
    const handleRetransmettre = async (op) => {
      const isCF = op.statut === 'DIFFERE_CF';
      if (!window.confirm(`Retransmettre l'OP ${op.numero} au ${isCF ? 'CF' : 'AC'} ?`)) return;
      try {
        const updates = { 
          statut: isCF ? 'TRANSMIS_CF' : 'TRANSMIS_AC',
          updatedAt: new Date().toISOString()
        };
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la retransmission');
      }
    };

    // Ouvrir le modal de changement de statut manuel
    const handleOpenStatutModal = (op) => {
      setShowStatutModal({ op });
      setActionForm({ 
        motif: '', 
        date: new Date().toISOString().split('T')[0], 
        reference: '', 
        montant: '',
        nouveauStatut: ''
      });
    };

    // Appliquer le changement de statut manuel
    const handleChangeStatut = async () => {
      const op = showStatutModal.op;
      const { nouveauStatut, date, motif } = actionForm;
      
      if (!nouveauStatut) {
        alert('Veuillez slectionner un statut');
        return;
      }
      
      // Vrifier si motif obligatoire
      if (['DIFFERE_CF', 'DIFFERE_AC', 'REJETE_CF', 'REJETE_AC'].includes(nouveauStatut) && !motif.trim()) {
        alert('Le motif est obligatoire pour ce statut');
        return;
      }
      
      // Si rejet, demander mot de passe
      if (['REJETE_CF', 'REJETE_AC'].includes(nouveauStatut)) {
        setShowPasswordModal({
          title: `Changer le statut en ${statutConfig[nouveauStatut]?.label}`,
          description: `L'OP ${op.numero} sera marqu comme rejet.`,
          warningMessage: `Le rejet va librer ${formatMontant(op.montant)} FCFA sur la ligne ${op.ligneBudgetaire}.`,
          confirmText: ' Confirmer',
          confirmColor: '#c62828',
          action: async () => {
            await saveStatutChange(op, nouveauStatut, date, motif);
            setShowPasswordModal(null);
          }
        });
        return;
      }
      
      await saveStatutChange(op, nouveauStatut, date, motif);
    };

    // Sauvegarder le changement de statut
    const saveStatutChange = async (op, nouveauStatut, date, motif) => {
      try {
        const updates = { 
          statut: nouveauStatut,
          updatedAt: new Date().toISOString()
        };
        
        // Ajouter les dates spcifiques selon le statut
        if (nouveauStatut === 'TRANSMIS_CF') updates.dateTransmissionCF = date;
        if (nouveauStatut === 'VISE_CF') updates.dateVisaCF = date;
        if (nouveauStatut === 'TRANSMIS_AC') updates.dateTransmissionAC = date;
        if (nouveauStatut === 'DIFFERE_CF') {
          updates.dateDiffereCF = date;
          updates.motifDiffereCF = motif;
        }
        if (nouveauStatut === 'DIFFERE_AC') {
          updates.dateDiffereAC = date;
          updates.motifDiffereAC = motif;
        }
        if (nouveauStatut === 'REJETE_CF' || nouveauStatut === 'REJETE_AC') {
          updates.dateRejet = date;
          updates.motifRejet = motif;
          updates.rejetePar = nouveauStatut === 'REJETE_CF' ? 'CF' : 'AC';
        }
        if (nouveauStatut === 'ARCHIVE') updates.dateArchivage = date;
        
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
        setShowStatutModal(null);
        setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '', nouveauStatut: '' });
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du changement de statut');
      }
    };

    // Dsarchiver un OP
    const handleDesarchiver = async (op) => {
      if (!window.confirm(`Dsarchiver l'OP ${op.numero} ? Il retournera au statut "Pay".`)) return;
      try {
        const updates = { 
          statut: 'PAYE',
          dateArchivage: null,
          updatedAt: new Date().toISOString()
        };
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du dsarchivage');
      }
    };

    // Ouvrir le modal de modification
    const handleOpenEdit = (op) => {
      const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
      const benRibs = ben?.ribs || (ben?.rib ? [{ numero: ben.rib, banque: '' }] : []);
      // Trouver l'index du RIB utilis
      let ribIdx = 0;
      if (op.rib && benRibs.length > 1) {
        const idx = benRibs.findIndex(r => r.numero === op.rib);
        if (idx >= 0) ribIdx = idx;
      }
      
      setEditForm({
        type: op.type || 'DIRECT',
        beneficiaireId: op.beneficiaireId || '',
        ribIndex: ribIdx,
        modeReglement: op.modeReglement || 'VIREMENT',
        objet: op.objet || '',
        piecesJustificatives: op.piecesJustificatives || '',
        montant: op.montant || '',
        ligneBudgetaire: op.ligneBudgetaire || '',
        dateCreation: op.dateCreation || '',
        tvaRecuperable: op.tvaRecuperable || false,
        montantTVA: op.montantTVA || ''
      });
      setShowEditModal(op);
    };

    // Sauvegarder les modifications
    const handleSaveEdit = async () => {
      const op = showEditModal;
      const montantModifie = parseFloat(editForm.montant) !== op.montant;
      const beneficiaireModifie = editForm.beneficiaireId !== op.beneficiaireId;
      
      // Si le montant ou le bnficiaire a chang, demander mot de passe
      if (montantModifie || beneficiaireModifie) {
        // Vrifier s'il y a des OP postrieurs sur la mme ligne
        const opsPostrieurs = ops.filter(o => 
          o.sourceId === op.sourceId &&
          o.exerciceId === op.exerciceId &&
          o.ligneBudgetaire === editForm.ligneBudgetaire &&
          o.id !== op.id &&
          (o.createdAt || '') > (op.createdAt || '')
        );
        
        let warningMsg = '';
        if (montantModifie) {
          warningMsg = `Le montant passe de ${formatMontant(op.montant)}  ${formatMontant(parseFloat(editForm.montant))} FCFA.`;
        }
        if (beneficiaireModifie) {
          const oldBen = beneficiaires.find(b => b.id === op.beneficiaireId)?.nom || 'N/A';
          const newBen = beneficiaires.find(b => b.id === editForm.beneficiaireId)?.nom || 'N/A';
          warningMsg += (warningMsg ? ' ' : '') + `Bnficiaire : ${oldBen}  ${newBen}.`;
        }
        if (opsPostrieurs.length > 0 && montantModifie) {
          warningMsg += ` Attention : ${opsPostrieurs.length} OP postrieur(s) sur cette ligne seront impacts.`;
        }
        
        setShowPasswordModal({
          title: 'Confirmer les modifications',
          description: `Modification de l'OP ${op.numero}`,
          warningMessage: warningMsg,
          confirmText: ' Confirmer la modification',
          confirmColor: '#f57f17',
          action: async () => {
            await saveEditChanges(op);
            setShowPasswordModal(null);
          }
        });
        return;
      }
      
      await saveEditChanges(op);
    };

    // Sauvegarder les modifications de l'OP
    const saveEditChanges = async (op) => {
      try {
        // Rcuprer le RIB slectionn
        const ben = beneficiaires.find(b => b.id === editForm.beneficiaireId);
        const benRibs = ben?.ribs || (ben?.rib ? [{ numero: ben.rib, banque: '' }] : []);
        const selectedRib = benRibs[editForm.ribIndex || 0];
        
        const updates = {
          type: editForm.type,
          beneficiaireId: editForm.beneficiaireId,
          modeReglement: editForm.modeReglement,
          rib: editForm.modeReglement === 'VIREMENT' ? (selectedRib?.numero || '') : '',
          banque: editForm.modeReglement === 'VIREMENT' ? (selectedRib?.banque || '') : '',
          objet: editForm.objet,
          piecesJustificatives: editForm.piecesJustificatives,
          montant: parseFloat(editForm.montant) || op.montant,
          ligneBudgetaire: editForm.ligneBudgetaire,
          dateCreation: editForm.dateCreation,
          tvaRecuperable: editForm.tvaRecuperable || false,
          montantTVA: editForm.tvaRecuperable ? (parseFloat(editForm.montantTVA) || 0) : 0,
          updatedAt: new Date().toISOString()
        };
        
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
        setShowEditModal(null);
        setEditForm({});
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la modification');
      }
    };

    // Export Excel
    const handleExport = () => {
      const headers = ['Source', 'N OP', 'Cration', 'Type', 'Bnficiaire', 'Objet', 'Ligne', 'Montant', 'Trans. CF', 'Visa CF', 'Trans. AC', 'Pay', 'Reste', 'Statut', 'Motif Rejet/Diffr'];
      const rows = filteredOps.map(op => {
        const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
        const source = sources.find(s => s.id === op.sourceId);
        const motif = op.motifRejet || op.motifDiffereCF || op.motifDiffereAC || '';
        return [
          source?.sigle || '',
          op.numero,
          op.dateCreation || '',
          op.type,
          ben?.nom || '',
          op.objet || '',
          op.ligneBudgetaire || '',
          op.montant || 0,
          op.dateTransmissionCF || '',
          op.dateVisaCF || '',
          op.dateTransmissionAC || '',
          op.totalPaye || 0,
          (op.montant || 0) - (op.totalPaye || 0),
          statutConfig[op.statut]?.label || op.statut,
          motif
        ];
      });

      const csvContent = '\uFEFF' + [headers, ...rows].map(row => 
        row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(';')
      ).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `OP_${activeSource === 'ALL' ? 'TOUTES_SOURCES' : currentSourceObj?.sigle}_${currentExercice?.annee || 'TOUS'}_${activeTab}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // Ouvrir le modal de gestion complte du circuit
    const handleOpenCircuitModal = (op) => {
      setCircuitForm({
        statut: op.statut,
        dateCreation: op.dateCreation || '',
        dateTransmissionCF: op.dateTransmissionCF || '',
        bordereauCF: op.bordereauCF || '',
        dateVisaCF: op.dateVisaCF || '',
        numeroVisaCF: op.numeroVisaCF || '',
        dateTransmissionAC: op.dateTransmissionAC || '',
        bordereauAC: op.bordereauAC || '',
        datePaiement: op.datePaiement || '',
        referencePaiement: op.referencePaiement || '',
        dateArchivage: op.dateArchivage || '',
        boiteArchive: op.boiteArchive || '',
        dateDiffereCF: op.dateDiffereCF || '',
        motifDiffereCF: op.motifDiffereCF || '',
        dateDiffereAC: op.dateDiffereAC || '',
        motifDiffereAC: op.motifDiffereAC || '',
        dateRejet: op.dateRejet || '',
        motifRejet: op.motifRejet || '',
        rejetePar: op.rejetePar || ''
      });
      setShowCircuitModal(op);
    };

    // Sauvegarder les modifications du circuit
    const handleSaveCircuit = async () => {
      const op = showCircuitModal;
      const nouveauStatut = circuitForm.statut;
      
      // Si rejet avec motif renseign, demander mot de passe
      if (['REJETE_CF', 'REJETE_AC'].includes(nouveauStatut) && !['REJETE_CF', 'REJETE_AC'].includes(op.statut)) {
        setShowPasswordModal({
          title: `Rejeter l'OP ${op.numero}`,
          description: `L'OP sera marqu comme rejet par le ${nouveauStatut === 'REJETE_CF' ? 'CF' : 'AC'}.`,
          warningMessage: `Le rejet va librer ${formatMontant(op.montant)} FCFA sur la ligne ${op.ligneBudgetaire}.`,
          confirmText: ' Confirmer le rejet',
          confirmColor: '#c62828',
          action: async () => {
            await saveCircuitChanges(op);
            setShowPasswordModal(null);
          }
        });
        return;
      }
      
      await saveCircuitChanges(op);
    };
    
    const saveCircuitChanges = async (op) => {
      try {
        const updates = {
          statut: circuitForm.statut,
          dateCreation: circuitForm.dateCreation || null,
          dateTransmissionCF: circuitForm.dateTransmissionCF || null,
          bordereauCF: circuitForm.bordereauCF || null,
          dateVisaCF: circuitForm.dateVisaCF || null,
          numeroVisaCF: circuitForm.numeroVisaCF || null,
          dateTransmissionAC: circuitForm.dateTransmissionAC || null,
          bordereauAC: circuitForm.bordereauAC || null,
          datePaiement: circuitForm.datePaiement || null,
          referencePaiement: circuitForm.referencePaiement || null,
          dateArchivage: circuitForm.dateArchivage || null,
          boiteArchive: circuitForm.boiteArchive || null,
          dateDiffereCF: circuitForm.dateDiffereCF || null,
          motifDiffereCF: circuitForm.motifDiffereCF || null,
          dateDiffereAC: circuitForm.dateDiffereAC || null,
          motifDiffereAC: circuitForm.motifDiffereAC || null,
          dateRejet: circuitForm.dateRejet || null,
          motifRejet: circuitForm.motifRejet || null,
          rejetePar: circuitForm.rejetePar || null,
          updatedAt: new Date().toISOString()
        };
        
        await updateDoc(doc(db, 'ops', op.id), updates);
        setOps(ops.map(o => o.id === op.id ? { ...o, ...updates } : o));
        setShowCircuitModal(null);
        setCircuitForm({});
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la mise  jour');
      }
    };

    return (
      <div>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
            <h1 style={{ fontSize: 24, fontWeight: 700, margin: 0 }}> Liste des Ordres de Paiement</h1>
            {currentExercice && (
              <span style={{ 
                background: showAnterieur ? '#fff3e0' : '#e8f5e9', 
                color: showAnterieur ? '#e65100' : '#2e7d32', 
                padding: '6px 14px', 
                borderRadius: 20, 
                fontWeight: 700,
                fontSize: 14
              }}>
                {currentExercice.annee}
              </span>
            )}
          </div>
          <div style={{ display: 'flex', gap: 12 }}>
            <button onClick={handleExport} style={{ ...styles.buttonSecondary, background: '#e8f5e9', color: '#2e7d32' }}>
               Export Excel
            </button>
            <button onClick={() => setCurrentPage('nouvelOp')} style={styles.button}>
               Nouvel OP
            </button>
          </div>
        </div>

        {/* Slecteur d'exercice */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 16, marginBottom: 16, padding: 12, background: '#f8f9fa', borderRadius: 8 }}>
          <label style={{ display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' }}>
            <input 
              type="checkbox" 
              checked={showAnterieur}
              onChange={(e) => {
                setShowAnterieur(e.target.checked);
                if (!e.target.checked) setSelectedExercice(exerciceActif?.id);
              }}
              style={{ width: 18, height: 18 }}
            />
            <span style={{ fontSize: 13, fontWeight: 500 }}> Afficher exercices antrieurs</span>
          </label>
          {showAnterieur && (
            <select
              value={selectedExercice || ''}
              onChange={(e) => setSelectedExercice(e.target.value)}
              style={{ ...styles.input, marginBottom: 0, width: 150, padding: '8px 12px' }}
            >
              {exercices.map(ex => (
                <option key={ex.id} value={ex.id}>
                  {ex.annee} {ex.actif ? '(actif)' : ''}
                </option>
              ))}
            </select>
          )}
          {showAnterieur && (
            <span style={{ fontSize: 12, color: '#6c757d', fontStyle: 'italic' }}>
               Consultation seule - les modifications ne sont pas recommandes sur les exercices clos
            </span>
          )}
        </div>

        {/* Onglets de suivi */}
        <div style={{ display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap', alignItems: 'center' }}>
          {[
            { key: 'CUMUL_OP', label: 'Cumul OP', icon: '' },
            { key: 'PROV_A_ANNULER', label: 'Provisoires  annuler', icon: '' },
            { key: 'A_REGULARISER', label: ' rgulariser', icon: '' }
          ].map(tab => (
            <button
              key={tab.key}
              onClick={() => setActiveTab(tab.key)}
              style={{
                padding: '10px 16px',
                borderRadius: 8,
                border: 'none',
                background: activeTab === tab.key ? '#0f4c3a' : '#f0f0f0',
                color: activeTab === tab.key ? 'white' : '#333',
                fontWeight: 600,
                fontSize: 13,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: 6
              }}
            >
              {tab.icon} {tab.label} <span style={{ 
                background: activeTab === tab.key ? 'rgba(255,255,255,0.2)' : '#ddd',
                padding: '2px 8px',
                borderRadius: 10,
                fontSize: 11
              }}>
                {counts[tab.key]}
              </span>
            </button>
          ))}
          
          {/* Bouton Importer des OP */}
          <button
            onClick={() => setShowImportModal(true)}
            style={{
              padding: '10px 16px',
              borderRadius: 8,
              border: '2px dashed #1565c0',
              background: '#e3f2fd',
              color: '#1565c0',
              fontWeight: 600,
              fontSize: 13,
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: 6,
              marginLeft: 'auto'
            }}
          >
             Importer des OP
          </button>
        </div>

        {/* Onglets sources */}
        <div style={{ display: 'flex', gap: 0, marginBottom: 20, borderBottom: '2px solid #e9ecef' }}>
          <button
            onClick={() => setActiveSource('ALL')}
            style={{
              padding: '12px 20px',
              border: 'none',
              borderBottom: activeSource === 'ALL' ? '3px solid #0f4c3a' : '3px solid transparent',
              background: 'transparent',
              color: activeSource === 'ALL' ? '#0f4c3a' : '#6c757d',
              fontWeight: 600,
              cursor: 'pointer',
              marginBottom: -2
            }}
          >
             TOUTES
          </button>
          {sources.map(source => (
            <button
              key={source.id}
              onClick={() => setActiveSource(source.id)}
              style={{
                padding: '12px 20px',
                border: 'none',
                borderBottom: activeSource === source.id ? `3px solid ${source.couleur}` : '3px solid transparent',
                background: 'transparent',
                color: activeSource === source.id ? source.couleur : '#6c757d',
                fontWeight: 600,
                cursor: 'pointer',
                marginBottom: -2
              }}
            >
              {source.sigle}
            </button>
          ))}
        </div>

        {/* Filtres */}
        <div style={{ ...styles.card, marginBottom: 20, padding: 16 }}>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 130px 130px 150px 110px 110px', gap: 12, alignItems: 'end' }}>
            <div>
              <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 4, color: '#6c757d' }}>RECHERCHE</label>
              <input
                type="text"
                value={filters.search}
                onChange={(e) => setFilters({ ...filters, search: e.target.value })}
                placeholder=" N, bnficiaire, objet..."
                style={{ ...styles.input, marginBottom: 0 }}
              />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 4, color: '#6c757d' }}>TYPE</label>
              <select
                value={filters.type}
                onChange={(e) => setFilters({ ...filters, type: e.target.value })}
                style={{ ...styles.input, marginBottom: 0 }}
              >
                <option value="">Tous</option>
                <option value="PROVISOIRE">Provisoire</option>
                <option value="DIRECT">Direct</option>
                <option value="DEFINITIF">Dfinitif</option>
                <option value="ANNULATION">Annulation</option>
              </select>
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 4, color: '#6c757d' }}>STATUT</label>
              <select
                value={filters.statut}
                onChange={(e) => setFilters({ ...filters, statut: e.target.value })}
                style={{ ...styles.input, marginBottom: 0 }}
              >
                <option value="">Tous</option>
                {Object.entries(statutConfig).map(([key, val]) => (
                  <option key={key} value={key}>{val.label}</option>
                ))}
              </select>
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 4, color: '#6c757d' }}>LIGNE BUDGTAIRE</label>
              <select
                value={filters.ligneBudgetaire}
                onChange={(e) => setFilters({ ...filters, ligneBudgetaire: e.target.value })}
                style={{ ...styles.input, marginBottom: 0 }}
              >
                <option value="">Toutes</option>
                {allLignes.map(code => (
                  <option key={code} value={code}>{code}</option>
                ))}
              </select>
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 4, color: '#6c757d' }}>DU</label>
              <input
                type="date"
                value={filters.dateDebut}
                onChange={(e) => setFilters({ ...filters, dateDebut: e.target.value })}
                style={{ ...styles.input, marginBottom: 0 }}
              />
            </div>
            <div>
              <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 4, color: '#6c757d' }}>AU</label>
              <input
                type="date"
                value={filters.dateFin}
                onChange={(e) => setFilters({ ...filters, dateFin: e.target.value })}
                style={{ ...styles.input, marginBottom: 0 }}
              />
            </div>
          </div>
        </div>

        {/* Tableau */}
        <div style={styles.card}>
          <div style={{ marginBottom: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <span style={{ color: '#6c757d', fontSize: 14 }}>
              {totaux.count} OP - Montant : <strong>{formatMontant(totaux.montant)}</strong>
              {totaux.paye > 0 && <> - Pay : <strong style={{ color: '#2e7d32' }}>{formatMontant(totaux.paye)}</strong></>}
            </span>
            {(filters.type || filters.statut || filters.search || filters.ligneBudgetaire || filters.dateDebut || filters.dateFin) && (
              <button 
                onClick={() => setFilters({ type: '', statut: '', search: '', ligneBudgetaire: '', dateDebut: '', dateFin: '' })}
                style={{ ...styles.buttonSecondary, padding: '4px 12px', fontSize: 12 }}
              >
                 Effacer filtres
              </button>
            )}
          </div>

          {filteredOps.length === 0 ? (
            <div style={{ textAlign: 'center', padding: 60, color: '#6c757d' }}>
              <div style={{ fontSize: 50, marginBottom: 16 }}></div>
              <p>Aucun OP trouv</p>
            </div>
          ) : (
            <div style={{ overflowX: 'auto', overflowY: 'auto', maxHeight: '60vh' }}>
              <table style={styles.table}>
                <thead style={{ position: 'sticky', top: 0, zIndex: 10 }}>
                  <tr>
                    <th style={{ ...styles.th, width: 45 }}>N</th>
                    {activeSource === 'ALL' && <th style={{ ...styles.th, width: 60 }}>SOURCE</th>}
                    <th style={{ ...styles.th, width: 145 }}>N OP</th>
                    <th style={{ ...styles.th, width: 75 }}>TYPE</th>
                    <th style={{ ...styles.th, width: 140 }}>BNFICIAIRE</th>
                    <th style={styles.th}>OBJET</th>
                    <th style={{ ...styles.th, width: 70 }}>LIGNE</th>
                    <th style={{ ...styles.th, width: 100, textAlign: 'right' }}>DOTATION</th>
                    <th style={{ ...styles.th, width: 100, textAlign: 'right' }}>MONTANT</th>
                    {activeTab === 'A_REGULARISER' && <th style={{ ...styles.th, width: 80 }}>ANCIENNET</th>}
                    <th style={{ ...styles.th, width: 110, textAlign: 'right' }}>CUMUL ENGAG</th>
                    {filters.ligneBudgetaire && <th style={{ ...styles.th, width: 110, textAlign: 'right' }}>DISPONIBLE</th>}
                    <th style={{ ...styles.th, width: 95 }}>STATUT</th>
                    <th style={{ ...styles.th, width: 100, textAlign: 'center' }}>ACTIONS</th>
                  </tr>
                </thead>
                <tbody>
                  {displayOps.map((op, idx) => {
                    const ben = beneficiaires.find(b => b.id === op.beneficiaireId);
                    const source = sources.find(s => s.id === op.sourceId);
                    const isRejet = op.isRejetLine;
                    
                    // Ne pas afficher les lignes de rejet (dsengagement) - demand par Carole
                    if (isRejet) return null;
                    
                    // Ne pas afficher le statut "Cr" - demand par Carole
                    const statutObj = op.statut === 'CREE' 
                      ? { bg: 'transparent', color: 'transparent', label: '' }
                      : (statutConfig[op.statut] || { bg: '#f5f5f5', color: '#666', label: op.statut });
                    const anciennete = getAnciennete(op.dateCreation);
                    
                    // Rcuprer la dotation de la ligne budgtaire
                    const currentBudget = budgets.find(b => b.sourceId === op.sourceId && b.exerciceId === op.exerciceId);
                    const ligneBudget = currentBudget?.lignes?.find(l => l.code === op.ligneBudgetaire);
                    const dotationLigne = ligneBudget?.dotation || 0;
                    
                    return (
                      <tr key={op.id} style={{ cursor: 'pointer' }} onClick={() => setShowDetail(op)}>
                        <td style={{ ...styles.td, textAlign: 'center', fontWeight: 700, fontSize: 12, color: '#666' }}>
                          {op.ordre}
                        </td>
                        {activeSource === 'ALL' && (
                          <td style={styles.td}>
                            <span style={{ 
                              background: source?.couleur || '#666', 
                              color: 'white', 
                              padding: '2px 6px', 
                              borderRadius: 4, 
                              fontSize: 10, 
                              fontWeight: 600 
                            }}>
                              {source?.sigle || '?'}
                            </span>
                          </td>
                        )}
                        <td style={{ ...styles.td, fontFamily: 'monospace', fontSize: 10, fontWeight: 600 }}>
                          {op.numero}
                        </td>
                        <td style={styles.td}>
                          <span style={{
                            background: `${typeColors[op.type]}20`,
                            color: typeColors[op.type],
                            padding: '2px 6px',
                            borderRadius: 4,
                            fontSize: 9,
                            fontWeight: 600
                          }}>
                            {op.type}
                          </span>
                        </td>
                        <td style={{ ...styles.td, fontSize: 11 }}>{ben?.nom || 'N/A'}</td>
                        <td style={{ ...styles.td, fontSize: 11, maxWidth: 180, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }} title={op.objet}>
                          {op.objet || '-'}
                        </td>
                        <td style={{ ...styles.td, fontSize: 11, fontFamily: 'monospace' }}>{op.ligneBudgetaire || '-'}</td>
                        <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', fontSize: 11, color: '#666' }}>
                          {formatMontant(dotationLigne)}
                        </td>
                        <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', fontWeight: 600, fontSize: 11 }}>
                          {formatMontant(op.montant)}
                        </td>
                        {activeTab === 'A_REGULARISER' && (
                          <td style={styles.td}>
                            <span style={{
                              background: anciennete > 30 ? '#ffebee' : anciennete > 15 ? '#fff3e0' : '#e8f5e9',
                              color: anciennete > 30 ? '#c62828' : anciennete > 15 ? '#e65100' : '#2e7d32',
                              padding: '3px 8px',
                              borderRadius: 4,
                              fontSize: 11,
                              fontWeight: 600
                            }}>
                              {anciennete}j
                            </span>
                          </td>
                        )}
                        <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', fontWeight: 600, fontSize: 11 }}>
                          {formatMontant(op.cumulEngage || 0)}
                        </td>
                        {filters.ligneBudgetaire && (
                          <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace', fontWeight: 600, fontSize: 11, color: (op.disponible || 0) < 0 ? '#c62828' : '#2e7d32' }}>
                            {op.disponible !== null ? formatMontant(op.disponible) : '-'}
                          </td>
                        )}
                        <td style={styles.td}>
                          <span style={{
                            background: statutObj.bg,
                            color: statutObj.color,
                            padding: '3px 8px',
                            borderRadius: 4,
                            fontSize: 10,
                            fontWeight: 600
                          }}>
                            {statutObj.label}
                          </span>
                        </td>
                        <td style={{ ...styles.td, textAlign: 'center' }} onClick={(e) => e.stopPropagation()}>
                          {!isRejet ? (
                          <div style={{ display: 'flex', gap: 6, justifyContent: 'center' }}>
                            {/* Bouton Consulter OP */}
                            <button
                              onClick={(e) => { e.stopPropagation(); setConsultOpData(op); setCurrentPage('nouvelOp'); }}
                              title="Consulter l'OP"
                              style={{ 
                                background: '#e3f2fd', 
                                color: '#1565c0', 
                                border: 'none', 
                                borderRadius: 6, 
                                padding: '8px 12px', 
                                cursor: 'pointer', 
                                fontSize: 14
                              }}
                            >
                              
                            </button>
                            {/* Bouton Circuit */}
                            <button
                              onClick={(e) => { e.stopPropagation(); handleOpenCircuitModal(op); }}
                              title="Grer le circuit"
                              style={{ 
                                background: '#e3f2fd', 
                                color: '#1565c0', 
                                border: 'none', 
                                borderRadius: 6, 
                                padding: '8px 12px', 
                                cursor: 'pointer', 
                                fontSize: 14
                              }}
                            >
                              
                            </button>
                          </div>
                          ) : (
                            <span style={{ color: '#c62828', fontSize: 11, fontWeight: 600 }}> Dsengagement</span>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </div>

        {/* Modal Import OP */}
        {showImportModal && (
          <div style={styles.modal} onClick={() => { setShowImportModal(false); setImportData([]); setImportError(''); }}>
            <div style={{ ...styles.modalContent, maxWidth: 900 }} onClick={(e) => e.stopPropagation()}>
              <div style={{ padding: 20, borderBottom: '1px solid #e9ecef', background: '#1565c0', color: 'white' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}> Importer des OP depuis Excel/CSV</h2>
              </div>
              <div style={{ padding: 24, maxHeight: '70vh', overflowY: 'auto' }}>
                <div style={{ marginBottom: 20, padding: 16, background: '#e3f2fd', borderRadius: 8, fontSize: 13 }}>
                  <strong> Format attendu (colonnes) :</strong><br/>
                  Type | Bnficiaire (NCC) | Objet | Ligne Budgtaire | Montant | Date Cration
                </div>
                
                <input 
                  type="file" 
                  accept=".csv,.xlsx,.xls"
                  onChange={(e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                      try {
                        const text = evt.target.result;
                        const lines = text.split('\n').filter(l => l.trim());
                        const headers = lines[0].split(/[;,\t]/);
                        
                        const data = lines.slice(1).map((line, idx) => {
                          const cols = line.split(/[;,\t]/);
                          return {
                            idx: idx + 1,
                            type: (cols[0] || '').trim().toUpperCase(),
                            beneficiaire: (cols[1] || '').trim(),
                            objet: (cols[2] || '').trim(),
                            ligneBudgetaire: (cols[3] || '').trim(),
                            montant: parseFloat((cols[4] || '0').replace(/[^\d.-]/g, '')) || 0,
                            dateCreation: (cols[5] || new Date().toISOString().split('T')[0]).trim(),
                            valid: true,
                            error: ''
                          };
                        }).filter(d => d.type || d.beneficiaire || d.montant);
                        
                        // Validation
                        data.forEach(d => {
                          if (!['PROVISOIRE', 'DIRECT', 'DEFINITIF', 'ANNULATION'].includes(d.type)) {
                            d.valid = false;
                            d.error = 'Type invalide';
                          }
                          if (!d.beneficiaire) {
                            d.valid = false;
                            d.error = 'Bnficiaire manquant';
                          }
                          if (!d.montant || d.montant <= 0) {
                            d.valid = false;
                            d.error = 'Montant invalide';
                          }
                        });
                        
                        setImportData(data);
                        setImportError('');
                      } catch (err) {
                        setImportError('Erreur de lecture du fichier : ' + err.message);
                        setImportData([]);
                      }
                    };
                    reader.readAsText(file);
                  }}
                  style={{ marginBottom: 16 }}
                />
                
                {importError && (
                  <div style={{ padding: 12, background: '#ffebee', color: '#c62828', borderRadius: 6, marginBottom: 16 }}>
                     {importError}
                  </div>
                )}
                
                {importData.length > 0 && (
                  <>
                    <div style={{ marginBottom: 12, fontSize: 13 }}>
                      <strong>{importData.length}</strong> lignes dtectes  
                      <span style={{ color: '#2e7d32' }}> {importData.filter(d => d.valid).length} valides</span> / 
                      <span style={{ color: '#c62828' }}> {importData.filter(d => !d.valid).length} erreurs</span>
                    </div>
                    
                    <div style={{ maxHeight: 300, overflowY: 'auto', border: '1px solid #ddd', borderRadius: 6 }}>
                      <table style={styles.table}>
                        <thead>
                          <tr>
                            <th style={{ ...styles.th, width: 40 }}>#</th>
                            <th style={{ ...styles.th, width: 80 }}>Type</th>
                            <th style={styles.th}>Bnficiaire</th>
                            <th style={styles.th}>Objet</th>
                            <th style={{ ...styles.th, width: 70 }}>Ligne</th>
                            <th style={{ ...styles.th, width: 100, textAlign: 'right' }}>Montant</th>
                            <th style={{ ...styles.th, width: 100 }}>Statut</th>
                          </tr>
                        </thead>
                        <tbody>
                          {importData.map(d => (
                            <tr key={d.idx} style={{ background: d.valid ? 'transparent' : '#fff8f8' }}>
                              <td style={styles.td}>{d.idx}</td>
                              <td style={styles.td}>{d.type}</td>
                              <td style={styles.td}>{d.beneficiaire}</td>
                              <td style={{ ...styles.td, maxWidth: 150, overflow: 'hidden', textOverflow: 'ellipsis' }}>{d.objet}</td>
                              <td style={styles.td}>{d.ligneBudgetaire}</td>
                              <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace' }}>{formatMontant(d.montant)}</td>
                              <td style={styles.td}>
                                {d.valid ? (
                                  <span style={{ color: '#2e7d32', fontSize: 12 }}> OK</span>
                                ) : (
                                  <span style={{ color: '#c62828', fontSize: 11 }}> {d.error}</span>
                                )}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    
                    <div style={{ marginTop: 20, display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
                      <button onClick={() => { setShowImportModal(false); setImportData([]); }} style={styles.buttonSecondary}>
                        Annuler
                      </button>
                      <button 
                        onClick={async () => {
                          const validOps = importData.filter(d => d.valid);
                          if (validOps.length === 0) {
                            alert('Aucun OP valide  importer');
                            return;
                          }
                          
                          if (!window.confirm(`Importer ${validOps.length} OP ?`)) return;
                          
                          try {
                            for (const d of validOps) {
                              // Trouver le bnficiaire par NCC ou nom
                              const ben = beneficiaires.find(b => 
                                b.ncc === d.beneficiaire || 
                                b.nom.toLowerCase().includes(d.beneficiaire.toLowerCase())
                              );
                              
                              // Gnrer le numro
                              const sigleProjet = projet?.sigle || 'PROJET';
                              const sigleSrc = sources.find(s => s.id === activeSource)?.sigle || 'SRC';
                              const annee = exerciceActif?.annee || new Date().getFullYear();
                              const existants = ops.filter(o => o.sourceId === (activeSource === 'ALL' ? sources[0]?.id : activeSource) && o.exerciceId === exerciceActif?.id);
                              const nextNum = existants.length + 1;
                              const numero = `N${String(nextNum).padStart(4, '0')}/${sigleProjet}-${sigleSrc}/${annee}`;
                              
                              const opData = {
                                numero,
                                type: d.type,
                                beneficiaireId: ben?.id || null,
                                beneficiaireNom: ben?.nom || d.beneficiaire,
                                objet: d.objet,
                                ligneBudgetaire: d.ligneBudgetaire,
                                montant: d.montant,
                                dateCreation: d.dateCreation,
                                statut: 'CREE',
                                sourceId: activeSource === 'ALL' ? sources[0]?.id : activeSource,
                                exerciceId: exerciceActif?.id,
                                createdAt: new Date().toISOString(),
                                importedAt: new Date().toISOString()
                              };
                              
                              await addDoc(collection(db, 'ops'), opData);
                            }
                            
                            alert(` ${validOps.length} OP imports avec succs !`);
                            setShowImportModal(false);
                            setImportData([]);
                          } catch (err) {
                            alert('Erreur import : ' + err.message);
                          }
                        }}
                        disabled={importData.filter(d => d.valid).length === 0}
                        style={{ ...styles.button, background: importData.filter(d => d.valid).length === 0 ? '#ccc' : '#2e7d32' }}
                      >
                         Importer {importData.filter(d => d.valid).length} OP
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal Dtail OP */}
        {showDetail && (
          <div style={styles.modal} onClick={() => setShowDetail(null)}>
            <div style={{ ...styles.modalContent, maxWidth: 700 }} onClick={(e) => e.stopPropagation()}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: sources.find(s => s.id === showDetail.sourceId)?.couleur || '#0f4c3a', color: 'white' }}>
                <h2 style={{ margin: 0, fontSize: 18 }}> {showDetail.numero}</h2>
              </div>
              <div style={{ padding: 24, maxHeight: '70vh', overflowY: 'auto' }}>
                {(() => {
                  const ben = beneficiaires.find(b => b.id === showDetail.beneficiaireId);
                  const statut = statutConfig[showDetail.statut] || { label: showDetail.statut };
                  const source = sources.find(s => s.id === showDetail.sourceId);
                  
                  // Calcul des engagements antrieurs sur la mme ligne
                  const currentBudget = budgets.find(b => b.sourceId === showDetail.sourceId && b.exerciceId === showDetail.exerciceId);
                  const ligne = currentBudget?.lignes?.find(l => l.code === showDetail.ligneBudgetaire);
                  const dotation = ligne?.dotation || 0;
                  
                  const opsAnterieurs = ops.filter(o => 
                    o.sourceId === showDetail.sourceId &&
                    o.exerciceId === showDetail.exerciceId &&
                    o.ligneBudgetaire === showDetail.ligneBudgetaire &&
                    o.id !== showDetail.id &&
                    !['REJETE_CF', 'REJETE_AC'].includes(o.statut) &&
                    (o.createdAt || '') < (showDetail.createdAt || '')
                  );
                  
                  const engagementsAnterieurs = opsAnterieurs.reduce((sum, o) => {
                    if (o.type === 'PROVISOIRE' || o.type === 'DIRECT') return sum + (o.montant || 0);
                    if (o.type === 'DEFINITIF') {
                      // Le dfinitif remplace le provisoire
                      const prov = ops.find(p => p.id === o.opProvisoireId);
                      return sum - (prov?.montant || 0) + (o.montant || 0);
                    }
                    if (o.type === 'ANNULATION') {
                      // L'annulation libre le montant du provisoire li
                      const prov = ops.find(p => p.id === o.opProvisoireId);
                      return sum - (prov?.montant || 0);
                    }
                    return sum;
                  }, 0);
                  
                  return (
                    <div style={{ display: 'grid', gap: 16 }}>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16 }}>
                        <div>
                          <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>SOURCE</label>
                          <div style={{ marginTop: 4 }}>
                            <span style={{ background: source?.couleur || '#666', color: 'white', padding: '4px 12px', borderRadius: 4, fontWeight: 600 }}>
                              {source?.sigle || '?'}
                            </span>
                          </div>
                        </div>
                        <div>
                          <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>TYPE</label>
                          <div style={{ marginTop: 4 }}>
                            <span style={{ background: `${typeColors[showDetail.type]}20`, color: typeColors[showDetail.type], padding: '4px 12px', borderRadius: 4, fontWeight: 600 }}>
                              {showDetail.type}
                            </span>
                          </div>
                        </div>
                        <div>
                          <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>STATUT</label>
                          <div style={{ marginTop: 4 }}>
                            <span style={{ background: statut.bg, color: statut.color, padding: '4px 12px', borderRadius: 4, fontWeight: 600 }}>
                              {statut.label}
                            </span>
                          </div>
                        </div>
                      </div>
                      <div>
                        <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>BNFICIAIRE</label>
                        <div style={{ marginTop: 4, fontWeight: 600 }}>{ben?.nom || 'N/A'}</div>
                        {ben?.ncc && <div style={{ fontSize: 12, color: '#6c757d' }}>NCC: {ben.ncc}</div>}
                      </div>
                      <div>
                        <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>OBJET</label>
                        <div style={{ marginTop: 4 }}>{showDetail.objet}</div>
                      </div>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                        <div>
                          <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>LIGNE BUDGTAIRE</label>
                          <div style={{ marginTop: 4 }}><code>{showDetail.ligneBudgetaire}</code></div>
                        </div>
                        <div>
                          <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>MODE RGLEMENT</label>
                          <div style={{ marginTop: 4 }}>{showDetail.modeReglement}</div>
                        </div>
                      </div>
                      
                      {/* Section Budget / Engagements */}
                      <div style={{ background: '#e3f2fd', padding: 16, borderRadius: 8 }}>
                        <label style={{ fontSize: 11, color: '#1565c0', fontWeight: 600, marginBottom: 12, display: 'block' }}> SITUATION BUDGTAIRE (Ligne {showDetail.ligneBudgetaire})</label>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, fontSize: 13 }}>
                          <div>
                            <div style={{ color: '#6c757d', fontSize: 11 }}>Dotation</div>
                            <div style={{ fontWeight: 600, fontFamily: 'monospace' }}>{formatMontant(dotation)}</div>
                          </div>
                          <div>
                            <div style={{ color: '#6c757d', fontSize: 11 }}>Engagements antrieurs</div>
                            <div style={{ fontWeight: 600, fontFamily: 'monospace', color: '#e65100' }}>{formatMontant(engagementsAnterieurs)}</div>
                          </div>
                          <div>
                            <div style={{ color: '#6c757d', fontSize: 11 }}>Disponible avant cet OP</div>
                            <div style={{ fontWeight: 600, fontFamily: 'monospace', color: (dotation - engagementsAnterieurs) >= 0 ? '#2e7d32' : '#c62828' }}>
                              {formatMontant(dotation - engagementsAnterieurs)}
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Montants de l'OP */}
                      <div style={{ background: '#f8f9fa', padding: 16, borderRadius: 8 }}>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16 }}>
                          <div>
                            <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>MONTANT</label>
                            <div style={{ marginTop: 4, fontSize: 18, fontWeight: 700, fontFamily: 'monospace' }}>
                              {formatMontant(showDetail.montant)}
                            </div>
                          </div>
                          <div>
                            <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>PAY</label>
                            <div style={{ marginTop: 4, fontSize: 18, fontWeight: 700, fontFamily: 'monospace', color: '#2e7d32' }}>
                              {formatMontant(showDetail.totalPaye || 0)}
                            </div>
                          </div>
                          <div>
                            <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600 }}>RESTE</label>
                            <div style={{ marginTop: 4, fontSize: 18, fontWeight: 700, fontFamily: 'monospace', color: (showDetail.montant - (showDetail.totalPaye || 0)) > 0 ? '#e65100' : '#2e7d32' }}>
                              {formatMontant(showDetail.montant - (showDetail.totalPaye || 0))}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {/* Dates du circuit */}
                      <div style={{ background: '#fafafa', padding: 16, borderRadius: 8 }}>
                        <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600, marginBottom: 12, display: 'block' }}> SUIVI DU CIRCUIT</label>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16, fontSize: 12 }}>
                          {/* Colonne CF */}
                          <div style={{ background: '#fff3e0', padding: 12, borderRadius: 6 }}>
                            <div style={{ fontWeight: 600, color: '#e65100', marginBottom: 8 }}>Contrleur Financier</div>
                            <div style={{ display: 'grid', gap: 6 }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                <span style={{ color: '#6c757d', fontSize: 10 }}>Transmission</span>
                                <span style={{ fontWeight: 500 }}>{showDetail.dateTransmissionCF || '-'}</span>
                              </div>
                              {showDetail.bordereauCF && (
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#6c757d', fontSize: 10 }}>Bordereau</span>
                                  <span style={{ fontFamily: 'monospace', fontSize: 11 }}>{showDetail.bordereauCF}</span>
                                </div>
                              )}
                              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                <span style={{ color: '#6c757d', fontSize: 10 }}>Visa</span>
                                <span style={{ fontWeight: 500, color: showDetail.dateVisaCF ? '#2e7d32' : '#adb5bd' }}>{showDetail.dateVisaCF || '-'}</span>
                              </div>
                            </div>
                          </div>
                          
                          {/* Colonne AC */}
                          <div style={{ background: '#f3e5f5', padding: 12, borderRadius: 6 }}>
                            <div style={{ fontWeight: 600, color: '#7b1fa2', marginBottom: 8 }}>Agent Comptable</div>
                            <div style={{ display: 'grid', gap: 6 }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                <span style={{ color: '#6c757d', fontSize: 10 }}>Transmission</span>
                                <span style={{ fontWeight: 500 }}>{showDetail.dateTransmissionAC || '-'}</span>
                              </div>
                              {showDetail.bordereauAC && (
                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                  <span style={{ color: '#6c757d', fontSize: 10 }}>Bordereau</span>
                                  <span style={{ fontFamily: 'monospace', fontSize: 11 }}>{showDetail.bordereauAC}</span>
                                </div>
                              )}
                              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                <span style={{ color: '#6c757d', fontSize: 10 }}>Paiement</span>
                                <span style={{ fontWeight: 500, color: showDetail.datePaiement ? '#00695c' : '#adb5bd' }}>{showDetail.datePaiement || '-'}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        {/* Ligne Archivage */}
                        {(showDetail.dateArchivage || showDetail.boiteArchive) && (
                          <div style={{ marginTop: 12, background: '#eceff1', padding: 12, borderRadius: 6 }}>
                            <div style={{ fontWeight: 600, color: '#546e7a', marginBottom: 8 }}> Archivage</div>
                            <div style={{ display: 'flex', gap: 24 }}>
                              <div>
                                <span style={{ color: '#6c757d', fontSize: 10 }}>Date : </span>
                                <span style={{ fontWeight: 500 }}>{showDetail.dateArchivage || '-'}</span>
                              </div>
                              {showDetail.boiteArchive && (
                                <div>
                                  <span style={{ color: '#6c757d', fontSize: 10 }}>Bote : </span>
                                  <span style={{ fontWeight: 600 }}>{showDetail.boiteArchive}</span>
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                      
                      {/* Historique des paiements */}
                      {showDetail.paiements && showDetail.paiements.length > 0 && (
                        <div>
                          <label style={{ fontSize: 11, color: '#6c757d', fontWeight: 600, marginBottom: 8, display: 'block' }}>HISTORIQUE DES PAIEMENTS</label>
                          <table style={{ ...styles.table, fontSize: 12 }}>
                            <thead>
                              <tr>
                                <th style={{ ...styles.th, fontSize: 11 }}>DATE</th>
                                <th style={{ ...styles.th, fontSize: 11 }}>RFRENCE</th>
                                <th style={{ ...styles.th, fontSize: 11, textAlign: 'right' }}>MONTANT</th>
                              </tr>
                            </thead>
                            <tbody>
                              {showDetail.paiements.map((p, i) => (
                                <tr key={i}>
                                  <td style={styles.td}>{p.date}</td>
                                  <td style={{ ...styles.td, fontFamily: 'monospace' }}>{p.reference}</td>
                                  <td style={{ ...styles.td, textAlign: 'right', fontFamily: 'monospace' }}>{formatMontant(p.montant)}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}

                      {/* Motif retour */}
                      {(showDetail.statut === 'RETOURNE_CF' || showDetail.statut === 'RETOURNE_AC') && (
                        <div style={{ background: '#e1f5fe', padding: 16, borderRadius: 8 }}>
                          <label style={{ fontSize: 11, color: '#0277bd', fontWeight: 600 }}> MOTIF DU RETOUR</label>
                          <div style={{ marginTop: 4 }}>{showDetail.motifRetourCF || showDetail.motifRetourAC}</div>
                          <div style={{ fontSize: 12, color: '#6c757d', marginTop: 4 }}>
                            Date: {showDetail.dateRetourCF || showDetail.dateRetourAC}
                          </div>
                        </div>
                      )}

                      {/* Motif diffr */}
                      {(showDetail.statut === 'DIFFERE_CF' || showDetail.statut === 'DIFFERE_AC') && (
                        <div style={{ background: '#fff8e1', padding: 16, borderRadius: 8 }}>
                          <label style={{ fontSize: 11, color: '#f9a825', fontWeight: 600 }}> MOTIF DU DIFFR</label>
                          <div style={{ marginTop: 4 }}>{showDetail.motifDiffereCF || showDetail.motifDiffereAC}</div>
                          <div style={{ fontSize: 12, color: '#6c757d', marginTop: 4 }}>
                            Date: {showDetail.dateDiffereCF || showDetail.dateDiffereAC}
                          </div>
                        </div>
                      )}

                      {/* Motif rejet */}
                      {(showDetail.statut === 'REJETE_CF' || showDetail.statut === 'REJETE_AC') && showDetail.motifRejet && (
                        <div style={{ background: '#ffebee', padding: 16, borderRadius: 8 }}>
                          <label style={{ fontSize: 11, color: '#c62828', fontWeight: 600 }}> MOTIF DU REJET</label>
                          <div style={{ marginTop: 4, color: '#c62828' }}>{showDetail.motifRejet}</div>
                          <div style={{ fontSize: 12, color: '#c62828', marginTop: 4 }}>
                            Date: {showDetail.dateRejet} - Par: {showDetail.rejetePar}
                          </div>
                        </div>
                      )}

                      <div style={{ fontSize: 12, color: '#6c757d' }}>
                        Cr le {showDetail.dateCreation || '-'}
                      </div>
                    </div>
                  );
                })()}
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'space-between' }}>
                <div style={{ display: 'flex', gap: 8 }}>
                  <button 
                    onClick={() => { handleOpenEdit(showDetail); setShowDetail(null); }} 
                    style={{ ...styles.buttonSecondary, background: '#fff8e1', color: '#f57f17' }}
                  >
                     Modifier
                  </button>
                  <button 
                    onClick={() => { handleDeleteWithPassword(showDetail); }} 
                    style={{ ...styles.buttonSecondary, background: '#ffebee', color: '#c62828' }}
                  >
                     Supprimer
                  </button>
                </div>
                <button onClick={() => setShowDetail(null)} style={styles.buttonSecondary}>Fermer</button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Diffrer / Rejeter */}
        {showActionModal && (
          <div style={styles.modal}>
            <div style={styles.modalContent}>
              <div style={{ 
                padding: 24, 
                borderBottom: '1px solid #e9ecef', 
                background: showActionModal.action.includes('REJETER') ? '#ffebee' : '#fff8e1' 
              }}>
                <h2 style={{ margin: 0, fontSize: 18, color: showActionModal.action.includes('REJETER') ? '#c62828' : '#f9a825' }}>
                  {showActionModal.action.includes('REJETER') ? ' Rejeter' : ' Diffrer'} l'OP {showActionModal.op.numero}
                </h2>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Date *</label>
                  <input 
                    type="date" 
                    value={actionForm.date} 
                    onChange={(e) => setActionForm({ ...actionForm, date: e.target.value })}
                    style={styles.input}
                  />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Motif *</label>
                  <textarea 
                    value={actionForm.motif} 
                    onChange={(e) => setActionForm({ ...actionForm, motif: e.target.value })}
                    style={{ ...styles.input, minHeight: 100 }}
                    placeholder={showActionModal.action.includes('REJETER') ? 'Raison du rejet...' : 'Raison du diffr, corrections  apporter...'}
                  />
                </div>
                {showActionModal.action.includes('REJETER') && (
                  <div style={{ marginTop: 16, padding: 12, background: '#fff3e0', borderRadius: 8, fontSize: 13 }}>
                     <strong>Attention :</strong> Le rejet librera le budget engag par cet OP.
                  </div>
                )}
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => { setShowActionModal(null); setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '' }); }} style={styles.buttonSecondary}>Annuler</button>
                <button 
                  onClick={showActionModal.action.includes('REJETER') ? handleRejeterWithPassword : handleDifferer} 
                  style={{ 
                    ...styles.button, 
                    background: showActionModal.action.includes('REJETER') ? '#c62828' : '#f9a825' 
                  }}
                >
                  {showActionModal.action.includes('REJETER') ? ' Confirmer le rejet' : ' Confirmer le diffr'}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Paiement */}
        {showPaiementModal && (
          <div style={styles.modal}>
            <div style={styles.modalContent}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#e0f2f1' }}>
                <h2 style={{ margin: 0, fontSize: 18, color: '#00695c' }}> Enregistrer un paiement</h2>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ background: '#f8f9fa', padding: 16, borderRadius: 8, marginBottom: 20 }}>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, textAlign: 'center' }}>
                    <div>
                      <div style={{ fontSize: 11, color: '#6c757d', marginBottom: 4 }}>Montant OP</div>
                      <div style={{ fontSize: 16, fontWeight: 700, fontFamily: 'monospace' }}>{formatMontant(showPaiementModal.montant)}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 11, color: '#6c757d', marginBottom: 4 }}>Dj pay</div>
                      <div style={{ fontSize: 16, fontWeight: 700, fontFamily: 'monospace', color: '#2e7d32' }}>{formatMontant(showPaiementModal.totalPaye || 0)}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 11, color: '#6c757d', marginBottom: 4 }}>Reste  payer</div>
                      <div style={{ fontSize: 16, fontWeight: 700, fontFamily: 'monospace', color: '#e65100' }}>{formatMontant(showPaiementModal.montant - (showPaiementModal.totalPaye || 0))}</div>
                    </div>
                  </div>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 16 }}>
                  <div>
                    <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Date du paiement *</label>
                    <input 
                      type="date" 
                      value={actionForm.date} 
                      onChange={(e) => setActionForm({ ...actionForm, date: e.target.value })}
                      style={styles.input}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Rfrence *</label>
                    <input 
                      type="text" 
                      value={actionForm.reference} 
                      onChange={(e) => setActionForm({ ...actionForm, reference: e.target.value })}
                      style={styles.input}
                      placeholder="Ex: CHQ-045892, VIR-TRS-7821"
                    />
                  </div>
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Montant pay *</label>
                  <input 
                    type="number" 
                    value={actionForm.montant} 
                    onChange={(e) => setActionForm({ ...actionForm, montant: e.target.value })}
                    style={{ ...styles.input, fontFamily: 'monospace', fontSize: 18, textAlign: 'right' }}
                    placeholder="0"
                  />
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => { setShowPaiementModal(null); setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '', boiteArchive: '', bordereau: '' }); }} style={styles.buttonSecondary}>Annuler</button>
                <button onClick={handlePaiement} style={{ ...styles.button, background: '#00695c' }}>
                   Enregistrer le paiement
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Transmission (CF ou AC) */}
        {showTransmissionModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 450 }}>
              <div style={{ 
                padding: 24, 
                borderBottom: '1px solid #e9ecef', 
                background: showTransmissionModal.destination === 'CF' ? '#fff3e0' : '#f3e5f5' 
              }}>
                <h2 style={{ margin: 0, fontSize: 18, color: showTransmissionModal.destination === 'CF' ? '#e65100' : '#7b1fa2' }}>
                   Transmettre {showTransmissionModal.destination === 'CF' ? 'au CF' : ' l\'AC'}
                </h2>
                <div style={{ fontSize: 12, color: '#6c757d', marginTop: 4 }}>{showTransmissionModal.op.numero}</div>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Date de transmission *</label>
                  <input 
                    type="date" 
                    value={actionForm.date} 
                    onChange={(e) => setActionForm({ ...actionForm, date: e.target.value })}
                    style={styles.input}
                  />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>
                    N Bordereau de transmission {showTransmissionModal.destination}
                  </label>
                  <input 
                    type="text" 
                    value={actionForm.bordereau} 
                    onChange={(e) => setActionForm({ ...actionForm, bordereau: e.target.value })}
                    style={styles.input}
                    placeholder={`Ex: BT-${showTransmissionModal.destination}-2026-001`}
                  />
                  <span style={{ fontSize: 11, color: '#6c757d' }}>Optionnel - rfrence du bordereau de transmission</span>
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => { setShowTransmissionModal(null); setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '', boiteArchive: '', bordereau: '' }); }} style={styles.buttonSecondary}>Annuler</button>
                <button onClick={handleConfirmTransmission} style={{ ...styles.button, background: showTransmissionModal.destination === 'CF' ? '#e65100' : '#7b1fa2' }}>
                   Confirmer la transmission
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Archivage */}
        {showArchiveModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 450 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#eceff1' }}>
                <h2 style={{ margin: 0, fontSize: 18, color: '#546e7a' }}> Archiver l'OP</h2>
                <div style={{ fontSize: 12, color: '#6c757d', marginTop: 4 }}>{showArchiveModal.numero}</div>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Date d'archivage *</label>
                  <input 
                    type="date" 
                    value={actionForm.date} 
                    onChange={(e) => setActionForm({ ...actionForm, date: e.target.value })}
                    style={styles.input}
                  />
                </div>
                <div>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>N Bote / Classeur d'archive</label>
                  <input 
                    type="text" 
                    value={actionForm.boiteArchive} 
                    onChange={(e) => setActionForm({ ...actionForm, boiteArchive: e.target.value })}
                    style={styles.input}
                    placeholder="Ex: BOX-2026-001, Classeur IDA-A3..."
                  />
                  <span style={{ fontSize: 11, color: '#6c757d' }}>Optionnel - pour faciliter la recherche physique</span>
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => { setShowArchiveModal(null); setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '', boiteArchive: '' }); }} style={styles.buttonSecondary}>Annuler</button>
                <button onClick={handleConfirmArchive} style={{ ...styles.button, background: '#546e7a' }}>
                   Confirmer l'archivage
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Changement de statut */}
        {showStatutModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 500 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#e3f2fd' }}>
                <h2 style={{ margin: 0, fontSize: 18, color: '#1565c0' }}> Changer le statut</h2>
                <div style={{ fontSize: 12, color: '#6c757d', marginTop: 4 }}>{showStatutModal.op.numero}</div>
              </div>
              <div style={{ padding: 24 }}>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Nouveau statut *</label>
                  <select
                    value={actionForm.nouveauStatut || ''}
                    onChange={(e) => setActionForm({ ...actionForm, nouveauStatut: e.target.value })}
                    style={styles.input}
                  >
                    <option value="">-- Slectionner --</option>
                    <option value="TRANSMIS_CF"> Transmis CF</option>
                    <option value="DIFFERE_CF"> Diffr CF</option>
                    <option value="VISE_CF"> Vis CF</option>
                    <option value="REJETE_CF"> Rejet CF</option>
                    <option value="TRANSMIS_AC"> Transmis AC</option>
                    <option value="DIFFERE_AC"> Diffr AC</option>
                    <option value="PAYE_PARTIEL"> Pay partiel</option>
                    <option value="PAYE"> Pay</option>
                    <option value="REJETE_AC"> Rejet AC</option>
                    <option value="ARCHIVE"> Archiv</option>
                  </select>
                </div>
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Date *</label>
                  <input
                    type="date"
                    value={actionForm.date}
                    onChange={(e) => setActionForm({ ...actionForm, date: e.target.value })}
                    style={styles.input}
                  />
                </div>
                {['DIFFERE_CF', 'DIFFERE_AC', 'REJETE_CF', 'REJETE_AC'].includes(actionForm.nouveauStatut) && (
                  <div>
                    <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Motif *</label>
                    <textarea
                      value={actionForm.motif}
                      onChange={(e) => setActionForm({ ...actionForm, motif: e.target.value })}
                      style={{ ...styles.input, minHeight: 80 }}
                      placeholder="Raison du diffr ou rejet..."
                    />
                  </div>
                )}
                {['REJETE_CF', 'REJETE_AC'].includes(actionForm.nouveauStatut) && (
                  <div style={{ marginTop: 16, padding: 12, background: '#fff3e0', borderRadius: 8, fontSize: 13 }}>
                     Le rejet librera le budget engag.
                  </div>
                )}
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'flex-end', gap: 12 }}>
                <button onClick={() => { setShowStatutModal(null); setActionForm({ motif: '', date: new Date().toISOString().split('T')[0], reference: '', montant: '', nouveauStatut: '' }); }} style={styles.buttonSecondary}>Annuler</button>
                <button onClick={handleChangeStatut} style={{ ...styles.button, background: '#1565c0' }}>
                   Appliquer
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal Modification OP */}
        {showEditModal && (() => {
          const editBeneficiaire = beneficiaires.find(b => b.id === editForm.beneficiaireId);
          const editRibs = editBeneficiaire?.ribs || (editBeneficiaire?.rib ? [{ numero: editBeneficiaire.rib, banque: '' }] : []);
          const editBudget = budgets.find(b => b.sourceId === showEditModal.sourceId && b.exerciceId === showEditModal.exerciceId);
          const editSource = sources.find(s => s.id === showEditModal.sourceId);
          const editLigne = editBudget?.lignes?.find(l => l.code === editForm.ligneBudgetaire);
          
          // Calculs budgtaires
          const dotation = editLigne?.dotation || 0;
          const engagementsAnterieurs = ops
            .filter(o => 
              o.sourceId === showEditModal.sourceId &&
              o.exerciceId === showEditModal.exerciceId &&
              o.ligneBudgetaire === editForm.ligneBudgetaire &&
              o.id !== showEditModal.id &&
              !['REJETE_CF', 'REJETE_AC'].includes(o.statut)
            )
            .reduce((sum, o) => sum + (o.montant || 0), 0);
          const engagementActuel = parseFloat(editForm.montant) || 0;
          const engagementsCumules = engagementsAnterieurs + engagementActuel;
          const disponible = dotation - engagementsCumules;
          
          // Fonction d'impression - Modle exact PIF2
          const handlePrintOP = () => {
            const exercice = exercices.find(e => e.id === showEditModal.exerciceId);
            const selectedRib = editRibs[editForm.ribIndex || 0] || {};
            const isBailleur = editSource?.sigle?.includes('IDA') || editSource?.sigle?.includes('BAD') || editSource?.sigle?.includes('UE');
            const isTresor = editSource?.sigle?.includes('BN') || editSource?.sigle?.includes('TRESOR') || editSource?.sigle?.includes('ETAT');
            const codeImputationComplet = (editSource?.codeImputation || '') + ' ' + (editForm.ligneBudgetaire || '');
            
            const printContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>OP ${showEditModal.numero}</title>
  <style>
    @page { size: A4; margin: 10mm; }
    @media print {
      .toolbar { display: none !important; }
      body { background: #fff !important; padding: 0 !important; }
      .page-container { box-shadow: none !important; margin: 0 !important; width: 100% !important; }
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Century Gothic', 'Trebuchet MS', sans-serif; 
      font-size: 11px; 
      line-height: 1.4;
      background: #e0e0e0;
      padding: 0;
    }
    .toolbar {
      background: #1a1a2e;
      padding: 12px 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .toolbar button {
      padding: 8px 20px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-print { background: #2196F3; color: #fff; }
    .btn-print:hover { background: #1976D2; }
    .btn-pdf { background: #4CAF50; color: #fff; }
    .btn-pdf:hover { background: #388E3C; }
    .toolbar-title { color: #fff; font-size: 14px; margin-left: auto; }
    .page-container {
      width: 210mm;
      min-height: 297mm;
      margin: 20px auto;
      background: #fff;
      padding: 8mm;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .inner-frame {
      border: 2px solid #000;
      height: 100%;
    }
    .header {
      display: flex;
      border-bottom: 1px solid #000;
    }
    .header-logo {
      width: 22%;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid #000;
    }
    .header-logo img { max-height: 75px; max-width: 100%; }
    .header-center {
      width: 56%;
      padding: 6px;
      text-align: center;
      border-right: 1px solid #000;
    }
    .header-center .republic { font-weight: bold; font-size: 11px; }
    .header-center .sep { font-size: 8px; letter-spacing: 0.5px; color: #333; }
    .header-center .ministry { font-style: italic; font-size: 10px; }
    .header-center .project { font-weight: bold; font-size: 10px; }
    .header-right {
      width: 22%;
      padding: 8px;
      font-size: 10px;
      text-align: right;
    }
    .op-title-section {
      text-align: center;
      padding: 6px 10px;
      border-bottom: 1px solid #000;
    }
    .op-title { font-weight: bold; text-decoration: underline; font-size: 11px; }
    .op-numero { font-size: 10px; margin-top: 2px; }
    .body-content {
      padding: 12px 15px;
      border-bottom: 1px solid #000;
    }
    .exercice-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .type-red { color: #c00; font-weight: bold; }
    .field { margin-bottom: 8px; }
    .field-title { text-decoration: underline; font-size: 10px; margin-bottom: 6px; }
    .field-value { font-weight: bold; }
    .field-large {
      margin: 15px 0;
      min-height: 45px;
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .checkbox-line {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .checkbox-label { min-width: 230px; }
    .checkbox-options { display: flex; gap: 50px; }
    .check-item { display: flex; align-items: center; gap: 6px; }
    .box { 
      width: 18px; 
      height: 14px; 
      border: 1px solid #000; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      font-size: 10px;
    }
    .budget-section { margin-top: 15px; }
    .budget-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .budget-row .col-left { width: 33.33%; }
    .budget-row .col-center { width: 33.33%; }
    .budget-row .col-right { width: 33.33%; }
    .value-box {
      border: 1px solid #000;
      padding: 4px 10px;
      text-align: right;
      font-weight: bold;
      white-space: nowrap;
      font-size: 10px;
    }
    .budget-table {
      width: 100%;
      border-collapse: collapse;
    }
    .budget-table td {
      border: 1px solid #000;
      padding: 4px 8px;
      font-size: 10px;
    }
    .budget-table .col-letter { 
      width: 4%;
      text-align: center; 
      font-weight: bold; 
    }
    .budget-table .col-label { width: 29.33%; }
    .budget-table .col-amount { 
      width: 33.33%;
      text-align: right;
      padding-right: 10px;
    }
    .budget-table .col-empty {
      width: 33.33%;
      border: none;
    }
    .signatures-section {
      display: flex;
      border-bottom: 1px solid #000;
    }
    .sig-box {
      width: 33.33%;
      min-height: 160px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #000;
    }
    .sig-box:last-child { border-right: none; }
    .sig-header {
      text-align: center;
      font-weight: bold;
      font-size: 9px;
      padding: 6px;
      border-bottom: 1px solid #000;
      line-height: 1.3;
    }
    .sig-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 8px;
    }
    .sig-name {
      text-align: right;
      font-weight: bold;
      text-decoration: underline;
      font-size: 9px;
    }
    .abidjan-row {
      display: flex;
      border-bottom: 1px solid #000;
    }
    .abidjan-cell {
      width: 33.33%;
      padding: 4px 10px;
      font-size: 9px;
      border-right: 1px solid #000;
    }
    .abidjan-cell:last-child { border-right: none; }
    .acquit-section { display: flex; }
    .acquit-empty { 
      width: 66.66%;
      border-right: 1px solid #000;
    }
    .acquit-box {
      width: 33.33%;
      min-height: 110px;
      display: flex;
      flex-direction: column;
    }
    .acquit-header {
      text-align: center;
      font-size: 9px;
      padding: 6px;
      border-bottom: 1px solid #000;
    }
    .acquit-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 8px;
    }
    .acquit-date {
      font-size: 9px;
      text-align: left;
    }
    @media print { 
      body { padding: 0; }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button class="btn-print" onclick="window.print()"> Imprimer</button>
    <button class="btn-pdf" onclick="window.print()"> Exporter PDF</button>
    <span class="toolbar-title">Aperu  OP ${showEditModal.numero}</span>
  </div>
  <div class="page-container">
  <div class="inner-frame">
    <div class="header">
      <div class="header-logo">
        <img src="${LOGO_PIF2}" alt="PIF2" />
      </div>
      <div class="header-center">
        <div class="republic">REPUBLIQUE DE CTE D'IVOIRE</div>
        <div class="sep">------------------------</div>
        <div class="ministry">MINISTERE DES EAUX ET FORETS</div>
        <div class="sep">------------------------</div>
        <div class="project">PROJET D'INVESTISSEMENT FORESTIER 2</div>
        <div class="sep">------------------------</div>
      </div>
      <div class="header-right">
        <div style="text-align: center;">
          <img src="${ARMOIRIE}" alt="Armoirie" style="max-height: 50px; max-width: 60px; margin-bottom: 3px;" />
          <div>Union  Discipline  Travail</div>
        </div>
      </div>
    </div>
    
    <div class="op-title-section">
      <div class="op-title">ORDRE DE PAIEMENT</div>
      <div class="op-numero">N${showEditModal.numero}</div>
    </div>
    
    <div class="body-content">
      <div class="exercice-line">
        <div>EXERCICE&nbsp;&nbsp;&nbsp;&nbsp;<strong>${exercice?.annee || ''}</strong></div>
        <div class="type-red">${editForm.type}</div>
      </div>
      
      <div class="field">
        <div class="field-title">REFERENCE DU BENEFICIAIRE</div>
      </div>
      
      <div class="field">
        BENEFICIAIRE :&nbsp;&nbsp;&nbsp;<span class="field-value">${editBeneficiaire?.nom || ''}</span>
      </div>
      
      <div class="field">
        COMPTE CONTRIBUABLE :&nbsp;&nbsp;&nbsp;<span class="field-value">${editBeneficiaire?.ncc || ''}</span>
      </div>
      
      <div class="checkbox-line">
        <span class="checkbox-label">COMPTE DE DISPONIBILITE A DEBITER :</span>
        <div class="checkbox-options">
          <span class="check-item">BAILLEUR <span class="box">${isBailleur ? 'x' : ''}</span></span>
          <span class="check-item">TRESOR <span class="box">${isTresor ? 'x' : ''}</span></span>
        </div>
      </div>
      
      <div class="checkbox-line">
        <span class="checkbox-label">MODE DE REGLEMENT :</span>
        <div class="checkbox-options">
          <span class="check-item">ESPECE <span class="box">${editForm.modeReglement === 'ESPECES' ? 'x' : ''}</span></span>
          <span class="check-item">CHEQUE <span class="box">${editForm.modeReglement === 'CHEQUE' ? 'x' : ''}</span></span>
          <span class="check-item">VIREMENT <span class="box">${editForm.modeReglement === 'VIREMENT' ? 'x' : ''}</span></span>
        </div>
      </div>
      
      <div class="field">
        REFERENCES BANCAIRES :&nbsp;&nbsp;&nbsp;<span class="field-value">${editForm.modeReglement === 'VIREMENT' ? (selectedRib.banque ? selectedRib.banque + ' - ' : '') + (selectedRib.numero || '') : ''}</span>
      </div>
      
      <div class="field-large">
        OBJET DE LA DEPENSE :&nbsp;&nbsp;&nbsp;<span class="field-value">${editForm.objet || ''}</span>
      </div>
      
      <div class="field-large">
        PIECES JUSTIFICATIVES :&nbsp;&nbsp;&nbsp;<span class="field-value">${editForm.piecesJustificatives || ''}</span>
      </div>
      
      <div class="budget-section">
        <div class="budget-row">
          <div class="col-left">MONTANT TOTAL :</div>
          <div class="col-center">
            <div class="value-box">${formatMontant(Math.abs(engagementActuel))}</div>
          </div>
          <div class="col-right"></div>
        </div>
        
        <div class="budget-row">
          <div class="col-left">IMPUTATION BUDGETAIRE :</div>
          <div class="col-center">
            <div class="value-box">${codeImputationComplet.trim()}</div>
          </div>
          <div class="col-right"></div>
        </div>
        
        <table class="budget-table">
          <tr>
            <td class="col-letter">A</td>
            <td class="col-label">Dotation budgtaire</td>
            <td class="col-amount">${formatMontant(dotation)}</td>
            <td class="col-empty"></td>
          </tr>
          <tr>
            <td class="col-letter">B</td>
            <td class="col-label">Engagements antrieurs</td>
            <td class="col-amount">${formatMontant(engagementsAnterieurs)}</td>
            <td class="col-empty"></td>
          </tr>
          <tr>
            <td class="col-letter">C</td>
            <td class="col-label">Engagement actuel</td>
            <td class="col-amount">${formatMontant(Math.abs(engagementActuel))}</td>
            <td class="col-empty"></td>
          </tr>
          <tr>
            <td class="col-letter">D</td>
            <td class="col-label">Engagements cumuls (B + C)</td>
            <td class="col-amount">${formatMontant(engagementsCumules)}</td>
            <td class="col-empty"></td>
          </tr>
          <tr>
            <td class="col-letter">E</td>
            <td class="col-label">Disponible budgtaire (A - D)</td>
            <td class="col-amount">${formatMontant(disponible)}</td>
            <td class="col-empty"></td>
          </tr>
        </table>
      </div>
    </div>
    
    <div class="signatures-section">
      <div class="sig-box">
        <div class="sig-header">VISA<br/>COORDONNATRICE</div>
        <div class="sig-content">
          <div class="sig-name">ABE-KOFFI Thrse</div>
        </div>
      </div>
      <div class="sig-box">
        <div class="sig-header">VISA<br/>CONTRLEUR FINANCIER</div>
        <div class="sig-content"></div>
      </div>
      <div class="sig-box">
        <div class="sig-header">VISA AGENT<br/>COMPTABLE</div>
        <div class="sig-content"></div>
      </div>
    </div>
    
    <div class="abidjan-row">
      <div class="abidjan-cell">Abidjan, le</div>
      <div class="abidjan-cell">Abidjan, le</div>
      <div class="abidjan-cell">Abidjan, le</div>
    </div>
    
    <div class="acquit-section">
      <div class="acquit-empty"></div>
      <div class="acquit-box">
        <div class="acquit-header">ACQUIT LIBERATOIRE</div>
        <div class="acquit-content">
          <div class="acquit-date">Abidjan, le</div>
        </div>
      </div>
    </div>
  </div>
  </div>
</body>
</html>`;
            const printWindow = window.open('', '_blank', 'width=900,height=700');
            printWindow.document.write(printContent);
            printWindow.document.close();
          };
          
          return (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 750 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: editSource?.couleur || '#0f4c3a' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div>
                    <h2 style={{ margin: 0, fontSize: 18, color: 'white' }}> Modifier l'OP</h2>
                    <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.8)', marginTop: 4 }}>{showEditModal.numero}</div>
                  </div>
                  <button 
                    onClick={handlePrintOP}
                    style={{ background: 'rgba(255,255,255,0.2)', color: 'white', border: 'none', borderRadius: 6, padding: '8px 16px', cursor: 'pointer', fontWeight: 600 }}
                  >
                     Imprimer
                  </button>
                </div>
              </div>
              <div style={{ padding: 24, maxHeight: '65vh', overflowY: 'auto' }}>
                
                {/* Type d'OP */}
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 8, color: '#6c757d' }}>TYPE D'OP</label>
                  <div style={{ display: 'flex', gap: 8 }}>
                    {[
                      { value: 'PROVISOIRE', label: 'Provisoire', color: '#ff9800' },
                      { value: 'DIRECT', label: 'Direct', color: '#2196f3' },
                      { value: 'DEFINITIF', label: 'Dfinitif', color: '#4caf50' },
                      { value: 'ANNULATION', label: 'Annulation', color: '#f44336' }
                    ].map(type => (
                      <button
                        key={type.value}
                        type="button"
                        onClick={() => setEditForm({ ...editForm, type: type.value })}
                        style={{
                          padding: '8px 16px',
                          borderRadius: 6,
                          border: 'none',
                          background: editForm.type === type.value ? type.color : '#f0f0f0',
                          color: editForm.type === type.value ? 'white' : '#555',
                          fontWeight: 600,
                          fontSize: 12,
                          cursor: 'pointer'
                        }}
                      >
                        {type.label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Bnficiaire */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 150px', gap: 16, marginBottom: 16 }}>
                  <div>
                    <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>BNFICIAIRE</label>
                    <Select
                      options={beneficiaires.map(b => ({ value: b.id, label: b.nom }))}
                      value={editForm.beneficiaireId ? { value: editForm.beneficiaireId, label: editBeneficiaire?.nom || '' } : null}
                      onChange={(option) => setEditForm({ ...editForm, beneficiaireId: option?.value || '', ribIndex: 0 })}
                      placeholder=" Rechercher un bnficiaire..."
                      isClearable
                      styles={{
                        control: (base) => ({ ...base, minHeight: 44, borderRadius: 8 }),
                        menu: (base) => ({ ...base, zIndex: 9999 })
                      }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>NCC</label>
                    <input 
                      type="text" 
                      value={editBeneficiaire?.ncc || ''} 
                      readOnly 
                      style={{ ...styles.input, marginBottom: 0, background: '#f8f9fa', padding: '10px 12px' }} 
                    />
                  </div>
                </div>

                {/* Mode de rglement */}
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 8, color: '#6c757d' }}>MODE DE RGLEMENT</label>
                  <div style={{ display: 'flex', gap: 24 }}>
                    {['ESPECES', 'CHEQUE', 'VIREMENT'].map(mode => (
                      <label key={mode} style={{ display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer' }}>
                        <input 
                          type="radio" 
                          checked={editForm.modeReglement === mode}
                          onChange={() => setEditForm({ ...editForm, modeReglement: mode })}
                          style={{ width: 16, height: 16 }}
                        />
                        <span style={{ fontSize: 13 }}>{mode}</span>
                      </label>
                    ))}
                  </div>
                </div>

                {/* RIB si virement */}
                {editForm.modeReglement === 'VIREMENT' && (
                  <div style={{ marginBottom: 16 }}>
                    <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>RIB</label>
                    {!editBeneficiaire ? (
                      <div style={{ ...styles.input, marginBottom: 0, background: '#f8f9fa', color: '#adb5bd', fontStyle: 'italic' }}>
                        Slectionnez un bnficiaire
                      </div>
                    ) : editRibs.length === 0 ? (
                      <div style={{ ...styles.input, marginBottom: 0, background: '#fff3e0', color: '#e65100' }}>
                         Aucun RIB enregistr
                      </div>
                    ) : editRibs.length === 1 ? (
                      <div style={{ ...styles.input, marginBottom: 0, background: '#f8f9fa', fontFamily: 'monospace' }}>
                        {editRibs[0].banque && <span style={{ background: '#e3f2fd', color: '#1565c0', padding: '2px 8px', borderRadius: 4, marginRight: 8, fontSize: 11 }}>{editRibs[0].banque}</span>}
                        {editRibs[0].numero}
                      </div>
                    ) : (
                      <select
                        value={editForm.ribIndex || 0}
                        onChange={(e) => setEditForm({ ...editForm, ribIndex: parseInt(e.target.value) })}
                        style={{ ...styles.input, marginBottom: 0 }}
                      >
                        {editRibs.map((rib, i) => (
                          <option key={i} value={i}>{rib.banque ? `${rib.banque} - ` : ''}{rib.numero}</option>
                        ))}
                      </select>
                    )}
                  </div>
                )}

                {/* Objet */}
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>OBJET DE LA DPENSE</label>
                  <textarea
                    value={editForm.objet || ''}
                    onChange={(e) => setEditForm({ ...editForm, objet: e.target.value })}
                    style={{ ...styles.input, minHeight: 70, marginBottom: 0 }}
                  />
                </div>

                {/* Pices justificatives */}
                <div style={{ marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>PICES JUSTIFICATIVES</label>
                  <textarea
                    value={editForm.piecesJustificatives || ''}
                    onChange={(e) => setEditForm({ ...editForm, piecesJustificatives: e.target.value })}
                    style={{ ...styles.input, minHeight: 50, marginBottom: 0 }}
                  />
                </div>

                {/* Montant et Ligne budgtaire */}
                <div style={{ display: 'grid', gridTemplateColumns: '200px 1fr', gap: 16, marginBottom: 16 }}>
                  <div>
                    <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>MONTANT (FCFA) </label>
                    <input
                      type="number"
                      value={editForm.montant || ''}
                      onChange={(e) => setEditForm({ ...editForm, montant: e.target.value })}
                      style={{ ...styles.input, fontFamily: 'monospace', textAlign: 'right', marginBottom: 0, fontSize: 16, fontWeight: 600 }}
                    />
                    <span style={{ fontSize: 10, color: '#f57f17' }}> Protg par mot de passe</span>
                  </div>
                  <div>
                    <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>LIGNE BUDGTAIRE</label>
                    <Select
                      options={(editBudget?.lignes || []).map(l => ({ value: l.code, label: `${l.code} - ${l.libelle}` }))}
                      value={editForm.ligneBudgetaire ? { value: editForm.ligneBudgetaire, label: `${editForm.ligneBudgetaire}${editLigne ? ' - ' + editLigne.libelle : ''}` } : null}
                      onChange={(option) => setEditForm({ ...editForm, ligneBudgetaire: option?.value || '' })}
                      placeholder=" Rechercher une ligne..."
                      isClearable
                      styles={{
                        control: (base) => ({ ...base, minHeight: 44, borderRadius: 8 }),
                        menu: (base) => ({ ...base, zIndex: 9999 })
                      }}
                    />
                  </div>
                </div>

                {/* Infos budgtaires */}
                {editForm.ligneBudgetaire && (
                  <div style={{ background: '#f8f9fa', padding: 16, borderRadius: 8, marginBottom: 16 }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 150px', gap: 8 }}>
                      <span style={{ fontSize: 12, color: '#6c757d' }}>Dotation budgtaire</span>
                      <span style={{ fontSize: 13, fontFamily: 'monospace', textAlign: 'right', fontWeight: 500 }}>{formatMontant(dotation)}</span>
                      
                      <span style={{ fontSize: 12, color: '#6c757d' }}>Engagements antrieurs</span>
                      <span style={{ fontSize: 13, fontFamily: 'monospace', textAlign: 'right', fontWeight: 500 }}>{formatMontant(engagementsAnterieurs)}</span>
                      
                      <span style={{ fontSize: 12, color: '#6c757d' }}>Engagement actuel</span>
                      <span style={{ fontSize: 13, fontFamily: 'monospace', textAlign: 'right', fontWeight: 600, color: '#e65100' }}>+{formatMontant(engagementActuel)}</span>
                      
                      <span style={{ fontSize: 12, color: '#6c757d' }}>Engagements cumuls</span>
                      <span style={{ fontSize: 13, fontFamily: 'monospace', textAlign: 'right', fontWeight: 500 }}>{formatMontant(engagementsCumules)}</span>
                      
                      <span style={{ fontSize: 12, fontWeight: 600, color: '#333' }}>Disponible budgtaire</span>
                      <span style={{ 
                        fontSize: 14, 
                        fontFamily: 'monospace', 
                        textAlign: 'right', 
                        fontWeight: 700,
                        color: disponible >= 0 ? '#2e7d32' : '#c62828'
                      }}>
                        {formatMontant(disponible)}
                      </span>
                    </div>
                    {disponible < 0 && editForm.type !== 'ANNULATION' && (
                      <div style={{ marginTop: 12, padding: 8, background: '#ffebee', borderRadius: 4, color: '#c62828', fontSize: 12, fontWeight: 600 }}>
                         Budget insuffisant
                      </div>
                    )}
                  </div>
                )}

                {/* Date et TVA */}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                  <div>
                    <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>DATE DE CRATION</label>
                    <input
                      type="date"
                      value={editForm.dateCreation || ''}
                      onChange={(e) => setEditForm({ ...editForm, dateCreation: e.target.value })}
                      style={{ ...styles.input, marginBottom: 0 }}
                    />
                  </div>
                  {['DIRECT', 'DEFINITIF'].includes(editForm.type) && (
                    <div>
                      <label style={{ display: 'block', fontSize: 11, fontWeight: 600, marginBottom: 6, color: '#6c757d' }}>TVA RCUPRABLE</label>
                      <div style={{ display: 'flex', gap: 16, alignItems: 'center', height: 44 }}>
                        <label style={{ display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer' }}>
                          <input type="radio" checked={editForm.tvaRecuperable === true} onChange={() => setEditForm({ ...editForm, tvaRecuperable: true })} />
                          <span>OUI</span>
                        </label>
                        <label style={{ display: 'flex', alignItems: 'center', gap: 6, cursor: 'pointer' }}>
                          <input type="radio" checked={editForm.tvaRecuperable === false || !editForm.tvaRecuperable} onChange={() => setEditForm({ ...editForm, tvaRecuperable: false })} />
                          <span>NON</span>
                        </label>
                        {editForm.tvaRecuperable && (
                          <input
                            type="number"
                            value={editForm.montantTVA || ''}
                            onChange={(e) => setEditForm({ ...editForm, montantTVA: e.target.value })}
                            style={{ ...styles.input, marginBottom: 0, width: 120, fontFamily: 'monospace', textAlign: 'right' }}
                            placeholder="Montant TVA"
                          />
                        )}
                      </div>
                    </div>
                  )}
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'space-between' }}>
                <button 
                  onClick={() => { handleDeleteWithPassword(showEditModal); }} 
                  style={{ ...styles.buttonSecondary, background: '#ffebee', color: '#c62828' }}
                >
                   Supprimer
                </button>
                <div style={{ display: 'flex', gap: 12 }}>
                  <button onClick={() => { setShowEditModal(null); setEditForm({}); }} style={styles.buttonSecondary}>Annuler</button>
                  <button onClick={handleSaveEdit} style={{ ...styles.button, background: editSource?.couleur || '#0f4c3a' }}>
                     Enregistrer
                  </button>
                </div>
              </div>
            </div>
          </div>
          );
        })()}

        {/* Modal Gestion du Circuit */}
        {showCircuitModal && (
          <div style={styles.modal}>
            <div style={{ ...styles.modalContent, maxWidth: 750 }}>
              <div style={{ padding: 24, borderBottom: '1px solid #e9ecef', background: '#e3f2fd' }}>
                <h2 style={{ margin: 0, fontSize: 18, color: '#1565c0' }}> Grer le circuit</h2>
                <div style={{ fontSize: 12, color: '#6c757d', marginTop: 4 }}>{showCircuitModal.numero}  {showCircuitModal.objet?.substring(0, 50)}...</div>
              </div>
              <div style={{ padding: 24, maxHeight: '70vh', overflowY: 'auto' }}>
                {/* Statut actuel */}
                <div style={{ marginBottom: 20 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6 }}>Statut actuel</label>
                  <select
                    value={circuitForm.statut || ''}
                    onChange={(e) => setCircuitForm({ ...circuitForm, statut: e.target.value })}
                    style={{ ...styles.input, fontWeight: 600, fontSize: 14 }}
                  >
                    <option value="CREE"> Cr</option>
                    <option value="TRANSMIS_CF"> Transmis CF</option>
                    <option value="DIFFERE_CF"> Diffr CF</option>
                    <option value="VISE_CF"> Vis CF</option>
                    <option value="REJETE_CF"> Rejet CF</option>
                    <option value="TRANSMIS_AC"> Transmis AC</option>
                    <option value="DIFFERE_AC"> Diffr AC</option>
                    <option value="PAYE_PARTIEL"> Pay partiel</option>
                    <option value="PAYE"> Pay</option>
                    <option value="REJETE_AC"> Rejet AC</option>
                    <option value="ARCHIVE"> Archiv</option>
                  </select>
                </div>

                {/* Section CF - Transmission et Visa */}
                <div style={{ background: '#fff8e1', padding: 16, borderRadius: 8, marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 12, color: '#f57f17' }}> CONTRLEUR FINANCIER (CF)</label>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 12 }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Date transmission CF</label>
                      <input
                        type="date"
                        value={circuitForm.dateTransmissionCF || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, dateTransmissionCF: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>N Bordereau transmission CF</label>
                      <input
                        type="text"
                        value={circuitForm.bordereauCF || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, bordereauCF: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                        placeholder="BT-CF-2026-001"
                      />
                    </div>
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Date visa CF</label>
                      <input
                        type="date"
                        value={circuitForm.dateVisaCF || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, dateVisaCF: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>N Visa CF</label>
                      <input
                        type="text"
                        value={circuitForm.numeroVisaCF || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, numeroVisaCF: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                        placeholder="VISA-CF-2026-001"
                      />
                    </div>
                  </div>
                </div>

                {/* Section Diffr CF - Toujours visible pour correction */}
                <div style={{ background: circuitForm.dateDiffereCF || circuitForm.motifDiffereCF ? '#fff3e0' : '#fafafa', padding: 16, borderRadius: 8, marginBottom: 16, border: circuitForm.dateDiffereCF || circuitForm.motifDiffereCF ? '2px solid #ff9800' : '1px dashed #ddd' }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 12, color: circuitForm.dateDiffereCF || circuitForm.motifDiffereCF ? '#e65100' : '#999' }}>
                     DIFFR CF {circuitForm.dateDiffereCF || circuitForm.motifDiffereCF ? '(renseign)' : '(optionnel)'}
                  </label>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: 12 }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Date diffr</label>
                      <input
                        type="date"
                        value={circuitForm.dateDiffereCF || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, dateDiffereCF: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Motif du diffr</label>
                      <input
                        type="text"
                        value={circuitForm.motifDiffereCF || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, motifDiffereCF: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                        placeholder="Pices manquantes, erreur de calcul..."
                      />
                    </div>
                  </div>
                </div>

                {/* Section AC - Transmission et Paiement */}
                <div style={{ background: '#e8f5e9', padding: 16, borderRadius: 8, marginBottom: 16 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 12, color: '#2e7d32' }}> AGENT COMPTABLE (AC)</label>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 12 }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Date transmission AC</label>
                      <input
                        type="date"
                        value={circuitForm.dateTransmissionAC || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, dateTransmissionAC: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>N Bordereau transmission AC</label>
                      <input
                        type="text"
                        value={circuitForm.bordereauAC || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, bordereauAC: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                        placeholder="BT-AC-2026-001"
                      />
                    </div>
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Date paiement</label>
                      <input
                        type="date"
                        value={circuitForm.datePaiement || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, datePaiement: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Rfrence paiement</label>
                      <input
                        type="text"
                        value={circuitForm.referencePaiement || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, referencePaiement: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                        placeholder="VIR-2026-001"
                      />
                    </div>
                  </div>
                </div>

                {/* Section Diffr AC - Toujours visible pour correction */}
                <div style={{ background: circuitForm.dateDiffereAC || circuitForm.motifDiffereAC ? '#fff3e0' : '#fafafa', padding: 16, borderRadius: 8, marginBottom: 16, border: circuitForm.dateDiffereAC || circuitForm.motifDiffereAC ? '2px solid #ff9800' : '1px dashed #ddd' }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 12, color: circuitForm.dateDiffereAC || circuitForm.motifDiffereAC ? '#e65100' : '#999' }}>
                     DIFFR AC {circuitForm.dateDiffereAC || circuitForm.motifDiffereAC ? '(renseign)' : '(optionnel)'}
                  </label>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: 12 }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Date diffr</label>
                      <input
                        type="date"
                        value={circuitForm.dateDiffereAC || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, dateDiffereAC: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Motif du diffr</label>
                      <input
                        type="text"
                        value={circuitForm.motifDiffereAC || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, motifDiffereAC: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                        placeholder="RIB incorrect, montant erron..."
                      />
                    </div>
                  </div>
                </div>

                {/* Section Rejet - Toujours visible pour correction */}
                <div style={{ background: circuitForm.dateRejet || circuitForm.motifRejet ? '#ffebee' : '#fafafa', padding: 16, borderRadius: 8, marginBottom: 16, border: circuitForm.dateRejet || circuitForm.motifRejet ? '2px solid #f44336' : '1px dashed #ddd' }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 12, color: circuitForm.dateRejet || circuitForm.motifRejet ? '#c62828' : '#999' }}>
                     REJET {circuitForm.dateRejet || circuitForm.motifRejet ? '(renseign)' : '(optionnel)'}
                  </label>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 2fr', gap: 12 }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Date rejet</label>
                      <input
                        type="date"
                        value={circuitForm.dateRejet || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, dateRejet: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Rejet par</label>
                      <select
                        value={circuitForm.rejetePar || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, rejetePar: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                      >
                        <option value="">--</option>
                        <option value="CF">CF</option>
                        <option value="AC">AC</option>
                      </select>
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Motif du rejet</label>
                      <input
                        type="text"
                        value={circuitForm.motifRejet || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, motifRejet: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                        placeholder="Dpense non ligible..."
                      />
                    </div>
                  </div>
                  {(circuitForm.dateRejet || circuitForm.motifRejet) && (
                    <div style={{ marginTop: 12, padding: 10, background: '#fff', borderRadius: 4, fontSize: 12, color: '#c62828' }}>
                       Le rejet libre le budget engag. Pour annuler le rejet, videz les champs ci-dessus.
                    </div>
                  )}
                </div>

                {/* Section Archive */}
                <div style={{ background: '#eceff1', padding: 16, borderRadius: 8 }}>
                  <label style={{ display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 12, color: '#546e7a' }}> ARCHIVAGE</label>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: 12 }}>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>Date archivage</label>
                      <input
                        type="date"
                        value={circuitForm.dateArchivage || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, dateArchivage: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                      />
                    </div>
                    <div>
                      <label style={{ display: 'block', fontSize: 10, color: '#6c757d', marginBottom: 4 }}>N Bote / Classeur d'archive</label>
                      <input
                        type="text"
                        value={circuitForm.boiteArchive || ''}
                        onChange={(e) => setCircuitForm({ ...circuitForm, boiteArchive: e.target.value })}
                        style={{ ...styles.input, padding: '6px 8px', fontSize: 12 }}
                        placeholder="BOX-IDA-2026-001"
                      />
                    </div>
                  </div>
                </div>
              </div>
              <div style={{ padding: 24, borderTop: '1px solid #e9ecef', background: '#f8f9fa', display: 'flex', justifyContent: 'space-between' }}>
                <button 
                  onClick={() => { setShowPaiementModal(showCircuitModal); setShowCircuitModal(null); setActionForm({ ...actionForm, montant: String(showCircuitModal.montant - (showCircuitModal.totalPaye || 0)) }); }} 
                  style={{ ...styles.buttonSecondary, background: '#e0f2f1', color: '#00695c' }}
                >
                   Ajouter paiement
                </button>
                <div style={{ display: 'flex', gap: 12 }}>
                  <button onClick={() => { setShowCircuitModal(null); setCircuitForm({}); }} style={styles.buttonSecondary}>Annuler</button>
                  <button onClick={handleSaveCircuit} style={{ ...styles.button, background: '#1565c0' }}>
                     Enregistrer
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal Mot de passe */}
        {showPasswordModal && (
          <PasswordModal
            isOpen={!!showPasswordModal}
            onClose={() => setShowPasswordModal(null)}
            onConfirm={showPasswordModal.action}
            adminPassword={projet?.adminPassword || ''}
            title={showPasswordModal.title}
            description={showPasswordModal.description}
            warningMessage={showPasswordModal.warningMessage}
            impactDetails={showPasswordModal.impactDetails}
            confirmText={showPasswordModal.confirmText}
            confirmColor={showPasswordModal.confirmColor}
          />
        )}
      </div>
    );
  };

  // ==================== PAGES EN CONSTRUCTION ====================
  const PageEnConstruction = ({ title, icon }) => (
    <div>
      <h1 style={{ fontSize: 24, fontWeight: 700, marginBottom: 24 }}>{icon} {title}</h1>
      <SourceTabs activeSource={sources[0]?.id} onChangeSource={() => {}} />
      <div style={{ ...styles.card, textAlign: 'center', padding: 60 }}>
        <div style={{ fontSize: 60, marginBottom: 20 }}></div>
        <h2 style={{ color: '#6c757d' }}>Module en cours de dveloppement</h2>
        <p style={{ color: '#adb5bd' }}>Cette fonctionnalit sera disponible prochainement</p>
      </div>
    </div>
  );

  // ==================== MAIN RENDER ====================
  if (loading) {
    return (
      <div style={styles.container}>
        <Sidebar />
        <main style={styles.main}>
          <div style={{ textAlign: 'center', padding: 60 }}>
            <div style={{ fontSize: 40, marginBottom: 20 }}></div>
            <p>Chargement des donnes...</p>
          </div>
        </main>
      </div>
    );
  }

  return (
    <div style={styles.container}>
      {/* Style global pour cacher les spinners des inputs numriques */}
      <style>{`
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        input[type="number"] {
          -moz-appearance: textfield;
        }
      `}</style>
      <Sidebar />
      <main style={styles.main}>
        {currentPage === 'dashboard' && <PageDashboard />}
        {currentPage === 'parametres' && <PageParametres />}
        {currentPage === 'beneficiaires' && <PageBeneficiaires />}
        {currentPage === 'budget' && <PageBudget />}
        {currentPage === 'historique' && <PageHistoriqueBudget />}
        {currentPage === 'ops' && <PageListeOP />}
        {currentPage === 'nouvelOp' && <PageNouvelOp consultOpData={consultOpData} setConsultOpData={setConsultOpData} />}
        {currentPage === 'bordereaux' && <PageBordereaux />}
        {currentPage === 'suivi' && <PageEnConstruction title="Suivi Circuit" icon="" />}
      </main>
    </div>
  );
}
